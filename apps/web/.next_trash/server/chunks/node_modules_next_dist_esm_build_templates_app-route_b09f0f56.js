module.exports=[691272,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),o=e.i(561916),n=e.i(174677),s=e.i(869741),d=e.i(316795),l=e.i(487718),u=e.i(995169),c=e.i(47587),h=e.i(666012),p=e.i(570101),_=e.i(626937),m=e.i(10372),v=e.i(193695);e.i(52474);var f=e.i(600220),g=e.i(469719),w=e.i(300959),E=e.i(843793),y=e.i(184883),R=e.i(977775),b=e.i(720290),x=e.i(273278);let A=g.z.object({action_id:g.z.string().uuid(),client_seed:g.z.string().min(8).max(256)});async function T(e){let t,r=(0,R.getActingUserId)(e),a=(0,R.requireActingUserIdInProd)(r);if(a)return(0,w.apiError)(a);if(!r)return(0,w.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=A.parse(i)}catch(e){return(0,w.apiZodError)(e)??(0,w.apiError)("invalid_input")}let o=String(t.action_id).trim(),n=String(t.client_seed).trim(),s=(0,E.getSql)();try{let e=await (0,y.retryOnceOnTransientDbError)(async()=>await s.begin(async e=>{let t=await e`
          SELECT id::text AS id, user_id::text AS user_id, module, profile, status,
                 client_commit_hash, server_commit_hash, server_seed_b64, resolves_at, input_json, outcome_json
          FROM arcade_action
          WHERE id = ${o}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(0===t.length)return{kind:"err",err:(0,w.apiError)("not_found")};let a=t[0];if(a.user_id!==r)return{kind:"err",err:(0,w.apiError)("x_user_id_mismatch")};if("time_vault"!==a.module)return{kind:"err",err:(0,w.apiError)("invalid_input",{details:"not_time_vault"})};if("resolved"===a.status)return{kind:"ok",alreadyResolved:!0,outcome:a.outcome_json};let i=!!a.resolves_at&&new Date(a.resolves_at).getTime()<=Date.now();if("ready"!==a.status&&!("scheduled"===a.status&&i))return{kind:"err",err:(0,w.apiError)("trade_state_conflict",{details:{status:a.status,resolves_at:a.resolves_at}})};"scheduled"===a.status&&i&&(await e`
            UPDATE arcade_action
            SET status = 'ready'
            WHERE id = ${o}::uuid AND status = 'scheduled'
          `,a.status="ready");let s=(0,b.sha256Hex)(n);if(!(0,b.isSha256Hex)(s)||s!==String(a.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,w.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,b.sha256Hex)(`${a.server_seed_b64}:${a.client_commit_hash}:${a.module}:${a.profile}:${r}`)!==String(a.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,w.apiError)("internal_error",{details:"server_commit_mismatch"})};let d=String(a.input_json?.asset_id??"").trim(),l=String(a.input_json?.amount??"").trim(),u=Number(a.input_json?.duration_hours??0);if(!d||!l||!Number.isFinite(u)||u<24)return{kind:"err",err:(0,w.apiError)("internal_error",{details:"invalid_action_input"})};let c=function(e){var t;let r,a,i,o=(t=e.profile,r=[{weight:0,value:{kind:"boost",code:"fee_10bps_48h",rarity:"rare",label:"Fee -10 bps (48h)",metadata:{duration_hours:48,effect:{type:"fee_discount_bps",value:10}}}},{weight:0,value:{kind:"boost",code:"p2p_highlight_3",rarity:"rare",label:"P2P Highlight (3)",metadata:{duration_hours:168,effect:{type:"p2p_highlight_credits",value:3}}}}],a=[{weight:0,value:{kind:"boost",code:"fee_15bps_72h",rarity:"epic",label:"Fee -15 bps (72h)",metadata:{duration_hours:72,effect:{type:"fee_discount_bps",value:15}}}},{weight:0,value:{kind:"boost",code:"withdraw_priority_72h",rarity:"epic",label:"Withdrawal priority (72h)",metadata:{duration_hours:72,effect:{type:"withdrawal_priority_hours",value:72}}}}],i=[{weight:0,value:{kind:"boost",code:"fee_25bps_7d",rarity:"legendary",label:"Fee -25 bps (7d)",metadata:{duration_hours:168,effect:{type:"fee_discount_bps",value:25}}}}],"high"===t?(r[0].weight=80,r[1].weight=70,a[0].weight=35,a[1].weight=25,i[0].weight=10):"medium"===t?(r[0].weight=55,r[1].weight=45,a[0].weight=18,a[1].weight=12,i[0].weight=3):(r[0].weight=30,r[1].weight=25,a[0].weight=7,a[1].weight=5,i[0].weight=1),[{weight:520,value:{kind:"boost",code:"fee_5bps_24h",rarity:"common",label:"Fee -5 bps (24h)",metadata:{duration_hours:24,effect:{type:"fee_discount_bps",value:5}}}},{weight:320,value:{kind:"boost",code:"p2p_highlight_1",rarity:"common",label:"P2P Highlight (1)",metadata:{duration_hours:72,effect:{type:"p2p_highlight_credits",value:1}}}},{weight:160,value:{kind:"boost",code:"withdraw_priority_12h",rarity:"common",label:"Withdrawal priority (12h)",metadata:{duration_hours:12,effect:{type:"withdrawal_priority_hours",value:12}}}},...r,...a,...i].filter(e=>e.weight>0)),n=(0,b.sha256Hex)(`${e.serverSeedB64}:${e.clientSeed}:${e.actionId}:${e.userId}:${e.module}:${e.profile}:${e.clientCommitHash}:${e.assetId}:${e.amount}:${e.durationHours}`),{picked:s,roll:d,total:l}=function(e,t){let r=t.reduce((e,t)=>e+t.weight,0),a=Number(e%BigInt(r)),i=0;for(let e of t)if(a<(i+=e.weight))return{picked:e.value,roll:a,total:r};return{picked:t[t.length-1].value,roll:a,total:r}}((0,b.bytesToU64BigInt)(Buffer.from(n.slice(0,16),"hex")),o);return{outcome:s,audit:{random_hash:n,roll:d,total:l}}}({actionId:a.id,userId:r,module:a.module,profile:a.profile,serverSeedB64:a.server_seed_b64,clientSeed:n,clientCommitHash:a.client_commit_hash,assetId:d,amount:l,durationHours:u}),h={module:a.module,profile:a.profile,vault:{asset_id:d,amount:l,duration_hours:u},outcome:c.outcome,audit:{client_commit_hash:a.client_commit_hash,server_commit_hash:a.server_commit_hash,server_seed_b64:a.server_seed_b64,random_hash:c.audit.random_hash,roll:c.audit.roll,total:c.audit.total}},p=`arcade_vault:${o}`,_=await e`
          SELECT h.id::text AS id
          FROM ex_hold h
          JOIN ex_ledger_account a ON a.id = h.account_id
          WHERE h.reason = ${p}
            AND a.user_id = ${r}::uuid
          LIMIT 1
          FOR UPDATE
        `;return 0===_.length?{kind:"err",err:(0,w.apiError)("internal_error",{details:"hold_not_found"})}:(await e`
          UPDATE ex_hold
          SET status = 'released', released_at = now()
          WHERE id = ${_[0].id}::uuid AND status = 'active'
        `,await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${r}::uuid,
            ${c.outcome.kind},
            ${c.outcome.code},
            ${c.outcome.rarity},
            1,
            ${e.json({label:c.outcome.label,...c.outcome.metadata,source:a.module,action_id:o})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `,await (0,x.addArcadeXp)(e,{userId:r,deltaXp:2,contextRandomHash:c.audit.random_hash,source:"time_vault"}),await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(h)}
          WHERE id = ${o}::uuid
        `,{kind:"ok",alreadyResolved:!1,outcome:h})}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:o,already_resolved:e.alreadyResolved,result:e.outcome},{status:200})}catch(t){let e=(0,y.responseForDbError)("arcade_vault_reveal",t);if(e)return e;return(0,w.apiError)("internal_error")}}e.s(["POST",()=>T,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],368541);var C=e.i(368541);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/vaults/reveal/route",pathname:"/api/arcade/vaults/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/vaults/reveal/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:k,workUnitAsyncStorage:$,serverHooks:N}=S;function P(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:$})}async function I(e,t,a){S.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/arcade/vaults/reveal/route";g=g.replace(/\/index$/,"")||"/";let w=await S.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:y,nextConfig:R,parsedUrl:b,isDraftMode:x,prerenderManifest:A,routerServerContext:T,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,resolvedPathname:$,clientReferenceManifest:N,serverActionsManifest:P}=w,I=(0,s.normalizeAppPath)(g),O=!!(A.dynamicRoutes[I]||A.routes[$]),H=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,b,!1):t.end("This page could not be found"),null);if(O&&!x){let e=!!A.routes[$],t=A.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await H();throw new v.NoFallbackError}}let D=null;!O||S.isDev||x||(D="/index"===(D=$)?"/":D);let U=!0===S.isDev||!O,j=O&&!U;P&&N&&(0,n.setManifestsSingleton)({page:g,clientReferenceManifest:N,serverActionsManifest:P});let q=e.method||"GET",F=(0,o.getTracer)(),M=F.getActiveScopeSpan(),L={params:y,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>S.onRequestError(e,t,a,i,T)},sharedContext:{buildId:E}},B=new d.NodeNextRequest(e),W=new d.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let n=async e=>S.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${g}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&C&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=L.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(B,W,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[m.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,T),t}},u=await S.handleResponse({req:e,nextConfig:R,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!O)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&O||v.delete(m.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,_.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,W,new Response(u.value.body,{headers:v,status:u.value.status||200})),null};M?await d(M):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${g}`,kind:o.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,T),O)throw t;return await (0,h.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>P,"routeModule",()=>S,"serverHooks",()=>N,"workAsyncStorage",()=>k,"workUnitAsyncStorage",()=>$],691272)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_b09f0f56.js.map