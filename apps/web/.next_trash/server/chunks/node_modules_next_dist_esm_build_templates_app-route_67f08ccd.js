module.exports=[394380,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(174677),o=e.i(869741),u=e.i(316795),l=e.i(487718),d=e.i(995169),p=e.i(47587),c=e.i(666012),_=e.i(570101),E=e.i(626937),h=e.i(10372),w=e.i(193695);e.i(52474);var m=e.i(600220),R=e.i(89171),g=e.i(843793),f=e.i(184883),x=e.i(358217),y=e.i(24672),S=e.i(194748),A=e.i(630862),v=e.i(939249),T=e.i(437274);async function N(e){let t,a=function(e){let t=process.env.EXCHANGE_CRON_SECRET??process.env.CRON_SECRET;if(!t)return"cron_secret_not_configured";let a=e.headers.get("x-cron-secret")??e.nextUrl.searchParams.get("secret");return a&&a===t?null:"cron_unauthorized"}(e);if(a)return R.NextResponse.json({error:a},{status:"cron_unauthorized"===a?401:500});let r="1"!==(t=String(process.env.EXCHANGE_ENABLE_TWAP??"").trim())&&"true"!==t.toLowerCase()?"twap_disabled":null;if(r)return R.NextResponse.json({ok:!1,error:r},{status:403});let n=String(process.env.INTERNAL_SERVICE_SECRET??"").trim();if(!n)return R.NextResponse.json({ok:!1,error:"internal_service_secret_not_configured"},{status:500});let i=(0,g.getSql)(),s=Math.max(1,Math.min(200,Number(new URL(e.url).searchParams.get("max")??"50")||50)),o="exchange:twap",u=`${process.env.RAILWAY_SERVICE_NAME??process.env.SERVICE_NAME??"web"}:${crypto.randomUUID()}`,l=await (0,x.tryAcquireJobLock)(i,{key:o,holderId:u,ttlMs:12e4});if(!l.acquired)return R.NextResponse.json({ok:!1,error:"job_in_progress",held_until:l.held_until,holder_id:l.holder_id},{status:429});let d=0,p=0,c=0,_=0;try{for(let e of(await (0,f.retryOnceOnTransientDbError)(async()=>await i`
        SELECT id::text AS id
        FROM app_twap_plan
        WHERE status = 'active'
          AND next_run_at <= now()
          AND remaining_quantity > 0
        ORDER BY next_run_at ASC
        LIMIT ${s}
      `))){d+=1;try{let t=await i.begin(async t=>{let a=await t`
            SELECT
              p.id::text AS id,
              p.user_id::text AS user_id,
              p.market_id::text AS market_id,
              m.symbol AS market_symbol,
              m.lot_size::text AS lot_size,
              p.side,
              p.status,
              p.remaining_quantity::text AS remaining_quantity,
              p.slice_quantity::text AS slice_quantity,
              p.interval_sec,
              p.next_run_at,
              p.auth_expires_at
            FROM app_twap_plan p
            JOIN ex_market m ON m.id = p.market_id
            WHERE p.id = ${e.id}::uuid
              AND p.status = 'active'
              AND p.next_run_at <= now()
              AND p.remaining_quantity > 0
            LIMIT 1
            FOR UPDATE SKIP LOCKED
          `;if(!a.length)return{status:"skipped",reason:"not_due_or_locked"};let r=a[0],i=r.next_run_at,s=(await t`
            INSERT INTO app_twap_run (
              plan_id, user_id, market_id, side, scheduled_for, status, slice_quantity
            )
            VALUES (
              ${r.id}::uuid,
              ${r.user_id}::uuid,
              ${r.market_id}::uuid,
              ${r.side},
              ${i.toISOString()}::timestamptz,
              'failed',
              ${String(r.slice_quantity)}::numeric(38,18)
            )
            RETURNING id::text AS id
          `)[0].id,o=r.auth_expires_at?new Date(r.auth_expires_at).getTime():null;if(null!=o&&o<=Date.now()){await t`
              UPDATE app_twap_plan
              SET status = 'paused',
                  last_run_at = now(),
                  last_run_status = 'skipped',
                  last_run_error = 'auth_expired',
                  updated_at = now()
              WHERE id = ${r.id}::uuid
            `,await t`
              UPDATE app_twap_run
              SET status = 'skipped', error = 'auth_expired', finished_at = now()
              WHERE id = ${s}::uuid
            `;try{await (0,S.createNotification)(t,{userId:r.user_id,type:"system",title:"TWAP paused",body:"Your TWAP needs re-authorization. Open Terminal and resume it.",metadata:{kind:"twap",plan_id:r.id,href:"/terminal"}})}catch{}return{status:"skipped",reason:"auth_expired"}}let u=String(r.lot_size??"0.00000001"),l=(0,A.toBigInt3818)(String(r.remaining_quantity)),d=(0,A.toBigInt3818)(String(r.slice_quantity)),p=l<d?l:d,c=(0,v.quantizeDownToStep3818)((0,A.fromBigInt3818)(p),u);if(0n>=(0,A.toBigInt3818)(c))return await t`
              UPDATE app_twap_plan
              SET status = 'completed',
                  remaining_quantity = 0,
                  last_run_at = now(),
                  last_run_status = 'skipped',
                  last_run_error = 'quantity_too_small',
                  updated_at = now()
              WHERE id = ${r.id}::uuid
            `,await t`
              UPDATE app_twap_run
              SET status = 'skipped', error = 'quantity_too_small', finished_at = now()
              WHERE id = ${s}::uuid
            `,{status:"skipped",reason:"quantity_too_small"};let _=new Headers;_.set("content-type","application/json"),_.set("x-internal-service-token",n),_.set("x-user-id",String(r.user_id));let E=new Request("http://internal/api/exchange/orders",{method:"POST",headers:_,body:JSON.stringify({market_id:String(r.market_id),side:String(r.side),type:"market",quantity:c})}),h=await (0,T.POST)(E),w=await h.json().catch(()=>({}));if(!h.ok){let e="string"==typeof w?.error?String(w.error):`http_${h.status}`;return await t`
              UPDATE app_twap_run
              SET status = 'failed', error = ${e}, finished_at = now()
              WHERE id = ${s}::uuid
            `,await t`
              UPDATE app_twap_plan
              SET last_run_at = now(),
                  last_run_status = 'failed',
                  last_run_error = ${e},
                  next_run_at = now() + interval '1 minute',
                  updated_at = now()
              WHERE id = ${r.id}::uuid
            `,{status:"failed",reason:e}}let m=w?.order?.id??null,R=Array.isArray(w?.executions)?w.executions.length:null,g=l-(0,A.toBigInt3818)(c),f=Number(r.interval_sec)||60,x=new Date(Date.now()+1e3*Math.max(10,Math.min(86400,f))),y=g<=0n;return await t`
            UPDATE app_twap_run
            SET status = 'success',
                error = NULL,
                order_id = ${m||null}::uuid,
                fills_count = ${R},
                slice_quantity = ${c}::numeric(38,18),
                finished_at = now()
            WHERE id = ${s}::uuid
          `,await t`
            UPDATE app_twap_plan
            SET remaining_quantity = ${(0,A.fromBigInt3818)(g)}::numeric(38,18),
                last_run_at = now(),
                last_run_status = 'success',
                last_run_error = NULL,
                next_run_at = ${(y?new Date:x).toISOString()}::timestamptz,
                status = ${y?"completed":"active"},
                updated_at = now()
            WHERE id = ${r.id}::uuid
          `,{status:"success",orderId:m,done:y}});"success"===t.status?p+=1:"failed"===t.status?c+=1:_+=1}catch{c+=1}}try{await (0,y.upsertServiceHeartbeat)(i,{service:"cron:twap",status:"ok",details:{processed:d,succeeded:p,failed:c,skipped:_}})}catch{}return R.NextResponse.json({ok:!0,processed:d,succeeded:p,failed:c,skipped:_})}catch(e){try{await (0,y.upsertServiceHeartbeat)(i,{service:"cron:twap",status:"error",details:{message:e instanceof Error?e.message:String(e)}})}catch{}if((0,f.responseForDbError)("exchange.cron.twap",e))return R.NextResponse.json({ok:!1,error:"db_error"},{status:500});return R.NextResponse.json({ok:!1,error:"internal_error"},{status:500})}finally{try{await (0,x.releaseJobLock)(i,{key:o,holderId:u})}catch{}}}async function C(e){return N(e)}e.s(["GET",()=>C,"POST",()=>N,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],822848);var k=e.i(822848);let P=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/exchange/cron/twap/route",pathname:"/api/exchange/cron/twap",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/cron/twap/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:O,workUnitAsyncStorage:I,serverHooks:b}=P;function D(){return(0,r.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:I})}async function q(e,t,r){P.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/exchange/cron/twap/route";R=R.replace(/\/index$/,"")||"/";let g=await P.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:f,params:x,nextConfig:y,parsedUrl:S,isDraftMode:A,prerenderManifest:v,routerServerContext:T,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,resolvedPathname:k,clientReferenceManifest:O,serverActionsManifest:I}=g,b=(0,o.normalizeAppPath)(R),D=!!(v.dynamicRoutes[b]||v.routes[k]),q=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,S,!1):t.end("This page could not be found"),null);if(D&&!A){let e=!!v.routes[k],t=v.dynamicRoutes[b];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await q();throw new w.NoFallbackError}}let $=null;!D||P.isDev||A||($="/index"===($=k)?"/":$);let U=!0===P.isDev||!D,H=D&&!U;I&&O&&(0,s.setManifestsSingleton)({page:R,clientReferenceManifest:O,serverActionsManifest:I});let M=e.method||"GET",L=(0,i.getTracer)(),j=L.getActiveScopeSpan(),W={params:x,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>P.onRequestError(e,t,r,n,T)},sharedContext:{buildId:f}},B=new u.NodeNextRequest(e),F=new u.NodeNextResponse(t),z=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let s=async e=>P.handle(z,W).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=L.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${M} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${M} ${R}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var i,u;let l=async({previousCacheEntry:a})=>{try{if(!o&&N&&C&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=W.renderOpts.fetchMetrics;let u=W.renderOpts.pendingWaitUntil;u&&r.waitUntil&&(r.waitUntil(u),u=void 0);let l=W.renderOpts.collectedTags;if(!D)return await (0,c.sendResponse)(B,F,i,W.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==W.renderOpts.collectedRevalidate&&!(W.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&W.renderOpts.collectedRevalidate,r=void 0===W.renderOpts.collectedExpire||W.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:W.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,T),t}},d=await P.handleResponse({req:e,nextConfig:y,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,responseGenerator:l,waitUntil:r.waitUntil,isMinimalMode:o});if(!D)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&D||w.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,E.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(B,F,new Response(d.value.body,{headers:w,status:d.value.status||200})),null};j?await u(j):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${M} ${R}`,kind:i.SpanKind.SERVER,attributes:{"http.method":M,"http.target":e.url}},u))}catch(t){if(t instanceof w.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:N})},!1,T),D)throw t;return await (0,c.sendResponse)(B,F,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>D,"routeModule",()=>P,"serverHooks",()=>b,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>I],394380)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_67f08ccd.js.map