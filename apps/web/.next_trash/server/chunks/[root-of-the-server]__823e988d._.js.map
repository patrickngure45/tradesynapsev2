{"version":3,"sources":["../../../src/lib/api/errors.ts","../../../src/lib/dbTransient.ts","../../../src/lib/system/heartbeat.ts","../../../src/lib/email/templates.ts"],"sourcesContent":["import { ZodError } from \"zod\";\r\n\r\nexport type ApiErrorResponse = {\r\n  error: string;\r\n  details?: unknown;\r\n};\r\n\r\nexport function statusForApiError(code: string): number {\r\n  switch (code) {\r\n    // AuthN\r\n    case \"missing_x_user_id\":\r\n    case \"missing_user_id\":\r\n    case \"reviewer_key_invalid\":\r\n    case \"session_bootstrap_key_invalid\":\r\n    case \"admin_key_invalid\":\r\n    case \"session_token_expired\":\r\n      return 401;\r\n\r\n    // AuthZ\r\n    case \"not_party\":\r\n    case \"opened_by_not_party\":\r\n    case \"x_user_id_mismatch\":\r\n    case \"actor_not_allowed\":\r\n    case \"withdrawal_address_not_allowlisted\":\r\n    case \"email_not_verified\":\r\n    case \"kyc_required_for_asset\":\r\n    case \"withdrawal_requires_kyc\":\r\n    case \"withdrawal_allowlist_cooldown\":\r\n    case \"totp_setup_required\":\r\n    case \"stepup_required\":\r\n    case \"user_not_active\":\r\n    case \"buyer_not_active\":\r\n    case \"seller_not_active\":\r\n    case \"p2p_country_not_supported\":\r\n    case \"arcade_key_required\":\r\n      return 403;\r\n\r\n    // Not found\r\n    case \"not_found\":\r\n    case \"recipient_not_found\":\r\n    case \"trade_not_found\":\r\n    case \"dispute_not_found\":\r\n    case \"user_not_found\":\r\n    case \"market_not_found\":\r\n    case \"order_not_found\":\r\n    case \"ad_not_found\":\r\n    case \"transfer_not_found\":\r\n      return 404;\r\n\r\n    // Conflict / state machine\r\n    case \"trade_not_disputable\":\r\n    case \"trade_not_disputed\":\r\n    case \"trade_not_resolvable\":\r\n    case \"dispute_not_open\":\r\n    case \"dispute_already_exists\":\r\n    case \"dispute_transition_not_allowed\":\r\n    case \"trade_transition_not_allowed\":\r\n    case \"trade_not_cancelable\":\r\n    case \"trade_state_conflict\":\r\n    case \"insufficient_balance\":\r\n    case \"recipient_inactive\":\r\n    case \"recipient_same_as_sender\":\r\n    case \"transfer_not_reversible\":\r\n    case \"transfer_already_reversed\":\r\n    case \"recipient_insufficient_balance_for_reversal\":\r\n    case \"seller_insufficient_funds\":\r\n    case \"insufficient_liquidity_on_ad\":\r\n    case \"seller_payment_details_missing\":\r\n    case \"order_state_conflict\":\r\n    case \"market_disabled\":\r\n    case \"withdrawal_risk_blocked\":\r\n    case \"ad_is_not_online\":\r\n    case \"p2p_open_orders_limit\":\r\n    case \"post_only_would_take\":\r\n    case \"fok_insufficient_liquidity\":\r\n    case \"idempotency_key_conflict\":\r\n    case \"open_orders_limit\":\r\n    case \"order_notional_too_large\":\r\n    case \"exchange_price_out_of_band\":\r\n    case \"market_halted\":\r\n    case \"stp_cancel_newest\":\r\n    case \"stp_cancel_both\":\r\n    case \"passkey_not_configured\":\r\n      return 409;\r\n\r\n    // Gas token\r\n    case \"insufficient_gas\":\r\n      return 409;\r\n    case \"gas_disabled\":\r\n      return 403;\r\n    case \"gas_asset_not_found\":\r\n    case \"gas_fee_invalid\":\r\n      return 500;\r\n\r\n    // Forbidden\r\n    case \"cannot_trade_own_ad\":\r\n      return 403;\r\n\r\n    // Rate limiting\r\n    case \"rate_limit_exceeded\":\r\n    case \"p2p_order_create_cooldown\":\r\n      return 429;\r\n\r\n    // Validation\r\n    case \"invalid_input\":\r\n    case \"price_not_multiple_of_tick\":\r\n    case \"quantity_not_multiple_of_lot\":\r\n    case \"unsupported_version\":\r\n    case \"missing_file\":\r\n    case \"invalid_metadata_json\":\r\n    case \"buyer_not_found\":\r\n    case \"seller_not_found\":\r\n    case \"seller_payment_method_required\":\r\n    case \"invalid_seller_payment_method\":\r\n    case \"webauthn_verification_failed\":\r\n      return 400;\r\n\r\n    // Server misconfig\r\n    case \"reviewer_key_not_configured\":\r\n    case \"session_secret_not_configured\":\r\n    case \"session_bootstrap_not_configured\":\r\n    case \"admin_key_not_configured\":\r\n      return 500;\r\n\r\n    // Internal\r\n    case \"internal_error\":\r\n      return 500;\r\n\r\n    // Upstream / dependencies\r\n    case \"upstream_unavailable\":\r\n      return 503;\r\n\r\n    default:\r\n      return 400;\r\n  }\r\n}\r\n\r\nexport function apiError(\r\n  code: string,\r\n  init?: {\r\n    status?: number;\r\n    details?: unknown;\r\n    headers?: HeadersInit;\r\n  }\r\n): Response {\r\n  const status = init?.status ?? statusForApiError(code);\r\n  \r\n  // Ensure message is included if details is just a string, or if we can extract it.\r\n  // But strictly, we should output { error: code, message?: string, details?: any }\r\n  // The UI expects `message`.\r\n  const body: any = { error: code };\r\n  \r\n  if (typeof init?.details === 'string') {\r\n      body.message = init.details;\r\n      body.details = init.details;\r\n  } else if (typeof init?.details === 'object' && init?.details !== null) {\r\n      body.details = init.details;\r\n      if ('message' in init.details) {\r\n          body.message = (init.details as any).message;\r\n      }\r\n  }\r\n\r\n  const headers = init?.headers ? new Headers(init.headers) : new Headers();\r\n  if (code === \"upstream_unavailable\" && !headers.has(\"Retry-After\")) {\r\n    headers.set(\"Retry-After\", \"3\");\r\n  }\r\n\r\n  return Response.json(body, { status, headers });\r\n}\r\n\r\nexport function apiZodError(err: unknown): Response | null {\r\n  if (!(err instanceof ZodError)) return null;\r\n  return apiError(\"invalid_input\", { status: 400, details: err.issues });\r\n}\r\n\r\nexport function apiUpstreamUnavailable(\r\n  details?: unknown,\r\n  init?: {\r\n    retryAfterSeconds?: number;\r\n  }\r\n): Response {\r\n  const headers: HeadersInit | undefined =\r\n    typeof init?.retryAfterSeconds === \"number\"\r\n      ? { \"Retry-After\": String(Math.max(0, Math.floor(init.retryAfterSeconds))) }\r\n      : undefined;\r\n\r\n  return apiError(\"upstream_unavailable\", {\r\n    status: 503,\r\n    details,\r\n    headers,\r\n  });\r\n}\r\n","import { apiUpstreamUnavailable } from \"@/lib/api/errors\";\r\n\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((r) => setTimeout(r, ms));\r\n}\r\n\r\nfunction getErrorCode(err: unknown): string | undefined {\r\n  if (!err || typeof err !== \"object\") return undefined;\r\n  const anyErr = err as { code?: unknown };\r\n  return typeof anyErr.code === \"string\" ? anyErr.code : undefined;\r\n}\r\n\r\nfunction getErrorMessage(err: unknown): string {\r\n  if (!err || typeof err !== \"object\") return String(err);\r\n  const anyErr = err as { message?: unknown };\r\n  return typeof anyErr.message === \"string\" ? anyErr.message : String(err);\r\n}\r\n\r\nexport function isTransientDbError(err: unknown): boolean {\r\n  const code = (getErrorCode(err) ?? \"\").toUpperCase();\r\n  const msg = getErrorMessage(err);\r\n\r\n  // postgres.js (and some serverless poolers) commonly surface these.\r\n  const transientCodes = new Set([\r\n    \"CONNECTION_CLOSED\",\r\n    \"CONNECTION_ENDED\",\r\n    \"CONNECTION_DESTROYED\",\r\n    \"ECONNRESET\",\r\n    \"ETIMEDOUT\",\r\n    \"EPIPE\",\r\n    \"ENOTFOUND\",\r\n  ]);\r\n  if (code && transientCodes.has(code)) return true;\r\n\r\n  // SQLSTATE classes for connection / availability issues.\r\n  // 08xxx: connection exception, 57P0x: operator intervention.\r\n  const transientSqlState = new Set([\r\n    \"08000\",\r\n    \"08003\",\r\n    \"08006\",\r\n    \"08001\",\r\n    \"08004\",\r\n    \"57P01\",\r\n    \"57P02\",\r\n    \"57P03\",\r\n    \"53300\", // too_many_connections\r\n  ]);\r\n  if (code && transientSqlState.has(code)) return true;\r\n\r\n  if (\r\n    /CONNECTION_CLOSED|connection\\s+terminated|terminating\\s+connection|socket\\s+hang\\s+up|ECONNRESET|EPIPE/i.test(\r\n      msg\r\n    )\r\n  ) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport async function retryOnceOnTransientDbError<T>(\r\n  fn: () => Promise<T>,\r\n  init?: { delayMs?: number }\r\n): Promise<T> {\r\n  try {\r\n    return await fn();\r\n  } catch (e) {\r\n    if (!isTransientDbError(e)) throw e;\r\n    await sleep(init?.delayMs ?? 50);\r\n    return await fn();\r\n  }\r\n}\r\n\r\nexport function responseForDbError(op: string, err: unknown): Response | null {\r\n  if (!isTransientDbError(err)) return null;\r\n\r\n  return apiUpstreamUnavailable(\r\n    {\r\n      dependency: \"db\",\r\n      op,\r\n    },\r\n    { retryAfterSeconds: 3 }\r\n  );\r\n}\r\n","import type { Sql } from \"postgres\";\r\n\r\nexport type HeartbeatStatus = \"ok\" | \"degraded\" | \"error\";\r\n\r\nexport async function upsertServiceHeartbeat(\r\n  sql: Sql,\r\n  args: {\r\n    service: string;\r\n    status?: HeartbeatStatus;\r\n    details?: Record<string, unknown>;\r\n  },\r\n): Promise<void> {\r\n  const service = String(args.service ?? \"\").trim();\r\n  if (!service) return;\r\n\r\n  const status: HeartbeatStatus = args.status ?? \"ok\";\r\n  const details = args.details ?? {};\r\n\r\n  await sql`\r\n    INSERT INTO app_service_heartbeat (service, status, details_json, last_seen_at, updated_at)\r\n    VALUES (\r\n      ${service},\r\n      ${status},\r\n      ${(sql as any).json(details)}::jsonb,\r\n      now(),\r\n      now()\r\n    )\r\n    ON CONFLICT (service) DO UPDATE\r\n      SET status = EXCLUDED.status,\r\n          details_json = EXCLUDED.details_json,\r\n          last_seen_at = EXCLUDED.last_seen_at,\r\n          updated_at = EXCLUDED.updated_at\r\n  `;\r\n}\r\n\r\nexport type HeartbeatRow = {\r\n  service: string;\r\n  status: HeartbeatStatus;\r\n  details_json: unknown;\r\n  last_seen_at: string;\r\n};\r\n\r\nexport async function listServiceHeartbeats(sql: Sql): Promise<HeartbeatRow[]> {\r\n  return await sql<HeartbeatRow[]>`\r\n    SELECT\r\n      service,\r\n      status,\r\n      details_json,\r\n      last_seen_at::text\r\n    FROM app_service_heartbeat\r\n    ORDER BY service ASC\r\n  `;\r\n}\r\n","/**\r\n * Pre-built email templates.\r\n *\r\n * Each returns { subject, text, html } suitable for sendMail().\r\n *\r\n * Branding is configurable via env vars:\r\n *   EMAIL_BRAND        — e.g. \"Coinwaka\"\r\n *   SUPPORT_EMAIL      — e.g. \"support@coinwaka.com\"\r\n *   EMAIL_FROM_NAME    — fallback brand display name\r\n */\r\n\r\nconst BRAND = (process.env.EMAIL_BRAND ?? process.env.EMAIL_FROM_NAME ?? \"Coinwaka\").trim() || \"Coinwaka\";\r\nconst SUPPORT_EMAIL = (process.env.SUPPORT_EMAIL ?? \"support@coinwaka.com\").trim() || \"support@coinwaka.com\";\r\nconst SITE_URL_RAW = (process.env.NEXT_PUBLIC_BASE_URL ?? \"\").trim();\r\nconst SITE_ORIGIN = (() => {\r\n  try {\r\n    if (!SITE_URL_RAW) return \"\";\r\n    return new URL(SITE_URL_RAW).origin;\r\n  } catch {\r\n    return \"\";\r\n  }\r\n})();\r\n\r\n// Use a PNG/JPG logo URL for best compatibility (many clients block SVG).\r\nconst EMAIL_LOGO_URL = (process.env.EMAIL_LOGO_URL ?? \"\").trim();\r\nconst EMAIL_LOGO_ALT = (process.env.EMAIL_LOGO_ALT ?? BRAND).trim() || BRAND;\r\nconst EMAIL_LOGO_WIDTH = Math.max(60, Math.min(240, parseInt(process.env.EMAIL_LOGO_WIDTH ?? \"120\", 10) || 120));\r\n\r\nfunction escapeHtml(text: string): string {\r\n  return String(text)\r\n    .replace(/&/g, \"&amp;\")\r\n    .replace(/</g, \"&lt;\")\r\n    .replace(/>/g, \"&gt;\")\r\n    .replace(/\\\"/g, \"&quot;\")\r\n    .replace(/'/g, \"&#39;\");\r\n}\r\n\r\nfunction wrap(opts: { bodyHtml: string; preheader: string }): string {\r\n  const year = new Date().getFullYear();\r\n  const preheader = escapeHtml(opts.preheader);\r\n\r\n  const brandHeaderHtml = EMAIL_LOGO_URL\r\n    ? `\r\n      <div style=\"line-height:0;\">\r\n        <img src=\"${escapeHtml(EMAIL_LOGO_URL)}\" width=\"${EMAIL_LOGO_WIDTH}\" alt=\"${escapeHtml(EMAIL_LOGO_ALT)}\" style=\"display:block;border:0;outline:none;text-decoration:none;height:auto;max-width:100%;margin:0 auto;\" />\r\n      </div>\r\n      <div style=\"margin-top:10px;font-size:16px;font-weight:700;letter-spacing:-0.01em;color:#ffffff;\">${escapeHtml(BRAND)}</div>\r\n    `\r\n    : `${escapeHtml(BRAND)}`;\r\n\r\n  // NOTE: Use table layout for broad email client compatibility.\r\n  // Avoid relying on gradients/dark backgrounds (often render oddly in clients/dark mode).\r\n  return `<!doctype html>\r\n<html lang=\"en\">\r\n<head>\r\n  <meta charset=\"utf-8\">\r\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n  <meta name=\"x-apple-disable-message-reformatting\">\r\n  <meta name=\"format-detection\" content=\"telephone=no,address=no,email=no,date=no,url=no\">\r\n  <title>${escapeHtml(BRAND)}</title>\r\n</head>\r\n<body style=\"margin:0;padding:0;background-color:#f3f4f6;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;\">\r\n  <!-- Preheader (hidden) -->\r\n  <div style=\"display:none;font-size:1px;line-height:1px;max-height:0;max-width:0;opacity:0;overflow:hidden;mso-hide:all;\">\r\n    ${preheader}\r\n  </div>\r\n\r\n  <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"background-color:#f3f4f6;\">\r\n    <tr>\r\n      <td align=\"center\" style=\"padding:24px 12px;\">\r\n        <table role=\"presentation\" width=\"100%\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"max-width:560px;background-color:#ffffff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;\">\r\n          <tr>\r\n            <td align=\"center\" style=\"padding:18px 24px;background-color:#4f46e5;color:#ffffff;font-size:18px;font-weight:700;letter-spacing:-0.01em;\">\r\n              ${brandHeaderHtml}\r\n            </td>\r\n          </tr>\r\n\r\n          <tr>\r\n            <td style=\"padding:24px;color:#111827;font-size:14px;line-height:1.6;\">\r\n              ${opts.bodyHtml}\r\n            </td>\r\n          </tr>\r\n\r\n          <tr>\r\n            <td style=\"padding:16px 24px;border-top:1px solid #e5e7eb;color:#6b7280;font-size:12px;line-height:1.5;\" align=\"center\">\r\n              <div>&copy; ${year} ${escapeHtml(BRAND)}.</div>\r\n              ${SITE_ORIGIN ? `<div style=\"margin-top:6px;\">Website: <a href=\"${escapeHtml(SITE_ORIGIN)}\" style=\"color:#4f46e5;text-decoration:none;\">${escapeHtml(SITE_ORIGIN)}</a></div>` : \"\"}\r\n              <div style=\"margin-top:6px;\">Support: <a href=\"mailto:${escapeHtml(SUPPORT_EMAIL)}\" style=\"color:#4f46e5;text-decoration:none;\">${escapeHtml(SUPPORT_EMAIL)}</a></div>\r\n              <div style=\"margin-top:10px;color:#9ca3af;font-size:11px;\">You’re receiving this email because an account action was requested for your email address.</div>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </td>\r\n    </tr>\r\n  </table>\r\n</body>\r\n</html>`;\r\n}\r\n\r\nfunction button(opts: { url: string; label: string }): string {\r\n  const url = opts.url;\r\n  const label = escapeHtml(opts.label);\r\n\r\n  // Outlook-safe button\r\n  return `\r\n  <table role=\"presentation\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin:18px auto;\">\r\n    <tr>\r\n      <td bgcolor=\"#4f46e5\" style=\"border-radius:10px;\">\r\n        <a href=\"${url}\" style=\"display:inline-block;padding:12px 18px;color:#ffffff;text-decoration:none;font-weight:700;font-size:14px;\">${label}</a>\r\n      </td>\r\n    </tr>\r\n  </table>`;\r\n}\r\n\r\n// ── Verification Email ──────────────────────────────────────────\r\nexport function verificationEmail(verifyUrl: string): { subject: string; text: string; html: string } {\r\n  const subject = `Verify your email — ${BRAND}`;\r\n  const text = `Verify your email address to finish setting up your ${BRAND} account:\\n\\n${verifyUrl}\\n\\nThis link expires in 24 hours.\\n\\nIf you didn't create an account, you can ignore this email.`;\r\n  const html = wrap({\r\n    preheader: `Verify your email to finish setting up your ${BRAND} account.`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Verify your email</h2>\r\n      <p style=\"margin:0 0 12px;\">Thanks for signing up. Click the button below to verify your email address.</p>\r\n      ${button({ url: verifyUrl, label: \"Verify email\" })}\r\n      <p style=\"margin:0 0 8px;color:#6b7280;font-size:12px;\">This link expires in 24 hours.</p>\r\n      <p style=\"margin:14px 0 6px;color:#111827;font-weight:600;\">If the button doesn’t work, copy and paste this link:</p>\r\n      <p style=\"margin:0 0 10px;word-break:break-all;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;color:#374151;\">${escapeHtml(verifyUrl)}</p>\r\n      <p style=\"margin:0;color:#6b7280;font-size:12px;\">If you didn’t create an account, you can ignore this email.</p>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── KYC Approved ────────────────────────────────────────────────\r\nexport function kycApprovedEmail(): { subject: string; text: string; html: string } {\r\n  const subject = `KYC Verified — ${BRAND}`;\r\n  const text = `Your identity has been verified. You now have Verified KYC status with increased withdrawal limits ($50,000/day).`;\r\n  const html = wrap({\r\n    preheader: `Your identity verification is approved.`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Identity verified</h2>\r\n      <p style=\"margin:0 0 8px;\">Your identity documents have been reviewed and approved.</p>\r\n      <p style=\"margin:0;\">You now have <strong>Verified</strong> KYC status with a daily withdrawal limit of <strong>$50,000</strong>.</p>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── KYC Rejected ────────────────────────────────────────────────\r\nexport function kycRejectedEmail(reason: string): { subject: string; text: string; html: string } {\r\n  const subject = `KYC Review Update — ${BRAND}`;\r\n  const text = `Your identity document submission was not approved.\\n\\nReason: ${reason}\\n\\nPlease re-submit clearer documents from your account page.`;\r\n  const html = wrap({\r\n    preheader: `Your document submission needs an update.`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Document review update</h2>\r\n      <p style=\"margin:0 0 8px;\">Your identity document submission was not approved.</p>\r\n      <div style=\"background-color:#fef2f2;border:1px solid #fecaca;border-left:4px solid #ef4444;padding:12px 12px;margin:16px 0;border-radius:8px;\">\r\n        <div style=\"font-size:13px;color:#7f1d1d;\"><strong>Reason:</strong> ${escapeHtml(reason)}</div>\r\n      </div>\r\n      <p style=\"margin:0;color:#374151;\">Please re-submit clearer documents from your account page.</p>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── Withdrawal Completed ────────────────────────────────────────\r\nexport function withdrawalCompletedEmail(amount: string, symbol: string, txHash: string): { subject: string; text: string; html: string } {\r\n  const subject = `Withdrawal Confirmed — ${BRAND}`;\r\n  const text = `Your withdrawal of ${amount} ${symbol} has been confirmed on-chain.\\n\\nTransaction: ${txHash}`;\r\n  const html = wrap({\r\n    preheader: `Your withdrawal is confirmed on-chain.`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Withdrawal confirmed</h2>\r\n      <p style=\"margin:0 0 12px;\">Your withdrawal has been confirmed on-chain:</p>\r\n      <div style=\"background-color:#f9fafb;border:1px solid #e5e7eb;padding:14px;border-radius:10px;margin:12px 0;\">\r\n        <div style=\"font-size:20px;font-weight:800;color:#111827;\">${escapeHtml(amount)} ${escapeHtml(symbol)}</div>\r\n        <div style=\"margin-top:6px;font-size:12px;color:#6b7280;word-break:break-all;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;\">TX: ${escapeHtml(txHash)}</div>\r\n      </div>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── Security Alert (login, 2FA change, etc.) ────────────────────\r\nexport function securityAlertEmail(action: string, ip: string, timestamp: string): { subject: string; text: string; html: string } {\r\n  const subject = `Security Alert — ${BRAND}`;\r\n  const text = `Security event on your account:\\n\\nAction: ${action}\\nIP: ${ip}\\nTime: ${timestamp}\\n\\nIf this wasn't you, change your password immediately.`;\r\n  const html = wrap({\r\n    preheader: `Security activity detected on your account.`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Security alert</h2>\r\n      <p style=\"margin:0 0 12px;\">A security event was detected on your account:</p>\r\n      <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"width:100%;background-color:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;\">\r\n        <tr>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#6b7280;width:110px;\">Action</td>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#111827;\">${escapeHtml(action)}</td>\r\n        </tr>\r\n        <tr>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#6b7280;width:110px;\">IP</td>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#111827;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;\">${escapeHtml(ip)}</td>\r\n        </tr>\r\n        <tr>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#6b7280;width:110px;\">Time</td>\r\n          <td style=\"padding:10px 12px;font-size:13px;color:#111827;\">${escapeHtml(timestamp)}</td>\r\n        </tr>\r\n      </table>\r\n      <p style=\"margin:14px 0 0;color:#b91c1c;font-size:13px;\"><strong>If this wasn’t you</strong>, change your password immediately and enable 2FA.</p>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── Password Reset ─────────────────────────────────────────────\r\nexport function passwordResetEmail(resetUrl: string): { subject: string; text: string; html: string } {\r\n  const subject = `Reset your password — ${BRAND}`;\r\n  const text = `A password reset was requested for your ${BRAND} account.\\n\\nReset your password using this link (expires in 1 hour):\\n${resetUrl}\\n\\nIf you didn't request this, you can ignore this email.`;\r\n  const html = wrap({\r\n    preheader: `Reset your password (link expires in 1 hour).`,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 12px;font-size:18px;line-height:1.3;color:#111827;\">Reset your password</h2>\r\n      <p style=\"margin:0 0 12px;\">A password reset was requested for your account.</p>\r\n      ${button({ url: resetUrl, label: \"Reset password\" })}\r\n      <p style=\"margin:0 0 8px;color:#6b7280;font-size:12px;\">This link expires in 1 hour.</p>\r\n      <p style=\"margin:14px 0 6px;color:#111827;font-weight:600;\">If the button doesn’t work, copy and paste this link:</p>\r\n      <p style=\"margin:0 0 10px;word-break:break-all;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;font-size:12px;color:#374151;\">${escapeHtml(resetUrl)}</p>\r\n      <p style=\"margin:0;color:#6b7280;font-size:12px;\">If you didn’t request this, you can ignore this email.</p>\r\n    `,\r\n  });\r\n  return { subject, text, html };\r\n}\r\n\r\n// ── Ops Alerts (cron/outbox health) ─────────────────────────────\r\nexport function opsAlertEmail(args: {\r\n  title: string;\r\n  summary: string;\r\n  lines: string[];\r\n  statusUrl?: string;\r\n}): { subject: string; text: string; html: string } {\r\n  const subject = `[Ops] ${args.title} — ${BRAND}`;\r\n  const statusUrl = (args.statusUrl ?? \"\").trim();\r\n  const lines = Array.isArray(args.lines) ? args.lines.map((s) => String(s)).filter(Boolean) : [];\r\n\r\n  const text = [\r\n    `${args.summary}`,\r\n    \"\",\r\n    ...(lines.length ? [\"Signals:\", ...lines.map((l) => `- ${l}`)] : []),\r\n    ...(statusUrl ? [\"\", `Status: ${statusUrl}`] : []),\r\n  ].join(\"\\n\");\r\n\r\n  const html = wrap({\r\n    preheader: args.summary,\r\n    bodyHtml: `\r\n      <h2 style=\"margin:0 0 10px;font-size:18px;line-height:1.3;color:#111827;\">${escapeHtml(args.title)}</h2>\r\n      <p style=\"margin:0 0 12px;color:#374151;\">${escapeHtml(args.summary)}</p>\r\n      ${lines.length ? `\r\n        <div style=\"background-color:#fff7ed;border:1px solid #fed7aa;border-left:4px solid #f97316;padding:12px 12px;margin:14px 0;border-radius:8px;\">\r\n          <div style=\"font-size:12px;color:#7c2d12;font-weight:700;margin-bottom:6px;\">Signals</div>\r\n          <ul style=\"margin:0;padding-left:18px;color:#7c2d12;font-size:12px;line-height:1.5;\">\r\n            ${lines.map((l) => `<li>${escapeHtml(l)}</li>`).join(\"\\n\")}\r\n          </ul>\r\n        </div>\r\n      ` : \"\"}\r\n      ${statusUrl ? `\r\n        <p style=\"margin:10px 0 0;color:#374151;\">Open the status page for details:</p>\r\n        ${button({ url: statusUrl, label: \"View status\" })}\r\n        <p style=\"margin:0;color:#6b7280;font-size:12px;word-break:break-all;\">${escapeHtml(statusUrl)}</p>\r\n      ` : \"\"}\r\n    `,\r\n  });\r\n\r\n  return { subject, text, html };\r\n}\r\n\r\n"],"names":[],"mappings":"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"}