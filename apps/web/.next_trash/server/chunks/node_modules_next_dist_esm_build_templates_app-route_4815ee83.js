module.exports=[477190,e=>{"use strict";var t=e.i(747909),n=e.i(174017),a=e.i(996250),r=e.i(759756),s=e.i(561916),i=e.i(174677),o=e.i(869741),l=e.i(316795),u=e.i(487718),c=e.i(995169),d=e.i(47587),p=e.i(666012),m=e.i(570101),h=e.i(626937),b=e.i(10372),g=e.i(193695);e.i(52474);var _=e.i(600220),f=e.i(89171),y=e.i(843793),S=e.i(977775),x=e.i(364608),A=e.i(184883),E=e.i(844297),R=e.i(29984),N=e.i(6597),w=e.i(136799);function k(e,t,n){return Math.min(n,Math.max(t,e))}function C(e,t){let n=process.env[e];if(!n)return t;let a=Number(n);return Number.isFinite(a)?a:t}function v(e){let t=new Map;for(let n of e){let e=`${n.symbol}::${n.exchange}`,a=t.get(e);(!a||n.ts>a.ts)&&t.set(e,n)}return Array.from(t.values())}async function O(e){return(await e`
    SELECT symbol
    FROM ex_asset
    WHERE chain = 'bsc' AND is_enabled = true
    ORDER BY symbol ASC
  `).map(e=>String(e.symbol).toUpperCase())}function T(e,t,n){return[...e].sort((e,n)=>t(n)-t(e)).slice(0,Math.max(0,n))}async function M(e,t,n){let a=0,r=Array.from({length:Math.min(Math.max(1,Math.floor(t)),e.length)},async()=>{for(;;){let t=a++;if(t>=e.length)return;await n(e[t])}});await Promise.allSettled(r)}function B(e,t){let n=process.env[e];if(!n)return t;let a=n.trim().toLowerCase();return"1"===a||"true"===a||"yes"===a||"0"!==a&&"false"!==a&&"no"!==a&&t}let D=B("ARB_INTERNAL_SETTLEMENT_ENABLED",!0);function I(e){let t=["BTC","ETH","BNB","SOL","XRP","ADA","DOGE","TRX","LINK","AVAX","TON","MATIC"].indexOf(e.toUpperCase());return -1===t?0:1e3-t}async function U(e,t){let n=await e`
    SELECT exchange
    FROM user_exchange_connection
    WHERE user_id = ${t}::uuid
      AND status = 'active'
    GROUP BY exchange
    ORDER BY exchange ASC
  `,a=new Set(["binance","bybit","okx","kucoin","gateio","bitget","mexc"]);return n.map(e=>String(e.exchange).toLowerCase()).filter(e=>a.has(e))}async function P(e,t,n){if(!n.length)return{};let a=await e`
    SELECT exchange, api_key_enc, api_secret_enc, passphrase_enc, created_at
    FROM user_exchange_connection
    WHERE user_id = ${t}::uuid
      AND status = 'active'
      AND exchange IN (${e(n)})
    ORDER BY exchange ASC, created_at DESC
  `,r={};for(let e of a){let t=String(e.exchange).toLowerCase();r[t]||(r[t]={apiKey:(0,E.decryptCredential)(e.api_key_enc),apiSecret:(0,E.decryptCredential)(e.api_secret_enc),...e.passphrase_enc?{passphrase:(0,E.decryptCredential)(e.passphrase_enc)}:{}})}return r}async function L(e,t,n){let a={},r=k(C("ARB_FEE_CONCURRENCY",3),1,6);return await M(e,r,async e=>{let r=e.toLowerCase(),s=t[r];if(!s){a[r]={exchange:r,checkedAt:new Date().toISOString(),ok:!1,error:"missing_credentials"};return}try{let t=await (0,R.getAuthenticatedTradingFee)(e,s,n);a[r]={exchange:r,checkedAt:new Date().toISOString(),ok:!0,taker:t.taker,maker:t.maker,source:t.source}}catch(e){a[r]={exchange:r,checkedAt:new Date().toISOString(),ok:!1,error:e instanceof Error?e.message:String(e)}}}),a}function F(e,t){return`${e.toLowerCase()}::${t.toUpperCase()}`}function H(e,t){return`${e.toLowerCase()}::${t.toUpperCase()}`}async function q(e){let t=new Map;for(let n of e)t.set(H(n.exchange,n.symbol),n);let n=Array.from(t.values()),a=k(C("ARB_CONSTRAINTS_CONCURRENCY",4),1,8),r=new Map;return await M(n,a,async e=>{let t=H(e.exchange,e.symbol),n=await (0,R.getExchangeMarketConstraints)(e.exchange,e.symbol);r.set(t,n)}),r}async function $(e){let t=new Map;for(let n of e)t.set(F(n.exchange,n.symbol),n);let n=Array.from(t.values()),a=k(C("ARB_DEPTH_CONCURRENCY",4),1,8),r=k(C("ARB_ORDERBOOK_LIMIT",50),10,200),s=new Map;return await M(n,a,async e=>{let t=F(e.exchange,e.symbol),n=await (0,R.getExchangeOrderBook)(e.exchange,e.symbol,{limit:r});s.set(t,n)}),s}async function Y(e,t,n){let a={},r=new Set(n.map(e=>e.toUpperCase())),s=k(C("ARB_BALANCE_CONCURRENCY",3),1,6);return await M(e,s,async e=>{let n=e.toLowerCase(),s=t[n];if(!s){a[n]={exchange:n,checkedAt:new Date().toISOString(),ok:!1,error:"missing_credentials"};return}try{let t=await (0,R.getExchangeBalances)(e,s),i={};for(let e of t){let t=String(e.asset).toUpperCase();if(!r.has(t))continue;let n=Number(e.free),a=Number(e.locked);i[t]={free:Number.isFinite(n)?n:0,locked:Number.isFinite(a)?a:0}}a[n]={exchange:n,checkedAt:new Date().toISOString(),ok:!0,assets:i}}catch(e){a[n]={exchange:n,checkedAt:new Date().toISOString(),ok:!1,error:e instanceof Error?e.message:String(e)}}}),a}async function j(e,t){if(0===t.length)return[];let n=await e`
    WITH mk AS (
      SELECT m.id, m.symbol, ab.symbol AS base_symbol
      FROM ex_market m
      JOIN ex_asset ab ON ab.id = m.base_asset_id
      JOIN ex_asset aq ON aq.id = m.quote_asset_id
      WHERE m.status = 'enabled'
        AND ab.chain = 'bsc'
        AND aq.chain = 'bsc'
        AND aq.symbol = 'USDT'
        AND ab.symbol = ANY(${e.array(t.map(e=>e.toUpperCase()))})
    ),
    best_bid AS (
      SELECT o.market_id, max(o.price)::text AS bid
      FROM ex_order o
      WHERE o.side = 'buy' AND o.status IN ('open','partially_filled')
      GROUP BY o.market_id
    ),
    best_ask AS (
      SELECT o.market_id, min(o.price)::text AS ask
      FROM ex_order o
      WHERE o.side = 'sell' AND o.status IN ('open','partially_filled')
      GROUP BY o.market_id
    ),
    last_exec AS (
      SELECT DISTINCT ON (e.market_id) e.market_id, e.price::text AS last, e.created_at::text AS last_ts
      FROM ex_execution e
      ORDER BY e.market_id, e.created_at DESC
    )
    SELECT mk.symbol, mk.base_symbol,
           bb.bid, ba.ask,
           le.last, le.last_ts
    FROM mk
    LEFT JOIN best_bid bb ON bb.market_id = mk.id
    LEFT JOIN best_ask ba ON ba.market_id = mk.id
    LEFT JOIN last_exec le ON le.market_id = mk.id
  `,a=k(C("ARB_INTERNAL_FALLBACK_SPREAD_BPS",30),1,500)/2/1e4,r=[];for(let e of n){let t=e.bid?Number(e.bid):NaN,n=e.ask?Number(e.ask):NaN;if(Number.isFinite(t)&&Number.isFinite(n)&&t>0&&n>0){r.push({base:String(e.base_symbol).toUpperCase(),symbol:String(e.symbol),bid:t,ask:n,mid:(t+n)/2,ts:new Date().toISOString()});continue}let s=e.last?Number(e.last):NaN;Number.isFinite(s)&&!(s<=0)&&r.push({base:String(e.base_symbol).toUpperCase(),symbol:String(e.symbol),bid:s*(1-a),ask:s*(1+a),mid:s,ts:e.last_ts?String(e.last_ts):new Date().toISOString()})}return r}async function K(e){let t=(0,y.getSql)(),n=(0,S.getActingUserId)(e),a=(0,S.requireActingUserIdInProd)(n);if(a)return f.NextResponse.json({error:a},{status:401});if(!n)return f.NextResponse.json({error:"missing_x_user_id"},{status:401});let r=new URL(e.url).searchParams.get("action")??"latest";try{let e=await (0,x.requireActiveUser)(t,n);if(e)return f.NextResponse.json({error:e},{status:403});let a=await U(t,n),s=a.length>0?a:function(){let e=new Set(["binance","bybit","okx","kucoin","gateio","bitget","mexc"]),t=process.env.ARB_PUBLIC_VENUES;if(t){let n=t.split(",").map(e=>e.trim().toLowerCase()).filter(Boolean).filter(t=>e.has(t));if(n.length>0)return n}return["binance","bybit","okx"]}(),i=(await O(t)).filter(e=>"USDT"!==e),o=k(C("ARB_MAX_SYMBOLS",30),5,200),l=T(i,e=>I(String(e)),o),u=l.map(e=>{var t;return t=String(e),`${t}USDT`.replace(/[^a-zA-Z0-9]/g,"").toUpperCase()}),c=[];0===u.length&&c.push({error:"no_symbols",message:"No enabled assets are available to scan."});let d=k(C("ARB_MIN_NOTIONAL_USD",25),5,500),p=k(C("ARB_NOTIONAL_USD_CAP",1e3),d,1e5),m=k(C("ARB_NOTIONAL_USD",d),d,p);0===a.length&&c.push({error:"no_exchange_connections",message:"No exchange APIs connected yet. Scan uses public market data; connect an exchange API to unlock balance checks + execution readiness."});let h="0"!==process.env.ARB_BALANCES_ENABLED&&"scan"===r&&a.length>0,b=null,g=B("ARB_FEES_ENABLED",!0)&&"scan"===r&&a.length>0,_=null,y=B("ARB_DEPTH_ENABLED",!0)&&"scan"===r,S=null,A=B("ARB_CONSTRAINTS_ENABLED",!0)&&"scan"===r,E=null,R=[],M=[];if("scan"===r&&u.length>0){let e=await (0,N.captureArbSnapshots)(t,{exchanges:s,symbols:u,includeInternalPrices:!1,storeSnapshots:!0});if(R=v(e.snapshots),M=e.errors,h){let e=await P(t,n,a),r=["USDT",...l.map(e=>String(e).toUpperCase())];if(b=await Y(a,e,r),g){let t=u.includes("BTCUSDT")?"BTCUSDT":u[0];_=await L(a,e,t)}}}else{let e=(await (0,N.getRecentSnapshots)(t,void 0,.1)).filter(e=>s.includes(String(e.exchange).toLowerCase()));R=v(e)}let K=(0,N.detectOpportunities)(R,{minNetSpread:-100,oppExchanges:s,includeInternal:!1,quoteSuffix:"USDT"}),W=K.filter(e=>e.netSpreadPct>=-1);if(y){let e=k(C("ARB_DEPTH_TOP_N",15),0,100);if(e>0){let t=K.slice(0,e),n=[];for(let e of t){let t=String(e.buyExchange).toLowerCase(),a=String(e.sellExchange).toLowerCase();n.push({exchange:t,symbol:e.symbol}),n.push({exchange:a,symbol:e.symbol})}try{S=await $(n)}catch{S=null}}}if(A){let e=k(C("ARB_CONSTRAINTS_TOP_N",60),0,500),t=e>0?W.slice(0,e):[],n=[];for(let e of t)n.push({exchange:String(e.buyExchange).toLowerCase(),symbol:e.symbol}),n.push({exchange:String(e.sellExchange).toLowerCase(),symbol:e.symbol});try{E=await q(n)}catch{E=null}}let X=W.map(e=>{let t,r,s=e.netSpreadPct/100*m,i=e.spreadPct/100*m,o=(t=e.symbol.toUpperCase(),r="USDT",!t.endsWith(r)||t.length<=r.length?null:t.slice(0,-r.length)),l=o&&e.buyAsk>0?m/e.buyAsk:null,u=String(e.buyExchange).toLowerCase(),c=String(e.sellExchange).toLowerCase(),d=b?.[u],p=b?.[c],h=null,g=m,f=l,y=[];if(b){let t=[];if(o&&l&&Number.isFinite(l)&&!(l<=0)||t.push("invalid_quantity"),d&&d.ok||t.push("buy_balance_unavailable"),p&&p.ok||t.push("sell_balance_unavailable"),o&&l&&d?.ok&&p?.ok){let n=d.assets?.USDT?.free??0,a=p.assets?.[o]?.free??0,r=e.buyAsk>0?n/e.buyAsk:0,s=Math.max(0,Math.min(r,a)),i=s*(e.buyAsk>0?e.buyAsk:0);n+1e-9<m&&t.push("insufficient_usdt_on_buy"),a+1e-12<l&&t.push("insufficient_base_on_sell"),Number.isFinite(i)&&i>0&&i+1e-9<m&&(g=i,f=s,r+1e-12<a&&y.push("usdt"),a+1e-12<r&&y.push("base"))}h={status:0===t.length?"ready":t.some(e=>e.includes("unavailable"))?"unknown":"missing",blockers:t,...o&&l?{required:{usdtBuy:m,baseSell:l,base:o}}:{},...o&&f&&Number.isFinite(g)&&g>0?{max:{notionalUsd:g,baseSell:f,limitedBy:y}}:{}}}let x=[],R=E?.get(H(u,e.symbol))??null,N=E?.get(H(c,e.symbol))??null;if(A){if(R&&!R.ok&&x.push("symbol_unavailable_buy"),N&&!N.ok&&x.push("symbol_unavailable_sell"),o&&g>0&&e.buyAsk>0){let t=g/e.buyAsk,n=R?.ok?R.amountPrecision:null,a=N?.ok?N.amountPrecision:null,r=null===n?a:null===a?n:Math.min(n,a),s=function(e,t){if(!Number.isFinite(e)||e<=0)return 0;if(null===t||!Number.isFinite(t)||t<0)return e;let n=Math.min(12,Math.max(0,Math.floor(t))),a=10**n;return Math.floor(e*a)/a}(t,r??null);s>0&&f&&Number.isFinite(f)&&s+1e-12<f&&(y=Array.from(new Set([...y,"precision"]))),g=(f=s>0?s:f)&&e.buyAsk>0?f*e.buyAsk:g,R?.ok&&"number"==typeof R.amountMin&&f&&f>0&&f<R.amountMin&&x.push("min_amount_buy"),N?.ok&&"number"==typeof N.amountMin&&f&&f>0&&f<N.amountMin&&x.push("min_amount_sell"),R?.ok&&"number"==typeof R.costMin&&g>0&&g<R.costMin&&x.push("min_notional_buy");let i=f&&f>0?f*e.sellBid:0;N?.ok&&"number"==typeof N.costMin&&i>0&&i<N.costMin&&x.push("min_notional_sell")}if(h&&x.length>0&&(h.status="missing",h.blockers=Array.from(new Set([...h.blockers??[],...x])),h.max&&(h.max.limitedBy=Array.from(new Set([...h.max.limitedBy??[],"constraints"])))),x.length>0)return null}let w=Math.max(0,C("ARB_TAKER_FEE_BPS",10)),v=_?.[u]?.ok&&"number"==typeof _?.[u]?.taker?_[u].taker:w/1e4,O=_?.[c]?.ok&&"number"==typeof _?.[c]?.taker?_[c].taker:w/1e4,T=Math.max(0,C("ARB_LATENCY_BPS",2)),M=(v+O)*100,B=null,I=null;if(S&&o&&Number.isFinite(g)&&g>0){let t=S.get(F(u,e.symbol)),n=S.get(F(c,e.symbol));if(t&&n&&t.asks.length&&n.bids.length){let e=function(e,t){let n=t,a=0,r=0;for(let[t,s]of e){if(n<=0)break;let e=Math.min(t*s,n);a+=e/t,r+=e,n-=e}if(!(r>0)||!(a>0))return null;let s=r/a,i=e.length?e[0][0]:s;return{vwap:s,baseFilled:a,slippageBps:i>0?(s-i)/i*1e4:0}}(t.asks,g);if(e&&e.baseFilled>0){let t=function(e,t){let n=t,a=0,r=0;for(let[t,s]of e){if(n<=0)break;let e=Math.min(s,n);a+=e,r+=e*t,n-=e}if(!(r>0)||!(a>0))return null;let s=r/a,i=e.length?e[0][0]:s;return{vwap:s,quoteReceived:r,slippageBps:i>0?(i-s)/i*1e4:0}}(n.bids,e.baseFilled);t&&t.quoteReceived>0&&(I=(t.vwap-e.vwap)/e.vwap*100-M-T/100,B={buyVwap:e.vwap,sellVwap:t.vwap,buySlippageBps:e.slippageBps,sellSlippageBps:t.slippageBps})}}}return{...e,notionalUsd:m,execNotionalUsd:Math.round(100*g)/100,grossProfitUsd:Math.round(100*i)/100,netProfitUsd:Math.round(100*s)/100,grossProfitExecUsd:Math.round(e.spreadPct/100*g*100)/100,netProfitExecUsd:Math.round((I??e.netSpreadPct)/100*g*100)/100,fee:{buyTaker:v,sellTaker:O,feePct:M,sourceBuy:_?.[u]?.source??"fallback",sourceSell:_?.[c]?.source??"fallback"},constraints:A?{buy:R?{ok:R.ok,amountMin:R.amountMin,costMin:R.costMin,amountPrecision:R.amountPrecision}:null,sell:N?{ok:N.ok,amountMin:N.amountMin,costMin:N.costMin,amountPrecision:N.amountPrecision}:null}:null,depth:B,netSpreadDepthPct:null!==I?Math.round(1e4*I)/1e4:null,execution:h,readiness:(()=>{let t=new Set;if(D||0!==a.length||t.add("connect_exchange_api"),h?.status==="missing")for(let e of h.blockers??[])t.add(String(e));h?.status==="unknown"&&t.add("execution_data_unavailable");let r=I??e.netSpreadPct,s=Number.isFinite(r)&&r>0,i=k(C("ARB_ACTION_WINDOW_SECS",90),15,600),o=Math.floor(Date.now()/1e3/i),l=k(C("ARB_ACTIONABLE_BASE_PCT",18),1,95)/100,d=Math.max(0,Math.min(.45,(r-.1)*.12)),p=Math.min(.9,l+d),m=function(e){let t=0x811c9dc5;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,0x1000193);return(t>>>0)/0xffffffff}(`${n}:${e.symbol}:${u}:${c}:${o}`)<p;s&&!m&&t.add("execution_window_closed");let b=D?s&&m&&0===t.size:h?.status==="ready"&&0===t.size&&s;return{state:b?"executable":t.size>0?"action_required":"discoverable",canExecute:b,reasons:Array.from(t)}})()}}).filter(e=>!!e),G={};for(let e of R)G[e.symbol]||(G[e.symbol]={}),G[e.symbol][e.exchange]={bid:e.bid,ask:e.ask,ts:e.ts.toISOString()};let V=k(C("ARB_INDEX_MAX_BASES",12),1,50),z=T(i,e=>I(String(e)),V),J=await j(t,z),Z=Math.max(0,C("ARB_INDEX_MIN_DEV_PCT",.25)),Q=(await Promise.all(J.map(async e=>{try{let t=await (0,w.getExternalIndexUsdt)(e.base);if(!t||!Number.isFinite(t.mid)||t.mid<=0)return null;let n=(e.mid-t.mid)/t.mid*100,a=n>=Z?"sell_internal_buy_external":n<=-Z?"buy_internal_sell_external":"none";return{base:e.base,internalSymbol:e.symbol,internalBidUsdt:e.bid,internalAskUsdt:e.ask,internalMidUsdt:e.mid,externalIndexUsdt:t.mid,indexSourcesUsed:t.sourcesUsed,indexSources:(t.sources||[]).map(e=>({exchange:e.exchange,mid:e.mid,ts:e.ts,error:e.error})),dispersionBps:t.dispersionBps,deviationPct:Math.round(1e4*n)/1e4,direction:a,ts:new Date().toISOString()}}catch{return null}}))).filter(e=>!!e);return f.NextResponse.json({ts:new Date().toISOString(),action:r,venues:{connected:a,scanned:s,mode:a.length>0?"connected":"public"},gates:{api:{ok:a.length>0,connectedCount:a.length}},symbols:{enabledCount:i.length,scanned:u,scannedCount:u.length,maxSymbols:o},sizing:{minUsd:d,notionalUsd:m,capUsd:p},external:{banner:0===a.length?{tone:"warning",code:"no_exchange_connections",message:c.find(e=>"no_exchange_connections"===e.error)?.message??"Connect an exchange API"}:null,opportunities:X,prices:G,balances:b,balancesIncluded:!!b,fees:_,depthIncluded:!!S,constraintsIncluded:!!E,errors:"scan"===r?[...c,...M]:c},index:{minDevPct:Z,opportunities:Q}})}catch(t){let e=(0,A.responseForDbError)("exchange.arbitrage.overview",t);if(e)return e;return console.error("[arb.overview] error",t),f.NextResponse.json({error:"internal_error"},{status:500})}}e.s(["GET",()=>K,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],209635);var W=e.i(209635);let X=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/exchange/arbitrage/overview/route",pathname:"/api/exchange/arbitrage/overview",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/arbitrage/overview/route.ts",nextConfigOutput:"",userland:W}),{workAsyncStorage:G,workUnitAsyncStorage:V,serverHooks:z}=X;function J(){return(0,a.patchFetch)({workAsyncStorage:G,workUnitAsyncStorage:V})}async function Z(e,t,a){X.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/exchange/arbitrage/overview/route";f=f.replace(/\/index$/,"")||"/";let y=await X.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:S,params:x,nextConfig:A,parsedUrl:E,isDraftMode:R,prerenderManifest:N,routerServerContext:w,isOnDemandRevalidate:k,revalidateOnlyGenerated:C,resolvedPathname:v,clientReferenceManifest:O,serverActionsManifest:T}=y,M=(0,o.normalizeAppPath)(f),B=!!(N.dynamicRoutes[M]||N.routes[v]),D=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,E,!1):t.end("This page could not be found"),null);if(B&&!R){let e=!!N.routes[v],t=N.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await D();throw new g.NoFallbackError}}let I=null;!B||X.isDev||R||(I="/index"===(I=v)?"/":I);let U=!0===X.isDev||!B,P=B&&!U;T&&O&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:O,serverActionsManifest:T});let L=e.method||"GET",F=(0,s.getTracer)(),H=F.getActiveScopeSpan(),q={params:x,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,a,r)=>X.onRequestError(e,t,a,r,w)},sharedContext:{buildId:S}},$=new l.NodeNextRequest(e),Y=new l.NodeNextResponse(t),j=u.NextRequestAdapter.fromNodeNextRequest($,(0,u.signalFromNodeResponse)(t));try{let i=async e=>X.handle(j,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=F.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=n.get("next.route");if(a){let t=`${L} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${f}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var s,l;let u=async({previousCacheEntry:n})=>{try{if(!o&&k&&C&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(r);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let u=q.renderOpts.collectedTags;if(!B)return await (0,p.sendResponse)($,Y,s,q.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(s.headers);u&&(t[b.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=b.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,a=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=b.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:a}}}}catch(t){throw(null==n?void 0:n.isStale)&&await X.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:k})},!1,w),t}},c=await X.handleResponse({req:e,nextConfig:A,cacheKey:I,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!B)return null;if((null==c||null==(s=c.value)?void 0:s.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",k?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&B||g.delete(b.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,h.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)($,Y,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};H?await l(H):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${L} ${f}`,kind:s.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await X.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:P,isOnDemandRevalidate:k})},!1,w),B)throw t;return await (0,p.sendResponse)($,Y,new Response(null,{status:500})),null}}e.s(["handler",()=>Z,"patchFetch",()=>J,"routeModule",()=>X,"serverHooks",()=>z,"workAsyncStorage",()=>G,"workUnitAsyncStorage",()=>V],477190)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_4815ee83.js.map