{"version":3,"sources":["../../../src/lib/market/indexPrice.ts","../../../src/lib/exchange/fixed3818.ts","../../../src/lib/exchange/gas.ts"],"sourcesContent":["import type { SupportedExchange } from \"../exchange/externalApis\";\r\nimport { getExchangeTicker } from \"../exchange/externalApis\";\r\n\r\nexport type ExternalIndexSource = {\r\n  exchange: SupportedExchange;\r\n  symbol: string; // normalized (e.g. BTCUSDT)\r\n  bid: number | null;\r\n  ask: number | null;\r\n  last: number | null;\r\n  mid: number | null;\r\n  ts: number;\r\n  error?: string;\r\n};\r\n\r\nexport type ExternalIndexQuote = {\r\n  base: string;\r\n  quote: \"USDT\";\r\n  symbol: string; // normalized (e.g. BTCUSDT)\r\n  mid: number;\r\n  sources: ExternalIndexSource[];\r\n  sourcesUsed: number;\r\n  dispersionBps: number | null;\r\n  computedAt: Date;\r\n  validUntil: Date;\r\n};\r\n\r\nfunction clamp(n: number, min: number, max: number) {\r\n  return Math.min(max, Math.max(min, n));\r\n}\r\n\r\nfunction parseNum(v: unknown): number | null {\r\n  const n = typeof v === \"number\" ? v : typeof v === \"string\" ? Number(v) : NaN;\r\n  return Number.isFinite(n) ? n : null;\r\n}\r\n\r\nfunction median(values: number[]): number | null {\r\n  if (!values.length) return null;\r\n  const sorted = [...values].sort((a, b) => a - b);\r\n  const mid = Math.floor(sorted.length / 2);\r\n  if (sorted.length % 2 === 1) return sorted[mid]!;\r\n  return (sorted[mid - 1]! + sorted[mid]!) / 2;\r\n}\r\n\r\nfunction dispersionBpsFrom(values: number[], center: number): number | null {\r\n  if (values.length < 3) return null;\r\n  const sorted = [...values].sort((a, b) => a - b);\r\n  const p10 = sorted[Math.floor((sorted.length - 1) * 0.1)]!;\r\n  const p90 = sorted[Math.floor((sorted.length - 1) * 0.9)]!;\r\n  if (!Number.isFinite(center) || center <= 0) return null;\r\n  return ((p90 - p10) / center) * 10_000;\r\n}\r\n\r\nfunction nowPlusMs(ms: number) {\r\n  return new Date(Date.now() + ms);\r\n}\r\n\r\nfunction normalizeBase(base: string): string {\r\n  return base.trim().toUpperCase();\r\n}\r\n\r\nfunction symbolBaseUsdt(base: string): string {\r\n  return `${normalizeBase(base)}USDT`;\r\n}\r\n\r\nconst DEFAULT_EXCHANGES: SupportedExchange[] = [\r\n  \"binance\",\r\n  \"bybit\",\r\n  \"okx\",\r\n  \"kucoin\",\r\n  \"gateio\",\r\n  \"bitget\",\r\n  \"mexc\",\r\n];\r\n\r\nfunction parseExchangesEnv(): SupportedExchange[] {\r\n  const raw = process.env.MARKETS_INDEX_EXCHANGES;\r\n  if (!raw) return DEFAULT_EXCHANGES;\r\n  const allow = new Set(DEFAULT_EXCHANGES);\r\n  const parts = raw\r\n    .split(/[\\n,]/g)\r\n    .map((s) => s.trim().toLowerCase())\r\n    .filter(Boolean)\r\n    .filter((s) => allow.has(s as SupportedExchange)) as SupportedExchange[];\r\n\r\n  const out: SupportedExchange[] = [];\r\n  const seen = new Set<SupportedExchange>();\r\n  for (const p of parts) {\r\n    if (seen.has(p)) continue;\r\n    seen.add(p);\r\n    out.push(p);\r\n  }\r\n\r\n  return out.length ? out : DEFAULT_EXCHANGES;\r\n}\r\n\r\nfunction ttlMs(): number {\r\n  const raw = process.env.MARKETS_INDEX_TTL_MS;\r\n  const v = raw ? Number(raw) : NaN;\r\n  return clamp(Number.isFinite(v) ? v : 15_000, 2_000, 120_000);\r\n}\r\n\r\nfunction concurrencyLimit(): number {\r\n  const raw = process.env.MARKETS_INDEX_CONCURRENCY;\r\n  const v = raw ? Number(raw) : NaN;\r\n  return clamp(Number.isFinite(v) ? v : 4, 1, 10);\r\n}\r\n\r\nfunction tickerTimeoutMs(): number {\r\n  const raw = process.env.MARKETS_INDEX_TICKER_TIMEOUT_MS ?? process.env.CCXT_TICKER_TIMEOUT_MS;\r\n  const v = raw ? Number(raw) : NaN;\r\n  return clamp(Number.isFinite(v) ? v : 3500, 500, 20_000);\r\n}\r\n\r\nconst cache = new Map<string, ExternalIndexQuote>();\r\n\r\nasync function runWithConcurrency<T>(items: T[], limit: number, worker: (item: T) => Promise<void>): Promise<void> {\r\n  const concurrency = Math.max(1, Math.floor(limit));\r\n  let i = 0;\r\n  const runners = Array.from({ length: Math.min(concurrency, items.length) }, async () => {\r\n    while (true) {\r\n      const idx = i++;\r\n      if (idx >= items.length) return;\r\n      await worker(items[idx]!);\r\n    }\r\n  });\r\n  await Promise.allSettled(runners);\r\n}\r\n\r\nexport async function getExternalIndexUsdt(base: string): Promise<ExternalIndexQuote | null> {\r\n  const baseSym = normalizeBase(base);\r\n  if (!baseSym || baseSym === \"USDT\") return null;\r\n\r\n  const symbol = symbolBaseUsdt(baseSym);\r\n  const cached = cache.get(symbol);\r\n  if (cached && cached.validUntil.getTime() > Date.now()) return cached;\r\n\r\n  const exchanges = parseExchangesEnv();\r\n  const sources: ExternalIndexSource[] = [];\r\n\r\n  const timeout = tickerTimeoutMs();\r\n\r\n  await runWithConcurrency(exchanges, concurrencyLimit(), async (exchange) => {\r\n    try {\r\n      const t = await Promise.race([\r\n        getExchangeTicker(exchange, symbol),\r\n        new Promise<never>((_resolve, reject) =>\r\n          setTimeout(() => reject(new Error(`timeout:getExchangeTicker:${exchange}`)), timeout)\r\n        ),\r\n      ]);\r\n      const bid = parseNum(t.bid);\r\n      const ask = parseNum(t.ask);\r\n      const last = parseNum(t.last);\r\n      const mid = bid && ask ? (bid + ask) / 2 : last;\r\n      sources.push({ exchange, symbol, bid, ask, last, mid, ts: t.ts });\r\n    } catch (e) {\r\n      sources.push({\r\n        exchange,\r\n        symbol,\r\n        bid: null,\r\n        ask: null,\r\n        last: null,\r\n        mid: null,\r\n        ts: Date.now(),\r\n        error: e instanceof Error ? e.message : String(e),\r\n      });\r\n    }\r\n  });\r\n\r\n  const mids = sources.map((s) => s.mid).filter((m): m is number => typeof m === \"number\" && Number.isFinite(m) && m > 0);\r\n  const mid = median(mids);\r\n  if (!mid) return null;\r\n\r\n  const computedAt = new Date();\r\n  const quote: ExternalIndexQuote = {\r\n    base: baseSym,\r\n    quote: \"USDT\",\r\n    symbol,\r\n    mid,\r\n    sources,\r\n    sourcesUsed: mids.length,\r\n    dispersionBps: dispersionBpsFrom(mids, mid),\r\n    computedAt,\r\n    validUntil: nowPlusMs(ttlMs()),\r\n  };\r\n\r\n  cache.set(symbol, quote);\r\n  return quote;\r\n}\r\n","const SCALE = 10n ** 18n;\r\nconst BPS_DENOM = 10_000n;\r\n\r\nexport function toBigInt3818(value: string): bigint {\r\n  const s = value.trim();\r\n  if (s.length === 0) throw new Error(\"empty amount\");\r\n  if (s.startsWith(\"-\")) throw new Error(\"negative amount\");\r\n\r\n  const [intPartRaw, fracPartRaw = \"\"] = s.split(\".\");\r\n  if (!/^(?:0|[1-9]\\d*)$/.test(intPartRaw)) throw new Error(\"invalid integer part\");\r\n  if (fracPartRaw.length > 18) throw new Error(\"too many decimals\");\r\n  if (fracPartRaw.length > 0 && !/^\\d+$/.test(fracPartRaw)) throw new Error(\"invalid fractional part\");\r\n\r\n  const intPart = BigInt(intPartRaw);\r\n  const fracPadded = (fracPartRaw + \"0\".repeat(18)).slice(0, 18);\r\n  const fracPart = fracPadded.length ? BigInt(fracPadded) : 0n;\r\n\r\n  return intPart * SCALE + fracPart;\r\n}\r\n\r\n// Parses numeric(38,18)-style strings that may be negative.\r\n// Use only for fields like balances; do NOT use for user-supplied transfer amounts.\r\nexport function toBigInt3818Signed(value: string): bigint {\r\n  const s = value.trim();\r\n  if (s.length === 0) throw new Error(\"empty amount\");\r\n  const neg = s.startsWith(\"-\");\r\n  const inner = neg ? s.slice(1) : s;\r\n  const abs = toBigInt3818(inner);\r\n  return neg ? -abs : abs;\r\n}\r\n\r\nexport function fromBigInt3818(value: bigint): string {\r\n  if (value < 0n) throw new Error(\"negative amount\");\r\n\r\n  const intPart = value / SCALE;\r\n  const fracPart = value % SCALE;\r\n\r\n  if (fracPart === 0n) return intPart.toString();\r\n\r\n  const fracStr = fracPart.toString().padStart(18, \"0\").replace(/0+$/, \"\");\r\n  return `${intPart.toString()}.${fracStr}`;\r\n}\r\n\r\nexport function cmp3818(a: string, b: string): -1 | 0 | 1 {\r\n  const ai = toBigInt3818(a);\r\n  const bi = toBigInt3818(b);\r\n  if (ai < bi) return -1;\r\n  if (ai > bi) return 1;\r\n  return 0;\r\n}\r\n\r\nexport function min3818(a: string, b: string): string {\r\n  return cmp3818(a, b) <= 0 ? a : b;\r\n}\r\n\r\nexport function isZeroOrLess3818(value: string): boolean {\r\n  // We reject negative values in parser, so this is effectively isZero.\r\n  return toBigInt3818(value) <= 0n;\r\n}\r\n\r\nexport function mul3818Round(a: string, b: string): string {\r\n  const ai = toBigInt3818(a);\r\n  const bi = toBigInt3818(b);\r\n\r\n  // ai and bi are scaled by 1e18. Product is scaled by 1e36.\r\n  const product = ai * bi;\r\n\r\n  // Convert back to 1e18 scale with half-up rounding.\r\n  const q = product / SCALE;\r\n  const r = product % SCALE;\r\n  const rounded = r * 2n >= SCALE ? q + 1n : q;\r\n\r\n  return fromBigInt3818(rounded);\r\n}\r\n\r\nexport function mul3818Ceil(a: string, b: string): string {\r\n  const ai = toBigInt3818(a);\r\n  const bi = toBigInt3818(b);\r\n\r\n  // ai and bi are scaled by 1e18. Product is scaled by 1e36.\r\n  const product = ai * bi;\r\n\r\n  // Convert back to 1e18 scale with ceiling.\r\n  const q = product / SCALE;\r\n  const r = product % SCALE;\r\n  const ceiled = r === 0n ? q : q + 1n;\r\n\r\n  return fromBigInt3818(ceiled);\r\n}\r\n\r\nexport function bpsFeeCeil3818(amount: string, bps: number): string {\r\n  if (!Number.isInteger(bps) || bps < 0) throw new Error(\"invalid bps\");\r\n  if (bps === 0) return \"0\";\r\n\r\n  const ai = toBigInt3818(amount);\r\n  const bi = BigInt(bps);\r\n\r\n  // amount is scaled by 1e18. Multiply by bps then divide by 10_000.\r\n  const num = ai * bi;\r\n  const q = num / BPS_DENOM;\r\n  const r = num % BPS_DENOM;\r\n  const ceiled = r === 0n ? q : q + 1n;\r\n\r\n  return fromBigInt3818(ceiled);\r\n}\r\n\r\nexport function add3818(a: string, b: string): string {\r\n  const ai = toBigInt3818(a);\r\n  const bi = toBigInt3818(b);\r\n  return fromBigInt3818(ai + bi);\r\n}\r\n\r\nexport function sub3818NonNegative(a: string, b: string): string {\r\n  const ai = toBigInt3818(a);\r\n  const bi = toBigInt3818(b);\r\n  if (bi > ai) throw new Error(\"negative result\");\r\n  return fromBigInt3818(ai - bi);\r\n}\r\n","import { fromBigInt3818, sub3818NonNegative, toBigInt3818 } from \"@/lib/exchange/fixed3818\";\r\nimport { getSql } from \"@/lib/db\";\r\nimport { getBscProvider } from \"@/lib/blockchain/wallet\";\r\nimport { ethers } from \"ethers\";\r\nimport { getExternalIndexUsdt } from \"@/lib/market/indexPrice\";\r\n\r\nconst SYSTEM_TREASURY_USER_ID = \"00000000-0000-0000-0000-000000000001\";\r\nconst SYSTEM_BURN_USER_ID = \"00000000-0000-0000-0000-000000000003\";\r\n\r\ntype CacheEntry<T> = { expiresAtMs: number; value: T };\r\nconst _gasCache = new Map<string, CacheEntry<unknown>>();\r\n\r\nfunction cacheGet<T>(key: string): T | null {\r\n  const row = _gasCache.get(key);\r\n  if (!row) return null;\r\n  if (Date.now() > row.expiresAtMs) {\r\n    _gasCache.delete(key);\r\n    return null;\r\n  }\r\n  return row.value as T;\r\n}\r\n\r\nfunction cacheSet<T>(key: string, value: T, ttlMs: number): void {\r\n  _gasCache.set(key, { expiresAtMs: Date.now() + Math.max(0, ttlMs), value });\r\n}\r\n\r\nasync function withTimeout<T>(p: Promise<T>, ms: number, label: string): Promise<T> {\r\n  const timeoutMs = Math.max(0, Math.trunc(ms));\r\n  if (timeoutMs === 0) return await p;\r\n  return await Promise.race([\r\n    p,\r\n    new Promise<T>((_resolve, reject) => {\r\n      const t = setTimeout(() => reject(new Error(`timeout:${label}`)), timeoutMs);\r\n      // Node: don't keep event loop alive for this timer.\r\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n      (t as any).unref?.();\r\n    }),\r\n  ]);\r\n}\r\n\r\nexport type GasChargeError = {\r\n  code:\r\n    | \"gas_disabled\"\r\n    | \"gas_asset_not_found\"\r\n    | \"gas_fee_invalid\"\r\n    | \"insufficient_gas\";\r\n  details?: unknown;\r\n};\r\n\r\nfunction envBool(name: string, fallback: boolean): boolean {\r\n  const raw = process.env[name];\r\n  if (raw == null) return fallback;\r\n  const v = raw.trim().toLowerCase();\r\n  if (v === \"1\" || v === \"true\" || v === \"yes\" || v === \"on\") return true;\r\n  if (v === \"0\" || v === \"false\" || v === \"no\" || v === \"off\") return false;\r\n  return fallback;\r\n}\r\n\r\nfunction envInt(name: string, fallback: number): number {\r\n  const raw = process.env[name];\r\n  const n = raw ? Number(raw) : NaN;\r\n  return Number.isFinite(n) ? Math.trunc(n) : fallback;\r\n}\r\n\r\nfunction envNumber(name: string, fallback: number): number {\r\n  const raw = process.env[name];\r\n  const n = raw ? Number(raw) : NaN;\r\n  return Number.isFinite(n) ? n : fallback;\r\n}\r\n\r\nfunction envAmount3818(name: string, fallback: string): string {\r\n  const raw = process.env[name];\r\n  const v = (raw ?? \"\").trim();\r\n  if (v.length === 0) return fallback;\r\n  // Validate by parsing\r\n  toBigInt3818(v);\r\n  return v;\r\n}\r\n\r\nfunction shouldSponsorGasForAction(action: string): boolean {\r\n  const normalized = action.trim().toLowerCase();\r\n  if (normalized !== \"user_transfer\") return false;\r\n  return envBool(\"GAS_SPONSOR_USER_TRANSFER\", false);\r\n}\r\n\r\nexport type ChargeGasFeeInput = {\r\n  userId: string;\r\n  action: string;\r\n  reference?: string;\r\n  chain?: string;\r\n  assetSymbol?: string;\r\n};\r\n\r\nexport type GasFeeQuoteInput = {\r\n  action: string;\r\n  chain?: string;\r\n  assetSymbol?: string;\r\n  /**\r\n   * display: fast response intended for UI (skip slow price conversion)\r\n   * charge: include chargeAmount when possible (used for actually charging)\r\n   */\r\n  purpose?: \"display\" | \"charge\";\r\n};\r\n\r\nexport type GasFeeQuote = {\r\n  enabled: boolean;\r\n  /** Display symbol for the fee (e.g. native chain token like BNB). */\r\n  gasSymbol: string;\r\n  /** Display amount in gasSymbol. */\r\n  amount: string;\r\n  /** If present, the fee will actually be charged in this asset. */\r\n  chargeSymbol?: string;\r\n  /** If present, the fee will actually be charged in chargeSymbol. */\r\n  chargeAmount?: string;\r\n  mode: \"static\" | \"realtime\";\r\n  burnBps: number;\r\n  details?: Record<string, unknown>;\r\n};\r\n\r\nasync function getAssetId(\r\n  sql: ReturnType<typeof getSql>,\r\n  symbol: string\r\n): Promise<string | null> {\r\n  const rows = await sql<{ id: string }[]>`\r\n    SELECT id::text AS id\r\n    FROM ex_asset\r\n    WHERE chain = 'bsc' AND symbol = ${symbol} AND is_enabled = true\r\n    LIMIT 1\r\n  `;\r\n  return rows[0]?.id ?? null;\r\n}\r\n\r\nasync function ensureLedgerAccount(\r\n  sql: ReturnType<typeof getSql>,\r\n  userId: string,\r\n  assetId: string\r\n): Promise<string> {\r\n  const rows = await sql<{ id: string }[]>`\r\n    INSERT INTO ex_ledger_account (user_id, asset_id)\r\n    VALUES (${userId}::uuid, ${assetId}::uuid)\r\n    ON CONFLICT (user_id, asset_id) DO UPDATE SET user_id = EXCLUDED.user_id\r\n    RETURNING id::text AS id\r\n  `;\r\n  return rows[0]!.id;\r\n}\r\n\r\nasync function ensureSystemUser(sql: ReturnType<typeof getSql>, userId: string): Promise<void> {\r\n  await sql`\r\n    INSERT INTO app_user (id, status, kyc_level, country)\r\n    VALUES (${userId}::uuid, 'active', 'none', NULL)\r\n    ON CONFLICT (id) DO NOTHING\r\n  `;\r\n}\r\n\r\nasync function getAvailablePostedMinusHeld(\r\n  sql: ReturnType<typeof getSql>,\r\n  accountId: string\r\n): Promise<string> {\r\n  const rows = await sql<{ available: string }[]>`\r\n    WITH posted AS (\r\n      SELECT coalesce(sum(amount), 0)::numeric AS posted\r\n      FROM ex_journal_line\r\n      WHERE account_id = ${accountId}::uuid\r\n    ),\r\n    held AS (\r\n      SELECT coalesce(sum(remaining_amount), 0)::numeric AS held\r\n      FROM ex_hold\r\n      WHERE account_id = ${accountId}::uuid\r\n        AND status = 'active'\r\n    )\r\n    SELECT (posted.posted - held.held)::text AS available\r\n    FROM posted, held\r\n  `;\r\n  return rows[0]?.available ?? \"0\";\r\n}\r\n\r\nasync function getLatestPairPrice(\r\n  sql: ReturnType<typeof getSql>,\r\n  baseSymbol: string,\r\n  quoteSymbol: string,\r\n): Promise<number | null> {\r\n  const rows = await sql<\r\n    { price: string; base_symbol: string; quote_symbol: string }[]\r\n  >`\r\n    SELECT\r\n      e.price::text AS price,\r\n      b.symbol AS base_symbol,\r\n      q.symbol AS quote_symbol\r\n    FROM ex_execution e\r\n    JOIN ex_market m ON m.id = e.market_id\r\n    JOIN ex_asset b ON b.id = m.base_asset_id\r\n    JOIN ex_asset q ON q.id = m.quote_asset_id\r\n    WHERE m.chain = 'bsc'\r\n      AND m.status = 'enabled'\r\n      AND (\r\n        (b.symbol = ${baseSymbol} AND q.symbol = ${quoteSymbol})\r\n        OR\r\n        (b.symbol = ${quoteSymbol} AND q.symbol = ${baseSymbol})\r\n      )\r\n    ORDER BY e.created_at DESC, e.id DESC\r\n    LIMIT 1\r\n  `;\r\n\r\n  const row = rows[0];\r\n  if (!row) return null;\r\n  const px = Number(row.price);\r\n  if (!Number.isFinite(px) || px <= 0) return null;\r\n\r\n  if (row.base_symbol === baseSymbol && row.quote_symbol === quoteSymbol) return px;\r\n  if (row.base_symbol === quoteSymbol && row.quote_symbol === baseSymbol) return 1 / px;\r\n  return null;\r\n}\r\n\r\nasync function getUsdtPerUnit(\r\n  sql: ReturnType<typeof getSql>,\r\n  symbol: string,\r\n): Promise<{ usdtPerUnit: number; source: string } | null> {\r\n  const sym = symbol.trim().toUpperCase();\r\n  if (!sym) return null;\r\n  if (sym === \"USDT\") return { usdtPerUnit: 1, source: \"fixed:USDT\" };\r\n\r\n  const cached = cacheGet<{ usdtPerUnit: number; source: string }>(`usdtPerUnit:${sym}`);\r\n  if (cached) return cached;\r\n\r\n  // Prefer internal market executions.\r\n  const internal = await getLatestPairPrice(sql, sym, \"USDT\");\r\n  if (Number.isFinite(internal) && (internal as number) > 0) {\r\n    const v = { usdtPerUnit: internal as number, source: `market:${sym}/USDT` };\r\n    cacheSet(`usdtPerUnit:${sym}`, v, 30_000);\r\n    return v;\r\n  }\r\n\r\n  // External index fallback (not available for USDT).\r\n  // External index fallback can be slow / unavailable.\r\n  try {\r\n    const timeoutMs = envInt(\"GAS_INDEX_TIMEOUT_MS\", 1500);\r\n    const idx = await withTimeout(getExternalIndexUsdt(sym), timeoutMs, `index:${sym}`);\r\n    if (idx?.mid && Number.isFinite(idx.mid) && idx.mid > 0) {\r\n      const v = { usdtPerUnit: idx.mid, source: `index:${sym}USDT` };\r\n      cacheSet(`usdtPerUnit:${sym}`, v, 30_000);\r\n      return v;\r\n    }\r\n  } catch {\r\n    // ignore and fall through\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction normalizeAmount3818(value: number): string {\r\n  if (!Number.isFinite(value) || value <= 0) return \"0\";\r\n  const fixed = value.toFixed(18).replace(/\\.0+$/, \"\").replace(/(\\.\\d*?)0+$/, \"$1\");\r\n  return fixed.length === 0 ? \"0\" : fixed;\r\n}\r\n\r\nasync function estimateRealtimeWithdrawalBnbFee(\r\n  sql: ReturnType<typeof getSql>,\r\n  input: GasFeeQuoteInput,\r\n): Promise<{ bnbAmount: string; details: Record<string, unknown> } | null> {\r\n  if ((input.chain ?? \"bsc\") !== \"bsc\") return null;\r\n  if (input.action !== \"withdrawal_request\" && input.action !== \"user_transfer\") return null;\r\n\r\n  const cacheKey = `bsc:feeData`;\r\n  const cachedFeeData = cacheGet<{ gasPrice?: bigint }>(cacheKey);\r\n  let gasPriceFromProvider: bigint | undefined = cachedFeeData?.gasPrice;\r\n  if (!gasPriceFromProvider) {\r\n    const provider = getBscProvider();\r\n    try {\r\n      const timeoutMs = envInt(\"GAS_PROVIDER_TIMEOUT_MS\", 1500);\r\n      const feeData = await withTimeout(provider.getFeeData(), timeoutMs, \"bsc.getFeeData\");\r\n      gasPriceFromProvider = feeData.gasPrice ?? undefined;\r\n      cacheSet(cacheKey, { gasPrice: gasPriceFromProvider }, 10_000);\r\n    } catch {\r\n      gasPriceFromProvider = undefined;\r\n    }\r\n  }\r\n  const fallbackGwei = Math.max(0.1, envNumber(\"GAS_BSC_FALLBACK_GWEI\", 3));\r\n  const gasPriceWei = gasPriceFromProvider ?? ethers.parseUnits(String(fallbackGwei), \"gwei\");\r\n\r\n  const isNative = (input.assetSymbol ?? \"\").trim().toUpperCase() === \"BNB\";\r\n  const gasUnits = (() => {\r\n    if (input.action === \"user_transfer\") {\r\n      return Math.max(21_000, envInt(\"GAS_BSC_TRANSFER_UNITS\", 45_000));\r\n    }\r\n    return Math.max(\r\n      21_000,\r\n      envInt(isNative ? \"GAS_BSC_NATIVE_UNITS\" : \"GAS_BSC_TOKEN_UNITS\", isNative ? 21_000 : 65_000),\r\n    );\r\n  })();\r\n\r\n  const multiplier = Math.max(1, envNumber(\"GAS_BSC_MULTIPLIER\", 1.15));\r\n  const bnbFee = Number(ethers.formatEther(gasPriceWei * BigInt(gasUnits))) * multiplier;\r\n\r\n  const minBnb = Math.max(0, envNumber(\"GAS_MIN_BNB\", 0));\r\n  const maxBnb = Math.max(minBnb, envNumber(\"GAS_MAX_BNB\", Number.POSITIVE_INFINITY));\r\n  const bnbFinal = Math.min(maxBnb, Math.max(minBnb, bnbFee));\r\n  const bnbAmount = normalizeAmount3818(bnbFinal);\r\n  if (toBigInt3818(bnbAmount) === 0n) return null;\r\n\r\n  return {\r\n    bnbAmount,\r\n    details: {\r\n      gasPriceGwei: Number(ethers.formatUnits(gasPriceWei, \"gwei\")),\r\n      gasUnits,\r\n      multiplier,\r\n      action: input.action,\r\n    },\r\n  };\r\n}\r\n\r\nasync function bnbFeeToChargeInAsset(\r\n  sql: ReturnType<typeof getSql>,\r\n  bnbAmount: string,\r\n  assetSymbol: string,\r\n): Promise<{ chargeSymbol: string; chargeAmount: string; details: Record<string, unknown> } | null> {\r\n  const sym = assetSymbol.trim().toUpperCase();\r\n  if (!sym) return null;\r\n\r\n  const bnbUsdt = await getUsdtPerUnit(sql, \"BNB\");\r\n  if (!bnbUsdt) return null;\r\n\r\n  const assetUsdt = sym === \"BNB\" ? bnbUsdt : await getUsdtPerUnit(sql, sym);\r\n  if (!assetUsdt) return null;\r\n\r\n  const bnb = Number(bnbAmount);\r\n  if (!Number.isFinite(bnb) || bnb <= 0) return null;\r\n\r\n  const feeUsdt = bnb * bnbUsdt.usdtPerUnit;\r\n  const chargeAmountNum = feeUsdt / assetUsdt.usdtPerUnit;\r\n  const chargeAmount = normalizeAmount3818(chargeAmountNum);\r\n  if (toBigInt3818(chargeAmount) === 0n) return null;\r\n\r\n  return {\r\n    chargeSymbol: sym,\r\n    chargeAmount,\r\n    details: {\r\n      bnbUsdt: bnbUsdt.usdtPerUnit,\r\n      bnbUsdtSource: bnbUsdt.source,\r\n      assetUsdt: assetUsdt.usdtPerUnit,\r\n      assetUsdtSource: assetUsdt.source,\r\n      feeUsdt,\r\n      conversion: `${sym} via USDT`,\r\n    },\r\n  };\r\n}\r\n\r\nexport async function quoteGasFee(\r\n  sql: ReturnType<typeof getSql>,\r\n  input: GasFeeQuoteInput,\r\n): Promise<GasFeeQuote | GasChargeError> {\r\n  const purpose: \"display\" | \"charge\" = input.purpose ?? \"charge\";\r\n  const gasEnabled = envBool(\"GAS_ENABLED\", false);\r\n  const legacyGasSymbol = (process.env.GAS_TOKEN_SYMBOL ?? \"BNB\").trim() || \"BNB\";\r\n  const burnBps = Math.max(0, Math.min(10_000, envInt(\"GAS_BURN_BPS\", 25)));\r\n  if (!gasEnabled) {\r\n    // Charging disabled, but still return a stable display estimate (helps UX).\r\n    // For BSC actions we display in native token (BNB).\r\n    const isBnbDisplay = input.action === \"withdrawal_request\" || input.action === \"user_transfer\";\r\n    const gasSymbol = isBnbDisplay ? \"BNB\" : legacyGasSymbol;\r\n\r\n    let amount = \"0\";\r\n    if (isBnbDisplay) {\r\n      const key = input.action === \"user_transfer\" ? \"GAS_USER_TRANSFER_FEE_BNB\" : \"GAS_ACTION_FEE_BNB\";\r\n      const fallbackKey = \"GAS_ACTION_FEE_BNB\";\r\n      try {\r\n        amount = envAmount3818(key, envAmount3818(fallbackKey, \"0\"));\r\n      } catch {\r\n        amount = \"0\";\r\n      }\r\n    }\r\n\r\n    return { enabled: false, gasSymbol, amount, mode: \"static\", burnBps };\r\n  }\r\n\r\n  const feeMode = ((process.env.GAS_FEE_MODE ?? \"realtime\").trim().toLowerCase() === \"static\" ? \"static\" : \"realtime\") as\r\n    | \"static\"\r\n    | \"realtime\";\r\n  const sponsoredIfInsufficient = shouldSponsorGasForAction(input.action);\r\n\r\n  // Withdrawal gas: display in native token (BNB), charge in the withdrawn asset (option B).\r\n  // User transfer gas: same display/charge scheme, but uses transfer-specific gas unit estimate.\r\n  if (input.action === \"withdrawal_request\" || input.action === \"user_transfer\") {\r\n    const displaySymbol = \"BNB\";\r\n    let bnbAmount: string | null = null;\r\n    let details: Record<string, unknown> = { sponsoredIfInsufficient };\r\n    let mode: \"static\" | \"realtime\" = \"static\";\r\n\r\n    if (feeMode === \"realtime\") {\r\n      try {\r\n        const live = await estimateRealtimeWithdrawalBnbFee(sql, input);\r\n        if (live) {\r\n          bnbAmount = live.bnbAmount;\r\n          details = { ...details, ...live.details };\r\n          mode = \"realtime\";\r\n        }\r\n      } catch {\r\n        // fall back to static\r\n      }\r\n    }\r\n\r\n    if (!bnbAmount) {\r\n      const key = input.action === \"user_transfer\" ? \"GAS_USER_TRANSFER_FEE_BNB\" : \"GAS_ACTION_FEE_BNB\";\r\n      const fallbackKey = \"GAS_ACTION_FEE_BNB\";\r\n      try {\r\n        bnbAmount = envAmount3818(key, envAmount3818(fallbackKey, \"0\"));\r\n        details = { ...details, staticEnv: key === fallbackKey ? key : `${key} (fallback: ${fallbackKey})` };\r\n      } catch {\r\n        return { code: \"gas_fee_invalid\", details: { env: key } };\r\n      }\r\n    }\r\n\r\n    if (toBigInt3818(bnbAmount) === 0n) {\r\n      return { enabled: true, gasSymbol: displaySymbol, amount: \"0\", mode, burnBps, details };\r\n    }\r\n\r\n    if (purpose === \"display\") {\r\n      return {\r\n        enabled: true,\r\n        gasSymbol: displaySymbol,\r\n        amount: bnbAmount,\r\n        mode,\r\n        burnBps,\r\n        details: { ...details, conversion: \"skipped_for_display\" },\r\n      };\r\n    }\r\n\r\n    const assetSymbol = (input.assetSymbol ?? \"\").trim();\r\n    if (assetSymbol) {\r\n      const converted = await bnbFeeToChargeInAsset(sql, bnbAmount, assetSymbol);\r\n      if (converted) {\r\n        return {\r\n          enabled: true,\r\n          gasSymbol: displaySymbol,\r\n          amount: bnbAmount,\r\n          chargeSymbol: converted.chargeSymbol,\r\n          chargeAmount: converted.chargeAmount,\r\n          mode,\r\n          burnBps,\r\n          details: { ...details, ...converted.details },\r\n        };\r\n      }\r\n    }\r\n\r\n    return {\r\n      enabled: true,\r\n      gasSymbol: displaySymbol,\r\n      amount: bnbAmount,\r\n      mode,\r\n      burnBps,\r\n      details: { ...details, conversion: \"unavailable\" },\r\n    };\r\n  }\r\n\r\n  const gasSymbol = legacyGasSymbol;\r\n\r\n  let amount: string;\r\n  try {\r\n    amount = envAmount3818(\"GAS_ACTION_FEE_BNB\", \"0\");\r\n  } catch {\r\n    return { code: \"gas_fee_invalid\", details: { env: \"GAS_ACTION_FEE_BNB\" } };\r\n  }\r\n\r\n  return {\r\n    enabled: true,\r\n    gasSymbol,\r\n    amount,\r\n    mode: \"static\",\r\n    burnBps,\r\n    details: { sponsoredIfInsufficient },\r\n  };\r\n}\r\n\r\nexport async function chargeGasFee(\r\n  sql: ReturnType<typeof getSql>,\r\n  input: ChargeGasFeeInput\r\n): Promise<GasChargeError | null> {\r\n  const quote = await quoteGasFee(sql, {\r\n    action: input.action,\r\n    chain: input.chain,\r\n    assetSymbol: input.assetSymbol,\r\n  });\r\n  if (\"code\" in quote) return quote;\r\n  if (!quote.enabled) return null;\r\n\r\n  return await chargeGasFeeFromQuote(sql, input, quote);\r\n}\r\n\r\nexport async function chargeGasFeeFromQuote(\r\n  sql: ReturnType<typeof getSql>,\r\n  input: ChargeGasFeeInput,\r\n  quote: GasFeeQuote,\r\n): Promise<GasChargeError | null> {\r\n  if (!quote.enabled) return null;\r\n\r\n  // Withdrawal fees: display in BNB, charge in the withdrawn asset.\r\n  if (input.action === \"withdrawal_request\") {\r\n    const chargeSymbol = (quote.chargeSymbol ?? input.assetSymbol ?? \"\").trim().toUpperCase();\r\n    const chargeAmount = (quote.chargeAmount ?? \"\").trim();\r\n    if (!chargeSymbol || !chargeAmount) {\r\n      return {\r\n        code: \"gas_fee_invalid\",\r\n        details: {\r\n          message: \"missing_charge_amount\",\r\n          action: input.action,\r\n          gasSymbol: quote.gasSymbol,\r\n          amount: quote.amount,\r\n        },\r\n      };\r\n    }\r\n\r\n    const feeBig = toBigInt3818(chargeAmount);\r\n    if (feeBig === 0n) return null;\r\n\r\n    const burnBps = quote.burnBps;\r\n    const burnBig = (feeBig * BigInt(burnBps)) / 10_000n;\r\n    const treasuryBig = feeBig - burnBig;\r\n\r\n    const assetId = await getAssetId(sql, chargeSymbol);\r\n    if (!assetId) return { code: \"gas_asset_not_found\", details: { symbol: chargeSymbol } };\r\n\r\n    await ensureSystemUser(sql, SYSTEM_TREASURY_USER_ID);\r\n    await ensureSystemUser(sql, SYSTEM_BURN_USER_ID);\r\n\r\n    const [userAcct, treasuryAcct, burnAcct] = await Promise.all([\r\n      ensureLedgerAccount(sql, input.userId, assetId),\r\n      ensureLedgerAccount(sql, SYSTEM_TREASURY_USER_ID, assetId),\r\n      ensureLedgerAccount(sql, SYSTEM_BURN_USER_ID, assetId),\r\n    ]);\r\n\r\n    const available = await getAvailablePostedMinusHeld(sql, userAcct);\r\n    const availableBig = toBigInt3818(available);\r\n    if (availableBig < feeBig) {\r\n      return {\r\n        code: \"insufficient_gas\",\r\n        details: {\r\n          symbol: chargeSymbol,\r\n          required: chargeAmount,\r\n          available,\r\n          action: input.action,\r\n          display: { symbol: quote.gasSymbol, amount: quote.amount },\r\n        },\r\n      };\r\n    }\r\n\r\n    const reference = input.reference ?? input.action;\r\n\r\n    const entryRows = await sql<{ id: string }[]>`\r\n      INSERT INTO ex_journal_entry (type, reference, metadata_json)\r\n      VALUES (\r\n        'gas_fee',\r\n        ${reference},\r\n        ${sql.json({\r\n          action: input.action,\r\n          displaySymbol: quote.gasSymbol,\r\n          displayAmount: quote.amount,\r\n          chargeSymbol,\r\n          chargeAmount,\r\n          burnBps,\r\n          quoteMode: quote.mode,\r\n          quoteDetails: quote.details ?? null,\r\n        } as any)}::jsonb\r\n      )\r\n      RETURNING id::text AS id\r\n    `;\r\n    const entryId = entryRows[0]!.id;\r\n\r\n    const userDelta = fromBigInt3818(feeBig);\r\n    const treasuryDelta = fromBigInt3818(treasuryBig);\r\n    const burnDelta = fromBigInt3818(burnBig);\r\n\r\n    if (treasuryBig > 0n && burnBig > 0n) {\r\n      await sql`\r\n        INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n        VALUES\r\n          (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n          (${entryId}::uuid, ${treasuryAcct}::uuid, ${assetId}::uuid, (${treasuryDelta}::numeric)),\r\n          (${entryId}::uuid, ${burnAcct}::uuid, ${assetId}::uuid, (${burnDelta}::numeric))\r\n      `;\r\n    } else if (treasuryBig > 0n) {\r\n      await sql`\r\n        INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n        VALUES\r\n          (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n          (${entryId}::uuid, ${treasuryAcct}::uuid, ${assetId}::uuid, (${treasuryDelta}::numeric))\r\n      `;\r\n    } else {\r\n      await sql`\r\n        INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n        VALUES\r\n          (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n          (${entryId}::uuid, ${burnAcct}::uuid, ${assetId}::uuid, (${burnDelta}::numeric))\r\n      `;\r\n    }\r\n\r\n    if (burnBig > feeBig) {\r\n      return { code: \"gas_fee_invalid\", details: { message: \"burn exceeds fee\" } };\r\n    }\r\n    sub3818NonNegative(fromBigInt3818(feeBig), fromBigInt3818(treasuryBig + burnBig));\r\n\r\n    return null;\r\n  }\r\n\r\n  const gasSymbol = quote.gasSymbol;\r\n  const feeAmount = quote.amount;\r\n\r\n  const feeBig = toBigInt3818(feeAmount);\r\n  if (feeBig === 0n) return null;\r\n\r\n  const burnBps = quote.burnBps;\r\n  const burnBig = (feeBig * BigInt(burnBps)) / 10_000n;\r\n  const treasuryBig = feeBig - burnBig;\r\n\r\n  const assetId = await getAssetId(sql, gasSymbol);\r\n  if (!assetId) return { code: \"gas_asset_not_found\", details: { symbol: gasSymbol } };\r\n\r\n  // Ensure system users exist for FK integrity.\r\n  await ensureSystemUser(sql, SYSTEM_TREASURY_USER_ID);\r\n  await ensureSystemUser(sql, SYSTEM_BURN_USER_ID);\r\n\r\n  const [userAcct, treasuryAcct, burnAcct] = await Promise.all([\r\n    ensureLedgerAccount(sql, input.userId, assetId),\r\n    ensureLedgerAccount(sql, SYSTEM_TREASURY_USER_ID, assetId),\r\n    ensureLedgerAccount(sql, SYSTEM_BURN_USER_ID, assetId),\r\n  ]);\r\n\r\n  const available = await getAvailablePostedMinusHeld(sql, userAcct);\r\n  const availableBig = toBigInt3818(available);\r\n  if (availableBig < feeBig) {\r\n    if (shouldSponsorGasForAction(input.action)) {\r\n      return null;\r\n    }\r\n    return {\r\n      code: \"insufficient_gas\",\r\n      details: {\r\n        symbol: gasSymbol,\r\n        required: feeAmount,\r\n        available,\r\n        action: input.action,\r\n      },\r\n    };\r\n  }\r\n\r\n  const reference = input.reference ?? input.action;\r\n\r\n  const entryRows = await sql<{ id: string }[]>`\r\n    INSERT INTO ex_journal_entry (type, reference, metadata_json)\r\n    VALUES (\r\n      'gas_fee',\r\n      ${reference},\r\n      ${sql.json({\r\n        action: input.action,\r\n        symbol: gasSymbol,\r\n        feeAmount,\r\n        burnBps,\r\n      })}::jsonb\r\n    )\r\n    RETURNING id::text AS id\r\n  `;\r\n  const entryId = entryRows[0]!.id;\r\n\r\n  const userDelta = fromBigInt3818(feeBig);\r\n  const treasuryDelta = fromBigInt3818(treasuryBig);\r\n  const burnDelta = fromBigInt3818(burnBig);\r\n\r\n  // Double-entry: user pays fee; treasury receives non-burn portion; burn sink receives burned portion.\r\n  // Avoid inserting any zero-amount lines (DB constraint: amount <> 0).\r\n  if (treasuryBig > 0n && burnBig > 0n) {\r\n    await sql`\r\n      INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n      VALUES\r\n        (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n        (${entryId}::uuid, ${treasuryAcct}::uuid, ${assetId}::uuid, (${treasuryDelta}::numeric)),\r\n        (${entryId}::uuid, ${burnAcct}::uuid, ${assetId}::uuid, (${burnDelta}::numeric))\r\n    `;\r\n  } else if (treasuryBig > 0n) {\r\n    await sql`\r\n      INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n      VALUES\r\n        (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n        (${entryId}::uuid, ${treasuryAcct}::uuid, ${assetId}::uuid, (${treasuryDelta}::numeric))\r\n    `;\r\n  } else {\r\n    await sql`\r\n      INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)\r\n      VALUES\r\n        (${entryId}::uuid, ${userAcct}::uuid, ${assetId}::uuid, ((${userDelta}::numeric) * -1)),\r\n        (${entryId}::uuid, ${burnAcct}::uuid, ${assetId}::uuid, (${burnDelta}::numeric))\r\n    `;\r\n  }\r\n\r\n  // Sanity: ensures we didn\\'t underflow due to rounding.\r\n  // (Not strictly required; included as a defensive invariant.)\r\n  if (burnBig > feeBig) {\r\n    return { code: \"gas_fee_invalid\", details: { message: \"burn exceeds fee\" } };\r\n  }\r\n  // Ensure treasury+burn == fee\r\n  // (BigInt math already guarantees it, but keep logic explicit.)\r\n  sub3818NonNegative(fromBigInt3818(feeBig), fromBigInt3818(treasuryBig + burnBig));\r\n\r\n  return null;\r\n}\r\n"],"names":[],"mappings":"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"}