module.exports=[298064,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),i=e.i(759756),o=e.i(561916),n=e.i(174677),l=e.i(869741),d=e.i(316795),s=e.i(487718),u=e.i(995169),c=e.i(47587),_=e.i(666012),h=e.i(570101),m=e.i(626937),p=e.i(10372),y=e.i(193695);e.i(52474);var g=e.i(600220),v=e.i(469719),f=e.i(300959),w=e.i(843793),b=e.i(184883),E=e.i(977775),k=e.i(720290);let R={low:[{weight:840,value:{kind:"badge",code:"daily_spark",rarity:"common",label:"Daily Spark"}},{weight:130,value:{kind:"badge",code:"daily_glint",rarity:"rare",label:"Daily Glint"}},{weight:28,value:{kind:"badge",code:"daily_aura",rarity:"epic",label:"Daily Aura"}},{weight:2,value:{kind:"badge",code:"daily_crown",rarity:"legendary",label:"Daily Crown"}}],medium:[{weight:760,value:{kind:"badge",code:"daily_spark",rarity:"common",label:"Daily Spark"}},{weight:180,value:{kind:"badge",code:"daily_glint",rarity:"rare",label:"Daily Glint"}},{weight:52,value:{kind:"badge",code:"daily_aura",rarity:"epic",label:"Daily Aura"}},{weight:8,value:{kind:"badge",code:"daily_crown",rarity:"legendary",label:"Daily Crown"}}],high:[{weight:650,value:{kind:"badge",code:"daily_spark",rarity:"common",label:"Daily Spark"}},{weight:240,value:{kind:"badge",code:"daily_glint",rarity:"rare",label:"Daily Glint"}},{weight:90,value:{kind:"badge",code:"daily_aura",rarity:"epic",label:"Daily Aura"}},{weight:20,value:{kind:"badge",code:"daily_crown",rarity:"legendary",label:"Daily Crown"}}]};var $=e.i(722316);let C={low:[{weight:8600,value:"common"},{weight:1200,value:"rare"},{weight:180,value:"epic"},{weight:20,value:"legendary"}],medium:[{weight:7800,value:"common"},{weight:1500,value:"rare"},{weight:550,value:"epic"},{weight:150,value:"legendary"}],high:[{weight:7e3,value:"common"},{weight:1900,value:"rare"},{weight:800,value:"epic"},{weight:300,value:"legendary"}]};var A=e.i(273278);let I=v.z.object({action_id:v.z.string().min(1),client_seed:v.z.string().min(8).max(256)});async function T(e){let t,a=(0,E.getActingUserId)(e),r=(0,E.requireActingUserIdInProd)(a);if(r)return(0,f.apiError)(r);if(!a)return(0,f.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=I.parse(i)}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}let o=String(t.action_id).trim(),n=String(t.client_seed).trim(),l=(0,w.getSql)();try{let e=await (0,b.retryOnceOnTransientDbError)(async()=>await l.begin(async e=>{let t,r=await e`
          SELECT id, user_id, module, profile, status, client_commit_hash, server_commit_hash, server_seed_b64,
                 requested_at, resolved_at, input_json, outcome_json
          FROM arcade_action
          WHERE id = ${o}::uuid
          LIMIT 1
        `;if(0===r.length)return{kind:"err",err:(0,f.apiError)("not_found")};let i=r[0];if(i.user_id!==a)return{kind:"err",err:(0,f.apiError)("x_user_id_mismatch")};if("resolved"===i.status)return{kind:"ok",alreadyResolved:!0,action:i,outcome:i.outcome_json};if("committed"!==i.status)return{kind:"err",err:(0,f.apiError)("trade_state_conflict",{details:{status:i.status}})};let l=(0,k.sha256Hex)(n);if(!(0,k.isSha256Hex)(l)||l!==String(i.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,k.sha256Hex)("seasonal_badges"===i.module?`${i.server_seed_b64}:${i.client_commit_hash}:${i.module}:${i.profile}:${a}:season=${String(i.input_json?.season_key??"").trim()}`:`${i.server_seed_b64}:${i.client_commit_hash}:${i.module}:${i.profile}:${a}`)!==String(i.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("internal_error",{details:"server_commit_mismatch"})};let d=[];if("seasonal_badges"===i.module){var s;let r,o,l,u,c,_,h,m,p=String(i.input_json?.season_key??"").trim();if(!p)return{kind:"err",err:(0,f.apiError)("internal_error",{details:"missing_season_key"})};let y=(0,$.seasonalBadgePoolMetaFor)(p),g=(s={actionId:i.id,userId:a,module:i.module,profile:i.profile,serverSeedB64:i.server_seed_b64,clientSeed:n,clientCommitHash:i.client_commit_hash,seasonKey:p},r=(0,$.seasonalBadgePoolMetaFor)(s.seasonKey).badges,o=(0,k.sha256Hex)(`${s.serverSeedB64}:${s.clientSeed}:${s.actionId}:${s.userId}:${s.module}:${s.profile}:${s.clientCommitHash}:season=${s.seasonKey}:rarity`),l=function(e,t){let a=t.reduce((e,t)=>e+t.weight,0),r=Number(e%BigInt(a)),i=0;for(let e of t)if(r<(i+=e.weight))return{picked:e.value,roll:r,total:a};return{picked:t[t.length-1].value,roll:r,total:a}}((0,k.bytesToU64BigInt)(Buffer.from(o.slice(0,16),"hex")),C[s.profile]??C.low),c=(u=r.filter(e=>e.rarity===l.picked)).length?u:r,_=(0,k.sha256Hex)(`${o}:item`),h=(0,k.bytesToU64BigInt)(Buffer.from(_.slice(0,16),"hex")),m=Number(h%BigInt(c.length)),{outcome:c[m]??c[0],audit:{random_hash:_,rarity_roll:l.roll,rarity_total:l.total,item_roll:Number(h%10000n),item_total:1e4}});t=g;let v=`badge_pools:${p}`,w=await e`
            SELECT value_json
            FROM arcade_state
            WHERE user_id = ${a}::uuid
              AND key = ${v}
            LIMIT 1
            FOR UPDATE
          `,b=w[0]?.value_json,E=b&&"object"==typeof b&&!Array.isArray(b)&&b.collected&&"object"==typeof b.collected&&!Array.isArray(b.collected)?b.collected:{},R=b&&"object"==typeof b&&!Array.isArray(b)&&b.unlocked_sets&&"object"==typeof b.unlocked_sets&&!Array.isArray(b.unlocked_sets)?b.unlocked_sets:{};E[String(g.outcome.code)]=!0;let A=[];for(let e of y.sets)!R[e.id]&&e.requiredCodes.every(e=>E[e])&&(R[e.id]=!0,A.push({setId:e.id,key:e.unlockKey}));for(let t of(await e`
            INSERT INTO arcade_state (user_id, key, value_json, created_at, updated_at)
            VALUES (
              ${a}::uuid,
              ${v},
              ${e.json({collected:E,unlocked_sets:R})}::jsonb,
              now(),
              now()
            )
            ON CONFLICT (user_id, key)
            DO UPDATE SET value_json = EXCLUDED.value_json, updated_at = now()
          `,A))d.push({...t.key,set_id:t.setId,season_key:p}),await e`
              INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
              VALUES (
                ${a}::uuid,
                ${t.key.kind},
                ${t.key.code},
                ${t.key.rarity},
                1,
                ${e.json({label:t.key.label,source:i.module,season_key:p,set_id:t.setId})}::jsonb,
                now(),
                now()
              )
              ON CONFLICT (user_id, kind, code, rarity)
              DO NOTHING
            `}else t=function(e){let t=e.profile,a=R[t]??R.low,r=(0,k.sha256Hex)(`${e.serverSeedB64}:${e.clientSeed}:${e.actionId}:${e.userId}:${e.module}:${t}:${e.clientCommitHash}`),{picked:i,roll:o,total:n}=function(e,t){let a=t.reduce((e,t)=>e+t.weight,0),r=Number(e%BigInt(a)),i=0;for(let e of t)if(r<(i+=e.weight))return{picked:e.value,roll:r,total:a};return{picked:t[t.length-1].value,roll:r,total:a}}((0,k.bytesToU64BigInt)(Buffer.from(r.slice(0,16),"hex")),a);return{outcome:i,audit:{random_hash:r,roll:o,total:n}}}({actionId:i.id,userId:a,module:i.module,profile:i.profile,serverSeedB64:i.server_seed_b64,clientSeed:n,clientCommitHash:i.client_commit_hash});let u={module:i.module,profile:i.profile,outcome:t.outcome,audit:{client_commit_hash:i.client_commit_hash,server_commit_hash:i.server_commit_hash,server_seed_b64:i.server_seed_b64,..."seasonal_badges"===i.module?{random_hash:t.audit.random_hash,rarity_roll:t.audit.rarity_roll,rarity_total:t.audit.rarity_total,item_roll:t.audit.item_roll,item_total:t.audit.item_total}:{random_hash:t.audit.random_hash,roll:t.audit.roll,total:t.audit.total}}};return d.length&&(u.unlocks={keys:d}),await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${a}::uuid,
            ${t.outcome.kind},
            ${t.outcome.code},
            ${t.outcome.rarity},
            1,
            ${e.json({label:t.outcome.label,source:i.module})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `,await (0,A.addArcadeXp)(e,{userId:a,deltaXp:1,contextRandomHash:t.audit.random_hash,source:"seasonal_badges"===i.module?"seasonal_badges":"daily_drop"}),await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(u)}
          WHERE id = ${o}::uuid
        `,{kind:"ok",alreadyResolved:!1,action:i,outcome:u}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:o,already_resolved:e.alreadyResolved,result:e.outcome},{status:200})}catch(t){let e=(0,b.responseForDbError)("arcade_daily_reveal",t);if(e)return e;return(0,f.apiError)("internal_error")}}e.s(["POST",()=>T,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],385686);var S=e.i(385686);let x=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/arcade/daily/reveal/route",pathname:"/api/arcade/daily/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/daily/reveal/route.ts",nextConfigOutput:"",userland:S}),{workAsyncStorage:N,workUnitAsyncStorage:O,serverHooks:D}=x;function j(){return(0,r.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:O})}async function H(e,t,r){x.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/arcade/daily/reveal/route";v=v.replace(/\/index$/,"")||"/";let f=await x.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:b,nextConfig:E,parsedUrl:k,isDraftMode:R,prerenderManifest:$,routerServerContext:C,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,resolvedPathname:T,clientReferenceManifest:S,serverActionsManifest:N}=f,O=(0,l.normalizeAppPath)(v),D=!!($.dynamicRoutes[O]||$.routes[T]),j=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,k,!1):t.end("This page could not be found"),null);if(D&&!R){let e=!!$.routes[T],t=$.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(E.experimental.adapterPath)return await j();throw new y.NoFallbackError}}let H=null;!D||x.isDev||R||(H="/index"===(H=T)?"/":H);let P=!0===x.isDev||!D,U=D&&!P;N&&S&&(0,n.setManifestsSingleton)({page:v,clientReferenceManifest:S,serverActionsManifest:N});let q=e.method||"GET",B=(0,o.getTracer)(),L=B.getActiveScopeSpan(),M={params:b,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!E.experimental.authInterrupts},cacheComponents:!!E.cacheComponents,supportsDynamicResponse:P,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:E.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>x.onRequestError(e,t,r,i,C)},sharedContext:{buildId:w}},F=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),G=s.NextRequestAdapter.fromNodeNextRequest(F,(0,s.signalFromNodeResponse)(t));try{let n=async e=>x.handle(G,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=B.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${v}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let s=async({previousCacheEntry:a})=>{try{if(!l&&A&&I&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(i);e.fetchMetrics=M.renderOpts.fetchMetrics;let d=M.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let s=M.renderOpts.collectedTags;if(!D)return await (0,_.sendResponse)(F,K,o,M.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);s&&(t[p.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=p.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,r=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=p.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},!1,C),t}},u=await x.handleResponse({req:e,nextConfig:E,cacheKey:H,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:I,responseGenerator:s,waitUntil:r.waitUntil,isMinimalMode:l});if(!D)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),R&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&D||y.delete(p.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,_.sendResponse)(F,K,new Response(u.value.body,{headers:y,status:u.value.status||200})),null};L?await d(L):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${v}`,kind:o.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:A})},!1,C),D)throw t;return await (0,_.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>j,"routeModule",()=>x,"serverHooks",()=>D,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>O],298064)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0cfc81f2.js.map