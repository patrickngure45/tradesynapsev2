module.exports=[289156,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),s=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),c=e.i(47587),p=e.i(666012),h=e.i(570101),m=e.i(626937),_=e.i(10372),v=e.i(193695);e.i(52474);var f=e.i(600220),g=e.i(469719),E=e.i(300959),w=e.i(843793),R=e.i(184883),y=e.i(977775),A=e.i(720290),x=e.i(796929),b=e.i(60828),C=e.i(273278),k=e.i(363909);let O={low:[{weight:9200,value:"common"},{weight:700,value:"rare"},{weight:90,value:"epic"},{weight:10,value:"legendary"}],medium:[{weight:8600,value:"common"},{weight:1050,value:"rare"},{weight:280,value:"epic"},{weight:70,value:"legendary"}],high:[{weight:7800,value:"common"},{weight:1400,value:"rare"},{weight:600,value:"epic"},{weight:200,value:"legendary"}]};async function T(e){var t;if(!(process.env.GROQ_API_KEY??"").trim())return{text:"AI offline â€” configure GROQ_API_KEY to enable AI Oracle."};let r=await k.groq.chat.completions.create({model:"llama-3.3-70b-versatile",temperature:0,messages:[{role:"system",content:"legendary"===(t=e.tier)?"You are the Citadel AI Oracle.\nGenerate a structured, reusable TEMPLATE the user can copy/paste for future analysis.\nOutput in Markdown with the following exact sections:\n1) Summary (2-3 lines)\n2) Checklist (5-9 bullets)\n3) Red flags (3-6 bullets)\n4) Next steps (3-6 bullets)\nRules:\n- Be practical and conservative.\n- Do not provide financial advice.\n- Do not claim guarantees.":"epic"===t?"You are the Citadel AI Oracle.\nProvide a detailed playbook-style response.\nOutput in Markdown with sections and short bullets.\nRules:\n- Be practical and conservative.\n- Do not provide financial advice.\n- Avoid absolute language like 'guaranteed'.":"rare"===t?"You are the Citadel AI Oracle.\nProvide a concise answer AND include a small reusable checklist template.\nOutput in Markdown.\nRules:\n- Be practical and conservative.\n- Do not provide financial advice.":"You are the Citadel AI Oracle.\nProvide a short, actionable answer in 4-8 bullets.\nRules:\n- Be practical and conservative.\n- Do not provide financial advice."},{role:"user",content:e.prompt}]});return{text:(r.choices[0]?.message?.content??"").trim()||"AI response unavailable."}}let I=g.z.object({action_id:g.z.string().uuid(),client_seed:g.z.string().min(8).max(256),prompt:g.z.string().min(10).max(800)}),S="ai_oracle",$="shard",N="arcade_shard",P="common";async function H(e){let t,r=(0,y.getActingUserId)(e),a=(0,y.requireActingUserIdInProd)(r);if(a)return(0,E.apiError)(a);if(!r)return(0,E.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=I.parse(i)}catch(e){return(0,E.apiZodError)(e)??(0,E.apiError)("invalid_input")}let n=t.action_id,o=String(t.client_seed??"").trim(),s=String(t.prompt??"").trim(),l=(0,A.sha256Hex)(s),d=(0,w.getSql)();try{let e=await (0,R.retryOnceOnTransientDbError)(async()=>await d.begin(async e=>{var t,a;let i,d,u,c=await (0,x.enforceArcadeSafety)(e,{userId:r,module:S,shardSpend:5});if(!c.ok)return{kind:"err",err:(0,E.apiError)(c.error,{details:c.details})};let p=await e`
          SELECT
            id::text AS id,
            user_id::text AS user_id,
            module,
            profile,
            status,
            client_commit_hash,
            server_commit_hash,
            server_seed_b64,
            input_json,
            outcome_json
          FROM arcade_action
          WHERE id = ${n}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(!p.length)return{kind:"err",err:(0,E.apiError)("not_found")};let h=p[0];if(h.user_id!==r)return{kind:"err",err:(0,E.apiError)("x_user_id_mismatch")};if(h.module!==S)return{kind:"err",err:(0,E.apiError)("invalid_input")};if("resolved"===h.status)return{kind:"ok",already:!0,outcome:h.outcome_json};if("committed"!==h.status)return{kind:"err",err:(0,E.apiError)("trade_state_conflict",{details:{status:h.status}})};let m=(0,A.sha256Hex)(o);if(!(0,A.isSha256Hex)(m)||m!==String(h.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,E.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,A.sha256Hex)(`${h.server_seed_b64}:${h.client_commit_hash}:${h.module}:${h.profile}:${r}:prompt=${l}`)!==String(h.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,E.apiError)("invalid_input",{details:"prompt does not match commit"})};let _=String(h.input_json?.prompt_hash??"").trim();if(_&&_!==l)return{kind:"err",err:(0,E.apiError)("invalid_input",{details:"prompt_hash_mismatch"})};let v=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${$}
            AND code = ${N}
            AND rarity = ${P}
          LIMIT 1
          FOR UPDATE
        `,f=Number(v[0]?.quantity??0);if(f<5)return{kind:"err",err:(0,E.apiError)("insufficient_balance",{details:{message:"Need 5 shards to ask the Oracle."}})};let g=(t={actionId:h.id,userId:r,module:h.module,profile:h.profile,serverSeedB64:h.server_seed_b64,clientSeed:o,clientCommitHash:h.client_commit_hash,promptHash:l},i=(0,A.sha256Hex)(`${t.serverSeedB64}:${t.clientSeed}:${t.actionId}:${t.userId}:${t.module}:${t.profile}:${t.clientCommitHash}:prompt=${t.promptHash}:tier`),{tier:(d=function(e,t){let r=t.reduce((e,t)=>e+t.weight,0),a=Number(e%BigInt(r)),i=0;for(let e of t)if(a<(i+=e.weight))return{picked:e.value,roll:a,total:r};return{picked:t[t.length-1].value,roll:a,total:r}}((0,A.bytesToU64BigInt)(Buffer.from(i.slice(0,16),"hex")),O[t.profile]??O.low)).picked,audit:{random_hash:i,roll:d.roll,total:d.total}}),w=await T({prompt:s,tier:g.tier}),R=v[0].id,y=f-5;0===y?await e`DELETE FROM arcade_inventory WHERE id = ${R}::uuid`:await e`UPDATE arcade_inventory SET quantity = ${y}, updated_at = now() WHERE id = ${R}::uuid`,await (0,b.logArcadeConsumption)(e,{user_id:r,kind:$,code:N,rarity:P,quantity:5,context_type:S,context_id:h.id,module:S,metadata:{cost_shards:5}});let k=(a=w.text,(u=String(a??"")).length>8e3?u.slice(0,8e3):u),I=null;if("common"!==g.tier){let t=g.tier,a=`ai_template_${h.id}`;I={kind:"insight",code:a,rarity:t,label:`AI Template (${t})`},await e`
            INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
            VALUES (
              ${r}::uuid,
              ${I.kind},
              ${I.code},
              ${I.rarity},
              1,
              ${e.json({label:I.label,source:S,prompt_hash:l,prompt_preview:String(h.input_json?.prompt_preview??""),tier:g.tier,response_preview:k.slice(0,240)})},
              now(),
              now()
            )
            ON CONFLICT (user_id, kind, code, rarity)
            DO NOTHING
          `}let H={module:h.module,profile:h.profile,cost_shards:5,tier:g.tier,response_text:k,collectible:I,audit:{client_commit_hash:h.client_commit_hash,server_commit_hash:h.server_commit_hash,server_seed_b64:h.server_seed_b64,random_hash:g.audit.random_hash,roll:g.audit.roll,total:g.audit.total}};return await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(H)}
          WHERE id = ${h.id}::uuid
        `,await (0,C.addArcadeXp)(e,{userId:r,deltaXp:1,contextRandomHash:g.audit.random_hash,source:S}),{kind:"ok",already:!1,outcome:H}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:n,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,R.responseForDbError)("arcade_ai_oracle_reveal",t);if(e)return e;return(0,E.apiError)("internal_error")}}e.s(["POST",()=>H,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],310409);var D=e.i(310409);let U=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/ai/reveal/route",pathname:"/api/arcade/ai/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/ai/reveal/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:j,workUnitAsyncStorage:q,serverHooks:M}=U;function F(){return(0,a.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:q})}async function L(e,t,a){U.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/arcade/ai/reveal/route";g=g.replace(/\/index$/,"")||"/";let E=await U.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:R,nextConfig:y,parsedUrl:A,isDraftMode:x,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:k,revalidateOnlyGenerated:O,resolvedPathname:T,clientReferenceManifest:I,serverActionsManifest:S}=E,$=(0,s.normalizeAppPath)(g),N=!!(b.dynamicRoutes[$]||b.routes[T]),P=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,A,!1):t.end("This page could not be found"),null);if(N&&!x){let e=!!b.routes[T],t=b.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await P();throw new v.NoFallbackError}}let H=null;!N||U.isDev||x||(H="/index"===(H=T)?"/":H);let D=!0===U.isDev||!N,j=N&&!D;S&&I&&(0,o.setManifestsSingleton)({page:g,clientReferenceManifest:I,serverActionsManifest:S});let q=e.method||"GET",M=(0,n.getTracer)(),F=M.getActiveScopeSpan(),L={params:R,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>U.onRequestError(e,t,a,i,C)},sharedContext:{buildId:w}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),G=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let o=async e=>U.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${g}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&k&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!N)return await (0,p.sendResponse)(B,K,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:k})},!1,C),t}},u=await U.handleResponse({req:e,nextConfig:y,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:k,revalidateOnlyGenerated:O,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:s});if(!N)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",k?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&N||v.delete(_.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(B,K,new Response(u.value.body,{headers:v,status:u.value.status||200})),null};F?await l(F):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${g}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof v.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:k})},!1,C),N)throw t;return await (0,p.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>L,"patchFetch",()=>F,"routeModule",()=>U,"serverHooks",()=>M,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>q],289156)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_012296aa.js.map