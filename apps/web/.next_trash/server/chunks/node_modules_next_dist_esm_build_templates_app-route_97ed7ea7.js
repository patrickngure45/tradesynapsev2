module.exports=[835068,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),o=e.i(561916),i=e.i(174677),s=e.i(869741),d=e.i(316795),u=e.i(487718),l=e.i(995169),c=e.i(47587),p=e.i(666012),h=e.i(570101),_=e.i(626937),f=e.i(10372),m=e.i(193695);e.i(52474);var g=e.i(600220),x=e.i(469719),R=e.i(843793),E=e.i(300959),v=e.i(184883),w=e.i(977775),y=e.i(569442),b=e.i(901323),T=e.i(831075),S=e.i(90878),C=e.i(371276);let A=null,N=x.z.object({chain:x.z.literal("bsc").optional().default("bsc"),tx_hash:x.z.string().min(10),confirmations:x.z.number().int().min(0).max(200).optional()});function k(e){return String(e||"").trim().toLowerCase()}async function P(e,t){let r=String(t??"").trim();if(!r)return null;try{let t=await e.getCode(r);return"0x"!==String(t).toLowerCase()}catch{return null}}function O(e){return String(e||"").split(",").map(e=>e.trim().toUpperCase()).filter(Boolean)}async function I(e){let t=Date.now(),r=(0,w.getActingUserId)(e),a=(0,w.requireActingUserIdInProd)(r),n=(a,n)=>{try{(0,C.logRouteResponse)(e,a,{startMs:t,userId:r,meta:n})}catch{}return a};if(a)return n((0,E.apiError)(a,{status:401}),{code:a});if(!r)return n((0,E.apiError)("unauthorized",{status:401}),{code:"unauthorized"});let o=(0,R.getSql)();try{let t,a;try{if(!(await (function(e){if(A)return A;let t=Number(String(process.env.EXCHANGE_DEPOSIT_REPORT_MAX_PER_MIN??"10").trim()),r=Number.isFinite(t)&&t>0?Math.trunc(t):10;return A=(0,T.createPgRateLimiter)(e,{name:"exchange-deposit-report",windowMs:6e4,max:r})})(o).consume(`u:${r}`)).allowed)return n((0,E.apiError)("rate_limit_exceeded",{status:429}),{code:"rate_limit_exceeded"})}catch{}let i=await e.json().catch(()=>({}));try{t=N.parse(i)}catch(e){return n((0,E.apiZodError)(e)??(0,E.apiError)("invalid_input",{status:400}),{code:"invalid_input"})}try{let a=(0,S.auditContextFromRequest)(e);await (0,S.writeAuditLog)(o,{actorId:r,actorType:"user",action:"exchange.deposits.report",resourceType:"deposit_report",resourceId:String(t.tx_hash??"").trim()||null,ip:a.ip,userAgent:a.userAgent,requestId:a.requestId,detail:{chain:t.chain,tx_hash:String(t.tx_hash??"").trim(),confirmations:t.confirmations??null}})}catch{}let s=String(t.tx_hash||"").trim();if(a=String(s||"").trim(),!/^0x[0-9a-fA-F]{64}$/.test(a))return n((0,E.apiError)("invalid_tx_hash",{status:400}),{code:"invalid_tx_hash"});let d=await o`
      SELECT address
      FROM ex_deposit_address
      WHERE chain = 'bsc'
        AND status = 'active'
        AND user_id = ${r}::uuid
      ORDER BY created_at DESC
      LIMIT 1
    `,u=d[0]?.address?k(d[0].address):"";if(!u)return n((0,E.apiError)("deposit_address_missing",{status:400}),{code:"deposit_address_missing"});let l=(0,b.getBscReadProvider)(),c=await l.getTransaction(s);if(!c)return n((0,E.apiError)("tx_not_found",{status:404,details:{tx_hash:s}}),{code:"tx_not_found"});let p=await l.getTransactionReceipt(s).catch(()=>null),h="number"==typeof p?.status?p.status:null;if(0===h)return n((0,E.apiError)("tx_failed",{status:400,details:{tx_hash:s,message:"This transaction reverted on-chain (status=0), so it did not complete."}}),{code:"tx_failed"});let _=c.to?k(c.to):"",f="bigint"==typeof c?.value?c.value:0n;if(_&&_===u){let e=await (0,y.ingestNativeBnbDepositTx)(o,{txHash:s,confirmations:t.confirmations});if(!e.ok){let t="tx_not_confirmed"===e.error?202:"tx_not_found"===e.error?404:400;return n((0,E.apiError)(e.error,{status:t,details:e.details??{tx_hash:s}}),{code:e.error})}if(String(e.userId)!==String(r))return n((0,E.apiError)("tx_to_not_your_deposit_address",{status:400,details:{to_address:e.toAddress}}),{code:"tx_to_not_your_deposit_address"});let a=Response.json({ok:!0,chain:e.chain,tx_hash:e.txHash,block_number:e.blockNumber,confirmations_required:e.confirmations,safe_tip:e.safeTip,to_address:e.toAddress,credits:[{asset_symbol:e.assetSymbol,amount:e.amount,outcome:e.outcome}]});return n(a,{ok:!0,chain:e.chain,kind:"native"})}if(_&&f>0n)return n((0,E.apiError)("tx_to_not_your_deposit_address",{status:400,details:{to_address:_,expected_deposit_address:u,value_wei:f.toString(),message:"This transaction sent native BNB to a different address. Direct BNB deposits must be sent to your deposit address."}}),{code:"tx_to_not_your_deposit_address"});let m=(()=>{let e=O(String(process.env.DEPOSIT_SCAN_SYMBOLS??""));if(e.length)return e;let t=O(String(process.env.BSC_REPORT_TOKEN_SYMBOLS??""));return t.length?t:[]})(),g=await (0,y.ingestBscTokenDepositTx)(o,{txHash:s,userId:r,depositAddress:u,confirmations:t.confirmations,...m.length?{tokenSymbols:m}:{}});if(!g.ok){let e="tx_not_confirmed"===g.error?202:"tx_not_found"===g.error?404:400,t=c?.to?await P(l,c.to):null,r=g.details??{tx_hash:s},a=(()=>{switch(g.error){case"tx_not_found":return"Transaction receipt not found yet. If you just broadcast it, wait a bit and try again.";case"tx_not_confirmed":return"Transaction is not confirmed yet. Wait for confirmations and try again.";case"tx_failed":return"This transaction failed/reverted on-chain, so it cannot be credited.";case"token_asset_not_enabled":return"Token deposits are not enabled for the supported symbols on this server.";case"no_matching_token_transfers":return!0===t?"This transaction is a contract interaction and has no supported token Transfer logs to your deposit address. If you used a swap/bridge, ensure the final Transfer goes to your deposit address.":"No supported token Transfer logs to your deposit address were found in this transaction.";default:return null}})();return n((0,E.apiError)(g.error,{status:e,details:{...r,...a?{message:a}:{},...null!=t?{tx_to_is_contract:t}:{}}}),{code:g.error})}let x=Response.json({ok:!0,chain:g.chain,tx_hash:g.txHash,block_number:g.blockNumber,confirmations_required:g.confirmations,safe_tip:g.safeTip,to_address:g.depositAddress,credits:g.credits.map(e=>({asset_symbol:e.assetSymbol,amount:e.amount,outcome:e.outcome}))});return n(x,{ok:!0,chain:g.chain,kind:"token",credits:g.credits.length})}catch(t){let e=(0,v.responseForDbError)("exchange.deposits.report",t);if(e)return n(e,{code:"db_error"});throw t}}e.s(["POST",()=>I,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],378584);var D=e.i(378584);let q=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/exchange/deposits/report/route",pathname:"/api/exchange/deposits/report",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/deposits/report/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:H,workUnitAsyncStorage:M,serverHooks:U}=q;function B(){return(0,a.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:M})}async function j(e,t,a){q.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/exchange/deposits/report/route";x=x.replace(/\/index$/,"")||"/";let R=await q.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:v,nextConfig:w,parsedUrl:y,isDraftMode:b,prerenderManifest:T,routerServerContext:S,isOnDemandRevalidate:C,revalidateOnlyGenerated:A,resolvedPathname:N,clientReferenceManifest:k,serverActionsManifest:P}=R,O=(0,s.normalizeAppPath)(x),I=!!(T.dynamicRoutes[O]||T.routes[N]),D=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,y,!1):t.end("This page could not be found"),null);if(I&&!b){let e=!!T.routes[N],t=T.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await D();throw new m.NoFallbackError}}let H=null;!I||q.isDev||b||(H="/index"===(H=N)?"/":H);let M=!0===q.isDev||!I,U=I&&!M;P&&k&&(0,i.setManifestsSingleton)({page:x,clientReferenceManifest:k,serverActionsManifest:P});let B=e.method||"GET",j=(0,o.getTracer)(),F=j.getActiveScopeSpan(),L={params:v,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>q.onRequestError(e,t,a,n,S)},sharedContext:{buildId:E}},$=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),z=u.NextRequestAdapter.fromNodeNextRequest($,(0,u.signalFromNodeResponse)(t));try{let i=async e=>q.handle(z,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${B} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${B} ${x}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var o,d;let u=async({previousCacheEntry:r})=>{try{if(!s&&C&&A&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(n);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let u=L.renderOpts.collectedTags;if(!I)return await (0,p.sendResponse)($,K,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await q.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,S),t}},l=await q.handleResponse({req:e,nextConfig:w,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:A,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:s});if(!I)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&I||m.delete(f.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,_.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)($,K,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};F?await d(F):await j.withPropagatedContext(e.headers,()=>j.trace(l.BaseServerSpan.handleRequest,{spanName:`${B} ${x}`,kind:o.SpanKind.SERVER,attributes:{"http.method":B,"http.target":e.url}},d))}catch(t){if(t instanceof m.NoFallbackError||await q.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},!1,S),I)throw t;return await (0,p.sendResponse)($,K,new Response(null,{status:500})),null}}e.s(["handler",()=>j,"patchFetch",()=>B,"routeModule",()=>q,"serverHooks",()=>U,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>M],835068)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_97ed7ea7.js.map