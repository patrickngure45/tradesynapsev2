module.exports=[496585,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),d=e.i(869741),s=e.i(316795),u=e.i(487718),l=e.i(995169),c=e.i(47587),p=e.i(666012),_=e.i(570101),m=e.i(626937),E=e.i(10372),h=e.i(193695);e.i(52474);var R=e.i(600220),v=e.i(469719),f=e.i(300959),y=e.i(843793),w=e.i(184883),A=e.i(977775),g=e.i(720290),T=e.i(66137),S=e.i(533821),x=e.i(60828),C=e.i(273278),k=e.i(796929);let b=v.z.object({action_id:v.z.string().uuid(),client_seed:v.z.string().min(8).max(256)}),D="mutation";async function I(e){let t,r=(0,A.getActingUserId)(e),a=(0,A.requireActingUserIdInProd)(r);if(a)return(0,f.apiError)(a);if(!r)return(0,f.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=b.parse(i)}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}let n=t.action_id,o=String(t.client_seed??"").trim(),d=(0,y.getSql)();try{let e=await (0,w.retryOnceOnTransientDbError)(async()=>await d.begin(async e=>{let t=await (0,k.enforceArcadeSafety)(e,{userId:r,module:D,shardSpend:15});if(!t.ok)return{kind:"err",err:(0,f.apiError)(t.error,{details:t.details})};let a=await e`
          SELECT
            id::text AS id,
            user_id::text AS user_id,
            module,
            profile,
            status,
            client_commit_hash,
            server_commit_hash,
            server_seed_b64,
            input_json,
            outcome_json
          FROM arcade_action
          WHERE id = ${n}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(!a.length)return{kind:"err",err:(0,f.apiError)("not_found")};let i=a[0];if(i.user_id!==r)return{kind:"err",err:(0,f.apiError)("x_user_id_mismatch")};if(i.module!==D)return{kind:"err",err:(0,f.apiError)("invalid_input")};if("resolved"===i.status)return{kind:"ok",already:!0,outcome:i.outcome_json};if("committed"!==i.status)return{kind:"err",err:(0,f.apiError)("trade_state_conflict",{details:{status:i.status}})};let d=(0,g.sha256Hex)(o);if(!(0,g.isSha256Hex)(d)||d!==String(i.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,g.sha256Hex)(`${i.server_seed_b64}:${i.client_commit_hash}:${i.module}:${i.profile}:${r}`)!==String(i.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("internal_error",{details:"server_commit_mismatch"})};let s=i.input_json?.item,u=String(s?.kind??"").trim(),l=String(s?.code??"").trim(),c=String(s?.rarity??"").trim();if("cosmetic"!==u||!l||!c)return{kind:"err",err:(0,f.apiError)("internal_error",{details:"invalid_action_input"})};let p=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${u}
            AND code = ${l}
            AND rarity = ${c}
          LIMIT 1
          FOR UPDATE
        `;if(!p.length)return{kind:"err",err:(0,f.apiError)("not_found")};if(1>Number(p[0].quantity??0))return{kind:"err",err:(0,f.apiError)("insufficient_balance")};let _=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${S.SHARD_ITEM.kind}
            AND code = ${S.SHARD_ITEM.code}
            AND rarity = ${S.SHARD_ITEM.rarity}
          LIMIT 1
          FOR UPDATE
        `,m=Number(_[0]?.quantity??0);if(m<15)return{kind:"err",err:(0,f.apiError)("insufficient_balance",{details:{message:"Need 15 shards to mutate."}})};let E=(0,T.resolveMutation)({actionId:i.id,userId:r,module:i.module,profile:i.profile,serverSeedB64:i.server_seed_b64,clientSeed:o,clientCommitHash:i.client_commit_hash,input:{code:l,rarity:c}}),h=p[0].id,R=Number(p[0].quantity)-1;0===R?await e`
            DELETE FROM arcade_inventory
            WHERE id = ${h}::uuid
          `:await e`
            UPDATE arcade_inventory
            SET quantity = ${R}, updated_at = now()
            WHERE id = ${h}::uuid
          `,await (0,x.logArcadeConsumption)(e,{user_id:r,kind:u,code:l,rarity:c,quantity:1,context_type:"mutation_input",context_id:i.id,module:D,metadata:{consumed:!0}});let v=_[0].id,y=m-15;0===y?await e`
            DELETE FROM arcade_inventory
            WHERE id = ${v}::uuid
          `:await e`
            UPDATE arcade_inventory
            SET quantity = ${y}, updated_at = now()
            WHERE id = ${v}::uuid
          `,await (0,x.logArcadeConsumption)(e,{user_id:r,kind:S.SHARD_ITEM.kind,code:S.SHARD_ITEM.code,rarity:S.SHARD_ITEM.rarity,quantity:15,context_type:"mutation_cost",context_id:i.id,module:D,metadata:{cost_shards:15}}),await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${r}::uuid,
            ${E.outcome.kind},
            ${E.outcome.code},
            ${E.outcome.rarity},
            1,
            ${e.json({label:E.outcome.label,...E.outcome.metadata,source:D,action_id:i.id})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `;let w={module:i.module,profile:i.profile,input:{kind:u,code:l,rarity:c},outcome:E.outcome,audit:{client_commit_hash:i.client_commit_hash,server_commit_hash:i.server_commit_hash,server_seed_b64:i.server_seed_b64,random_hash:E.audit.random_hash,roll:E.audit.roll,total:E.audit.total,upgraded:E.audit.upgraded}};return await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(w)}
          WHERE id = ${i.id}::uuid
        `,await (0,C.addArcadeXp)(e,{userId:r,deltaXp:2,contextRandomHash:E.audit.random_hash,source:D}),{kind:"ok",already:!1,outcome:w}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:n,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,w.responseForDbError)("arcade_mutation_reveal",t);if(e)return e;return(0,f.apiError)("internal_error")}}e.s(["POST",()=>I,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],668975);var N=e.i(668975);let $=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/mutation/reveal/route",pathname:"/api/arcade/mutation/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/mutation/reveal/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:H,workUnitAsyncStorage:O,serverHooks:P}=$;function q(){return(0,a.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:O})}async function M(e,t,a){$.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let v="/api/arcade/mutation/reveal/route";v=v.replace(/\/index$/,"")||"/";let f=await $.prepare(e,t,{srcPage:v,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:w,nextConfig:A,parsedUrl:g,isDraftMode:T,prerenderManifest:S,routerServerContext:x,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,resolvedPathname:b,clientReferenceManifest:D,serverActionsManifest:I}=f,N=(0,d.normalizeAppPath)(v),H=!!(S.dynamicRoutes[N]||S.routes[b]),O=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,g,!1):t.end("This page could not be found"),null);if(H&&!T){let e=!!S.routes[b],t=S.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await O();throw new h.NoFallbackError}}let P=null;!H||$.isDev||T||(P="/index"===(P=b)?"/":P);let q=!0===$.isDev||!H,M=H&&!q;I&&D&&(0,o.setManifestsSingleton)({page:v,clientReferenceManifest:D,serverActionsManifest:I});let U=e.method||"GET",j=(0,n.getTracer)(),F=j.getActiveScopeSpan(),L={params:w,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>$.onRequestError(e,t,a,i,x)},sharedContext:{buildId:y}},W=new s.NodeNextRequest(e),K=new s.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(W,(0,u.signalFromNodeResponse)(t));try{let o=async e=>$.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${v}`)}),d=!!(0,i.getRequestMeta)(e,"minimalMode"),s=async i=>{var n,s;let u=async({previousCacheEntry:r})=>{try{if(!d&&C&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let s=L.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let u=L.renderOpts.collectedTags;if(!H)return await (0,p.sendResponse)(W,K,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[E.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:v,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,x),t}},l=await $.handleResponse({req:e,nextConfig:A,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:d});if(!H)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(s=l.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return d&&H||h.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(W,K,new Response(l.value.body,{headers:h,status:l.value.status||200})),null};F?await s(F):await j.withPropagatedContext(e.headers,()=>j.trace(l.BaseServerSpan.handleRequest,{spanName:`${U} ${v}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},s))}catch(t){if(t instanceof h.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,x),H)throw t;return await (0,p.sendResponse)(W,K,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>q,"routeModule",()=>$,"serverHooks",()=>P,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>O],496585)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_4c766caf.js.map