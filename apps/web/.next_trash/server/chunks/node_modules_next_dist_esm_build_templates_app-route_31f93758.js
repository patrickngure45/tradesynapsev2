module.exports=[908621,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),o=e.i(561916),n=e.i(174677),s=e.i(869741),d=e.i(316795),l=e.i(487718),u=e.i(995169),c=e.i(47587),p=e.i(666012),_=e.i(570101),m=e.i(626937),h=e.i(10372),v=e.i(193695);e.i(52474);var E=e.i(600220),w=e.i(469719),g=e.i(300959),f=e.i(843793),y=e.i(184883),R=e.i(977775),k=e.i(720290),b=e.i(796929),A=e.i(60828),T=e.i(273278);let C={kind:"badge",code:"shared_pool_member",rarity:"common",label:"Pool Member"},S={low:[{weight:9200,value:"none"},{weight:700,value:"rare_cosmetic"},{weight:90,value:"epic_cosmetic"},{weight:10,value:"gate_key"}],medium:[{weight:8800,value:"none"},{weight:950,value:"rare_cosmetic"},{weight:220,value:"epic_cosmetic"},{weight:30,value:"gate_key"}],high:[{weight:8300,value:"none"},{weight:1200,value:"rare_cosmetic"},{weight:420,value:"epic_cosmetic"},{weight:80,value:"gate_key"}]},x=w.z.object({action_id:w.z.string().uuid(),client_seed:w.z.string().min(8).max(256)}),$="shared_pool",I="shard",N="arcade_shard",O="common";async function P(e){let t,r=(0,R.getActingUserId)(e),a=(0,R.requireActingUserIdInProd)(r);if(a)return(0,g.apiError)(a);if(!r)return(0,g.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=x.parse(i)}catch(e){return(0,g.apiZodError)(e)??(0,g.apiError)("invalid_input")}let o=t.action_id,n=String(t.client_seed??"").trim(),s=(0,f.getSql)();try{let e=await (0,y.retryOnceOnTransientDbError)(async()=>await s.begin(async e=>{var t;let a,i,s=await (0,b.enforceArcadeSafety)(e,{userId:r,module:$,shardSpend:10});if(!s.ok)return{kind:"err",err:(0,g.apiError)(s.error,{details:s.details})};let d=await e`
          SELECT
            id::text AS id,
            user_id::text AS user_id,
            module,
            profile,
            status,
            client_commit_hash,
            server_commit_hash,
            server_seed_b64,
            input_json,
            outcome_json
          FROM arcade_action
          WHERE id = ${o}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(!d.length)return{kind:"err",err:(0,g.apiError)("not_found")};let l=d[0];if(l.user_id!==r)return{kind:"err",err:(0,g.apiError)("x_user_id_mismatch")};if(l.module!==$)return{kind:"err",err:(0,g.apiError)("invalid_input")};if("resolved"===l.status)return{kind:"ok",already:!0,outcome:l.outcome_json};if("committed"!==l.status)return{kind:"err",err:(0,g.apiError)("trade_state_conflict",{details:{status:l.status}})};let u=(0,k.sha256Hex)(n);if(!(0,k.isSha256Hex)(u)||u!==String(l.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,g.apiError)("invalid_input",{details:"client_seed does not match commit"})};let c=String(l.input_json?.week_start??"").trim();if(!c)return{kind:"err",err:(0,g.apiError)("internal_error",{details:"missing_week_start"})};if((0,k.sha256Hex)(`${l.server_seed_b64}:${l.client_commit_hash}:${l.module}:${l.profile}:${r}:week=${c}`)!==String(l.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,g.apiError)("internal_error",{details:"server_commit_mismatch"})};let p=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${I}
            AND code = ${N}
            AND rarity = ${O}
          LIMIT 1
          FOR UPDATE
        `,_=Number(p[0]?.quantity??0);if(_<10)return{kind:"err",err:(0,g.apiError)("insufficient_balance",{details:{message:"Need 10 shards to join."}})};let m=(t={actionId:l.id,userId:r,module:l.module,profile:l.profile,serverSeedB64:l.server_seed_b64,clientSeed:n,clientCommitHash:l.client_commit_hash,weekStartIso:c},a=(0,k.sha256Hex)(`${t.serverSeedB64}:${t.clientSeed}:${t.actionId}:${t.userId}:${t.module}:${t.profile}:${t.clientCommitHash}:week=${t.weekStartIso}:boost`),i=function(e,t){let r=t.reduce((e,t)=>e+t.weight,0),a=Number(e%BigInt(r)),i=0;for(let e of t)if(a<(i+=e.weight))return{picked:e.value,roll:a,total:r};return{picked:t[t.length-1].value,roll:a,total:r}}((0,k.bytesToU64BigInt)(Buffer.from(a.slice(0,16),"hex")),S[t.profile]??S.low),{outcome:{baseline:C,boost:function(e){switch(e){case"none":return null;case"rare_cosmetic":return{kind:"cosmetic",code:"shared_pool_glow",rarity:"rare",label:"Pool Glow"};case"epic_cosmetic":return{kind:"cosmetic",code:"shared_pool_comet",rarity:"epic",label:"Pool Comet"};case"gate_key":return{kind:"key",code:"gate_key",rarity:"legendary",label:"Gate Key"}}}(i.picked)},audit:{random_hash:a,roll:i.roll,total:i.total,boost_kind:String(i.picked)}}),h=p[0].id,v=_-10;0===v?await e`DELETE FROM arcade_inventory WHERE id = ${h}::uuid`:await e`UPDATE arcade_inventory SET quantity = ${v}, updated_at = now() WHERE id = ${h}::uuid`,await (0,A.logArcadeConsumption)(e,{user_id:r,kind:I,code:N,rarity:O,quantity:10,context_type:"shared_pool",context_id:l.id,module:$,metadata:{cost_shards:10,week_start:c}}),await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${r}::uuid,
            ${m.outcome.baseline.kind},
            ${m.outcome.baseline.code},
            ${m.outcome.baseline.rarity},
            1,
            ${e.json({label:m.outcome.baseline.label,source:$,week_start:c,action_id:l.id})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `,m.outcome.boost&&await e`
            INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
            VALUES (
              ${r}::uuid,
              ${m.outcome.boost.kind},
              ${m.outcome.boost.code},
              ${m.outcome.boost.rarity},
              1,
              ${e.json({label:m.outcome.boost.label,source:$,week_start:c,action_id:l.id})},
              now(),
              now()
            )
            ON CONFLICT (user_id, kind, code, rarity)
            DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
          `;let E={module:l.module,profile:l.profile,week_start:c,cost_shards:10,outcome:m.outcome,audit:{client_commit_hash:l.client_commit_hash,server_commit_hash:l.server_commit_hash,server_seed_b64:l.server_seed_b64,...m.audit}};return await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(E)}
          WHERE id = ${l.id}::uuid
        `,await (0,T.addArcadeXp)(e,{userId:r,deltaXp:1,contextRandomHash:m.audit.random_hash,source:$}),{kind:"ok",already:!1,outcome:E}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:o,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,y.responseForDbError)("arcade_shared_pool_reveal",t);if(e)return e;return(0,g.apiError)("internal_error")}}e.s(["POST",()=>P,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],578040);var H=e.i(578040);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/shared-pool/reveal/route",pathname:"/api/arcade/shared-pool/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/shared-pool/reveal/route.ts",nextConfigOutput:"",userland:H}),{workAsyncStorage:U,workUnitAsyncStorage:q,serverHooks:j}=D;function M(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:q})}async function F(e,t,a){D.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/arcade/shared-pool/reveal/route";w=w.replace(/\/index$/,"")||"/";let g=await D.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:f,params:y,nextConfig:R,parsedUrl:k,isDraftMode:b,prerenderManifest:A,routerServerContext:T,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:$,serverActionsManifest:I}=g,N=(0,s.normalizeAppPath)(w),O=!!(A.dynamicRoutes[N]||A.routes[x]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,k,!1):t.end("This page could not be found"),null);if(O&&!b){let e=!!A.routes[x],t=A.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await P();throw new v.NoFallbackError}}let H=null;!O||D.isDev||b||(H="/index"===(H=x)?"/":H);let U=!0===D.isDev||!O,q=O&&!U;I&&$&&(0,n.setManifestsSingleton)({page:w,clientReferenceManifest:$,serverActionsManifest:I});let j=e.method||"GET",M=(0,o.getTracer)(),F=M.getActiveScopeSpan(),L={params:y,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>D.onRequestError(e,t,a,i,T)},sharedContext:{buildId:f}},B=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),W=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let n=async e=>D.handle(W,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${j} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${w}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let l=async({previousCacheEntry:r})=>{try{if(!s&&C&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await n(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let l=L.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(B,K,o,L.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(o.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})},!1,T),t}},u=await D.handleResponse({req:e,nextConfig:R,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:S,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!O)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),b&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let v=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&O||v.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||v.get("Cache-Control")||v.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,p.sendResponse)(B,K,new Response(u.value.body,{headers:v,status:u.value.status||200})),null};F?await d(F):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${j} ${w}`,kind:o.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},d))}catch(t){if(t instanceof v.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})},!1,T),O)throw t;return await (0,p.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>M,"routeModule",()=>D,"serverHooks",()=>j,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>q],908621)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_31f93758.js.map