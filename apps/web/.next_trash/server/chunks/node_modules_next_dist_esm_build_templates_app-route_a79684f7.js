module.exports=[590196,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),n=e.i(759756),i=e.i(561916),s=e.i(174677),o=e.i(869741),u=e.i(316795),l=e.i(487718),d=e.i(995169),c=e.i(47587),p=e.i(666012),_=e.i(570101),E=e.i(626937),g=e.i(10372),h=e.i(193695);e.i(52474);var m=e.i(600220),y=e.i(469719),b=e.i(300959),f=e.i(364608),R=e.i(977775),w=e.i(795374),x=e.i(843793),A=e.i(184883);let v=y.z.object({limit:y.z.coerce.number().int().min(1).max(200).optional()}),T=y.z.object({from_symbol:y.z.string().min(1).max(12),to_symbol:y.z.string().min(1).max(12),amount_in:y.z.string().min(1).max(80),cadence:y.z.enum(["daily","weekly"]),first_run_in_min:y.z.coerce.number().int().min(1).max(1440).optional().default(5),totp_code:y.z.string().length(6).regex(/^\d{6}$/).optional()}),S=y.z.object({id:y.z.string().uuid(),status:y.z.enum(["active","paused","canceled"]),totp_code:y.z.string().length(6).regex(/^\d{6}$/).optional()});function O(e){return String(e??"").trim().toUpperCase()}function C(){let e=Number(String(process.env.EXCHANGE_AUTOMATION_AUTH_TTL_SEC??"").trim()||"2592000");return!Number.isFinite(e)||e<=0?2592e3:Math.max(3600,Math.min(e,15552e3))}async function I(e){let t,r=new URL(e.url);try{t=v.parse({limit:r.searchParams.get("limit")??void 0})}catch(e){return(0,b.apiZodError)(e)??(0,b.apiError)("invalid_input")}let a=(0,x.getSql)(),n=(0,R.getActingUserId)(e),i=(0,R.requireActingUserIdInProd)(n);if(i)return(0,b.apiError)(i);if(!n)return(0,b.apiError)("unauthorized",{status:401});try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,f.requireActiveUser)(a,n));if(e)return(0,b.apiError)(e);let r=t.limit??50,i=await (0,A.retryOnceOnTransientDbError)(async()=>await a`
        SELECT
          id::text AS id,
          status,
          from_symbol,
          to_symbol,
          amount_in::text AS amount_in,
          cadence,
          next_run_at::text AS next_run_at,
          last_run_at::text AS last_run_at,
          auth_expires_at::text AS auth_expires_at,
          last_run_status,
          last_run_error,
          last_entry_id::text AS last_entry_id,
          created_at::text AS created_at,
          updated_at::text AS updated_at
        FROM app_recurring_buy_plan
        WHERE user_id = ${n}::uuid
        ORDER BY created_at DESC
        LIMIT ${r}
      `);return Response.json({plans:i,limit:r})}catch(t){let e=(0,A.responseForDbError)("exchange.recurring-buys.list",t);if(e)return e;throw t}}async function U(e){let t,r,a,n=(0,x.getSql)(),i=(0,R.getActingUserId)(e),s=(0,R.requireActingUserIdInProd)(i);if(s)return(0,b.apiError)(s);if(!i)return(0,b.apiError)("missing_x_user_id");try{t=await e.json()}catch{return(0,b.apiError)("invalid_input")}try{r=T.parse(t)}catch(e){return(0,b.apiZodError)(e)??(0,b.apiError)("invalid_input")}let o=O(r.from_symbol),u=O(r.to_symbol),l=(a=String(r.amount_in??"").trim())&&!(a.length>80)&&/^[0-9]+(\.[0-9]+)?$/.test(a)?a:"";if(!o||!u||!l)return(0,b.apiError)("invalid_input");if(o===u)return(0,b.apiError)("same_asset",{status:409});try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,f.requireActiveUser)(n,i));if(e)return(0,b.apiError)(e);let t=await (0,w.enforceTotpIfEnabled)(n,i,r.totp_code);if(t)return t;let a=C(),s=null,d=await (0,A.retryOnceOnTransientDbError)(async()=>await n`
        SELECT totp_enabled
        FROM app_user
        WHERE id = ${i}::uuid
        LIMIT 1
      `);d[0]?.totp_enabled&&(s=new Date(Date.now()+1e3*a));let c=new Date(Date.now()+6e4*Math.max(1,r.first_run_in_min)),p=await n.begin(async e=>{let t=await e`
        SELECT symbol
        FROM ex_asset
        WHERE chain = 'bsc'
          AND is_enabled = true
          AND symbol = ANY(${[o,u]})
      `,a=new Set(t.map(e=>String(e.symbol??"").toUpperCase()));if(!a.has(o)||!a.has(u))return{status:404,body:{error:"asset_not_found"}};let n=await e`
        INSERT INTO app_recurring_buy_plan (
          user_id,
          status,
          from_symbol,
          to_symbol,
          amount_in,
          cadence,
          next_run_at,
          auth_expires_at
        )
        VALUES (
          ${i}::uuid,
          'active',
          ${o},
          ${u},
          ${l}::numeric(38,18),
          ${r.cadence},
          ${c.toISOString()}::timestamptz,
          ${s?s.toISOString():null}::timestamptz
        )
        RETURNING id::text AS id
      `;return{status:201,body:{ok:!0,id:n[0].id}}}),_=p.body;if(_?.error)return(0,b.apiError)(_.error,{status:p.status});return Response.json(p.body,{status:p.status})}catch(t){let e=(0,A.responseForDbError)("exchange.recurring-buys.create",t);if(e)return e;throw t}}async function D(e){let t,r,a=(0,x.getSql)(),n=(0,R.getActingUserId)(e),i=(0,R.requireActingUserIdInProd)(n);if(i)return(0,b.apiError)(i);if(!n)return(0,b.apiError)("missing_x_user_id");try{t=await e.json()}catch{return(0,b.apiError)("invalid_input")}try{r=S.parse(t)}catch(e){return(0,b.apiZodError)(e)??(0,b.apiError)("invalid_input")}try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,f.requireActiveUser)(a,n));if(e)return(0,b.apiError)(e);if("active"===r.status){let e=await (0,w.enforceTotpIfEnabled)(a,n,r.totp_code);if(e)return e}let t=await a.begin(async e=>{let t=await e`
        SELECT p.user_id::text AS user_id, u.totp_enabled
        FROM app_recurring_buy_plan p
        JOIN app_user u ON u.id = p.user_id
        WHERE p.id = ${r.id}::uuid
        LIMIT 1
        FOR UPDATE
      `;if(!t.length)return{status:404,body:{error:"not_found"}};if(t[0].user_id!==n)return{status:403,body:{error:"actor_not_allowed"}};let a=null;return"active"===r.status&&t[0].totp_enabled&&(a=new Date(Date.now()+1e3*C()).toISOString()),await e`
        UPDATE app_recurring_buy_plan
        SET status = ${r.status},
            auth_expires_at = ${a}::timestamptz,
            updated_at = now()
        WHERE id = ${r.id}::uuid
      `,{status:200,body:{ok:!0}}}),i=t.body;if(i?.error)return(0,b.apiError)(i.error,{status:t.status});return Response.json(t.body,{status:t.status})}catch(t){let e=(0,A.responseForDbError)("exchange.recurring-buys.patch",t);if(e)return e;throw t}}async function N(e){let t=new URL(e.url).searchParams.get("id")??"";try{y.z.string().uuid().parse(t)}catch(e){return(0,b.apiZodError)(e)??(0,b.apiError)("invalid_input")}let r=(0,x.getSql)(),a=(0,R.getActingUserId)(e),n=(0,R.requireActingUserIdInProd)(a);if(n)return(0,b.apiError)(n);if(!a)return(0,b.apiError)("missing_x_user_id");try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,f.requireActiveUser)(r,a));if(e)return(0,b.apiError)(e);let n=await r.begin(async e=>{let r=await e`
        SELECT user_id::text AS user_id
        FROM app_recurring_buy_plan
        WHERE id = ${t}::uuid
        LIMIT 1
        FOR UPDATE
      `;return r.length?r[0].user_id!==a?{status:403,body:{error:"actor_not_allowed"}}:(await e`
        UPDATE app_recurring_buy_plan
        SET status = 'canceled', updated_at = now()
        WHERE id = ${t}::uuid
      `,{status:200,body:{ok:!0}}):{status:404,body:{error:"not_found"}}}),i=n.body;if(i?.error)return(0,b.apiError)(i.error,{status:n.status});return Response.json(n.body,{status:n.status})}catch(t){let e=(0,A.responseForDbError)("exchange.recurring-buys.delete",t);if(e)return e;throw t}}e.s(["DELETE",()=>N,"GET",()=>I,"PATCH",()=>D,"POST",()=>U,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],655135);var P=e.i(655135);let $=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/exchange/recurring-buys/route",pathname:"/api/exchange/recurring-buys",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/recurring-buys/route.ts",nextConfigOutput:"",userland:P}),{workAsyncStorage:H,workUnitAsyncStorage:q,serverHooks:M}=$;function F(){return(0,a.patchFetch)({workAsyncStorage:H,workUnitAsyncStorage:q})}async function z(e,t,a){$.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/exchange/recurring-buys/route";y=y.replace(/\/index$/,"")||"/";let b=await $.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!b)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:f,params:R,nextConfig:w,parsedUrl:x,isDraftMode:A,prerenderManifest:v,routerServerContext:T,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,resolvedPathname:C,clientReferenceManifest:I,serverActionsManifest:U}=b,D=(0,o.normalizeAppPath)(y),N=!!(v.dynamicRoutes[D]||v.routes[C]),P=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,x,!1):t.end("This page could not be found"),null);if(N&&!A){let e=!!v.routes[C],t=v.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await P();throw new h.NoFallbackError}}let H=null;!N||$.isDev||A||(H="/index"===(H=C)?"/":H);let q=!0===$.isDev||!N,M=N&&!q;U&&I&&(0,s.setManifestsSingleton)({page:y,clientReferenceManifest:I,serverActionsManifest:U});let F=e.method||"GET",z=(0,i.getTracer)(),L=z.getActiveScopeSpan(),j={params:R,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,n)=>$.onRequestError(e,t,a,n,T)},sharedContext:{buildId:f}},k=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(k,(0,l.signalFromNodeResponse)(t));try{let s=async e=>$.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=z.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${y}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var i,u;let l=async({previousCacheEntry:r})=>{try{if(!o&&S&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(n);e.fetchMetrics=j.renderOpts.fetchMetrics;let u=j.renderOpts.pendingWaitUntil;u&&a.waitUntil&&(a.waitUntil(u),u=void 0);let l=j.renderOpts.collectedTags;if(!N)return await (0,p.sendResponse)(k,W,i,j.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[g.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,T),t}},d=await $.handleResponse({req:e,nextConfig:w,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:S,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:o});if(!N)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",S?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&N||h.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,E.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(k,W,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};L?await u(L):await z.withPropagatedContext(e.headers,()=>z.trace(d.BaseServerSpan.handleRequest,{spanName:`${F} ${y}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof h.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:S})},!1,T),N)throw t;return await (0,p.sendResponse)(k,W,new Response(null,{status:500})),null}}e.s(["handler",()=>z,"patchFetch",()=>F,"routeModule",()=>$,"serverHooks",()=>M,"workAsyncStorage",()=>H,"workUnitAsyncStorage",()=>q],590196)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_a79684f7.js.map