module.exports=[999634,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),n=e.i(759756),i=e.i(561916),o=e.i(174677),s=e.i(869741),u=e.i(316795),d=e.i(487718),l=e.i(995169),c=e.i(47587),p=e.i(666012),_=e.i(570101),f=e.i(626937),m=e.i(10372),E=e.i(193695);e.i(52474);var h=e.i(600220),b=e.i(469719),v=e.i(843793),R=e.i(977775),g=e.i(364608),y=e.i(795374),x=e.i(300959),N=e.i(677702),A=e.i(184883),w=e.i(344263),T=e.i(630862),S=e.i(991654),I=e.i(60828);let C="00000000-0000-0000-0000-000000000002",O="00000000-0000-0000-0000-000000000001",q=b.z.object({from:b.z.string().min(1).max(12),to:b.z.string().min(1).max(12),amount_in:N.amount3818PositiveSchema,reference:b.z.string().min(1).max(200).optional(),totp_code:b.z.string().length(6).regex(/^\d{6}$/).optional(),use_fee_boost:b.z.boolean().optional().default(!1),client_quote:b.z.object({amount_out:N.amount3818PositiveSchema,rate_to_per_from:N.amount3818PositiveSchema}).optional()});async function H(e,t,a){return(await e`
    INSERT INTO ex_ledger_account (user_id, asset_id)
    VALUES (${t}::uuid, ${a}::uuid)
    ON CONFLICT (user_id, asset_id) DO UPDATE SET user_id = EXCLUDED.user_id
    RETURNING id::text AS id
  `)[0].id}async function P(e,t){await e`
    INSERT INTO app_user (id, status, kyc_level, country)
    VALUES (${t}::uuid, 'active', 'none', NULL)
    ON CONFLICT (id) DO NOTHING
  `}async function U(e,t){let a=await e`
    WITH posted AS (
      SELECT coalesce(sum(amount), 0)::numeric AS posted
      FROM ex_journal_line
      WHERE account_id = ${t}::uuid
    ),
    held AS (
      SELECT coalesce(sum(remaining_amount), 0)::numeric AS held
      FROM ex_hold
      WHERE account_id = ${t}::uuid AND status = 'active'
    )
    SELECT (posted.posted - held.held)::text AS available
    FROM posted, held
  `;return a[0]?.available??"0"}async function D(e){let t=(0,v.getSql)(),a=(0,R.getActingUserId)(e),r=(0,R.requireActingUserIdInProd)(a);if(r)return(0,x.apiError)(r);if(!a)return(0,x.apiError)("missing_x_user_id");try{let r,n=await (0,g.requireActiveUser)(t,a);if(n)return(0,x.apiError)(n);let i=await e.json().catch(()=>({}));try{r=q.parse(i)}catch(e){return(0,x.apiZodError)(e)??(0,x.apiError)("invalid_input")}let o=await (0,y.enforceTotpIfEnabled)(t,a,r.totp_code);if(o)return o;let s=await t.begin(async e=>{let t=r.from.trim().toUpperCase(),n=r.to.trim().toUpperCase();if(t===n)return{status:409,body:{error:"same_asset"}};let i=await e`
        SELECT id::text AS id, symbol
        FROM ex_asset
        WHERE chain = 'bsc'
          AND is_enabled = true
          AND symbol = ANY(${[t,n]})
      `,o=i.find(e=>e.symbol.toUpperCase()===t)??null,s=i.find(e=>e.symbol.toUpperCase()===n)??null;if(!o||!s)return{status:404,body:{error:"asset_not_found"}};let u=(0,w.convertFeeBps)(),d=u,l=null;if(r.use_fee_boost){let t=await e`
          SELECT id::text AS id, quantity, code
          FROM arcade_inventory
          WHERE user_id = ${a}::uuid
            AND kind = 'boost'
            AND code = ANY(ARRAY['fee_25bps_7d','fee_15bps_72h','fee_10bps_48h','fee_5bps_24h']::text[])
          ORDER BY
            CASE code
              WHEN 'fee_25bps_7d' THEN 1
              WHEN 'fee_15bps_72h' THEN 2
              WHEN 'fee_10bps_48h' THEN 3
              WHEN 'fee_5bps_24h' THEN 4
              ELSE 99
            END,
            updated_at DESC
          LIMIT 1
          FOR UPDATE
        `;if(!t.length||0>=Number(t[0].quantity??0))return{status:409,body:{error:"insufficient_balance",details:{message:"No fee discount boost available."}}};let r=t[0],n=String(r.code??"").match(/fee_(\d+)bps/i),i=n?Number(n[1]):0;if(!Number.isFinite(i)||i<=0||i>2500)return{status:409,body:{error:"internal_error",details:{message:"invalid_fee_boost"}}};l={inventory_id:r.id,code:r.code,quantity:Number(r.quantity??0),bps:i},d=Math.max(0,u-i)}let c=await (0,w.quoteConvert)(e,{fromSymbol:t,toSymbol:n,amountIn:r.amount_in,feeBps:d});if(!c)return{status:409,body:{error:"quote_unavailable"}};if(r.client_quote){let e=(0,T.toBigInt3818)(r.client_quote.amount_out),t=(0,T.toBigInt3818)(c.amountOut),a=(0,T.toBigInt3818)(r.client_quote.rate_to_per_from),n=(0,T.toBigInt3818)(c.rateToPerFrom);if(e!==t||a!==n)return{status:409,body:{error:"price_changed",details:{client_quote:r.client_quote,server_quote:c}}}}let p=await H(e,a,o.id),_=await U(e,p);if((0,T.toBigInt3818)(_)<(0,T.toBigInt3818)(c.amountIn))return{status:409,body:{error:"insufficient_balance",details:{available:_,required:c.amountIn}}};await Promise.all([P(e,C),P(e,O)]);let[f,m,E,h]=await Promise.all([H(e,a,s.id),H(e,C,o.id),H(e,C,s.id),H(e,O,o.id)]),b=await U(e,E);if((0,T.toBigInt3818)(b)<(0,T.toBigInt3818)(c.amountOut))return{status:409,body:{error:"liquidity_unavailable",details:{available:b,required:c.amountOut,asset:n}}};let v=await e`
        INSERT INTO ex_journal_entry (type, reference, metadata_json)
        VALUES (
          'convert',
          ${r.reference??`convert:${t}->${n}:${Date.now()}`},
          ${e.json({user_id:a,from:t,to:n,amount_in:c.amountIn,fee_in:c.feeIn,net_in:c.netIn,amount_out:c.amountOut,rate_to_per_from:c.rateToPerFrom,fee_bps:d,fee_bps_base:u,fee_boost:l?{code:l.code,bps:l.bps}:null,price_source:c.priceSource})}::jsonb
        )
        RETURNING id::text AS id, created_at::text AS created_at
      `,R=v[0].id;for(let t of(0,w.buildConvertJournalLines)({userFromAcct:p,userToAcct:f,systemFromAcct:m,systemToAcct:E,treasuryFromAcct:h,fromAssetId:o.id,toAssetId:s.id,quote:c}))await e`
          INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)
          VALUES (${R}::uuid, ${t.accountId}::uuid, ${t.assetId}::uuid, (${t.amount}::numeric))
        `;let g=await (0,S.recordInternalChainTx)(e,{entryId:R,type:"convert",userId:a,metadata:{from:t,to:n,amount_in:c.amountIn,amount_out:c.amountOut,fee_bps:d,fee_bps_base:u,fee_boost:l?{code:l.code,bps:l.bps}:null,price_source:c.priceSource}});if(l){let t=Number(l.quantity??0);if(t<=0)return{status:409,body:{error:"insufficient_balance",details:{message:"No fee discount boost available."}}};1===t?await e`
            DELETE FROM arcade_inventory
            WHERE id = ${l.inventory_id}::uuid
          `:await e`
            UPDATE arcade_inventory
            SET quantity = ${t-1}, updated_at = now()
            WHERE id = ${l.inventory_id}::uuid
          `,await (0,I.logArcadeConsumption)(e,{user_id:a,kind:"boost",code:l.code,rarity:null,quantity:1,context_type:"convert",context_id:R,module:"convert_fee",metadata:{fee_bps_base:u,fee_bps:d,discount_bps:l.bps}})}return{status:201,body:{ok:!0,convert:{id:R,created_at:v[0].created_at,quote:c,tx_hash:g.txHash,block_height:g.blockHeight}}}}),u=s.body;if("string"==typeof u.error)return(0,x.apiError)(u.error,{status:s.status,details:u.details});return Response.json(s.body,{status:s.status})}catch(t){let e=(0,A.responseForDbError)("exchange.convert.execute",t);if(e)return e;return console.error("exchange.convert.execute failed:",t),(0,x.apiError)("internal_error",{details:{message:t instanceof Error?t.message:String(t)}})}}e.s(["POST",()=>D,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],968118);var $=e.i(968118);let L=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/exchange/convert/execute/route",pathname:"/api/exchange/convert/execute",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/convert/execute/route.ts",nextConfigOutput:"",userland:$}),{workAsyncStorage:F,workUnitAsyncStorage:M,serverHooks:k}=L;function j(){return(0,r.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:M})}async function B(e,t,r){L.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let b="/api/exchange/convert/execute/route";b=b.replace(/\/index$/,"")||"/";let v=await L.prepare(e,t,{srcPage:b,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:R,params:g,nextConfig:y,parsedUrl:x,isDraftMode:N,prerenderManifest:A,routerServerContext:w,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,resolvedPathname:I,clientReferenceManifest:C,serverActionsManifest:O}=v,q=(0,s.normalizeAppPath)(b),H=!!(A.dynamicRoutes[q]||A.routes[I]),P=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,x,!1):t.end("This page could not be found"),null);if(H&&!N){let e=!!A.routes[I],t=A.dynamicRoutes[q];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await P();throw new E.NoFallbackError}}let U=null;!H||L.isDev||N||(U="/index"===(U=I)?"/":U);let D=!0===L.isDev||!H,$=H&&!D;O&&C&&(0,o.setManifestsSingleton)({page:b,clientReferenceManifest:C,serverActionsManifest:O});let F=e.method||"GET",M=(0,i.getTracer)(),k=M.getActiveScopeSpan(),j={params:g,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,n)=>L.onRequestError(e,t,r,n,w)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),W=new u.NodeNextResponse(t),z=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let o=async e=>L.handle(z,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${F} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${b}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),u=async n=>{var i,u;let d=async({previousCacheEntry:a})=>{try{if(!s&&T&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=j.renderOpts.fetchMetrics;let u=j.renderOpts.pendingWaitUntil;u&&r.waitUntil&&(r.waitUntil(u),u=void 0);let d=j.renderOpts.collectedTags;if(!H)return await (0,p.sendResponse)(B,W,i,j.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,r=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:T})},!1,w),t}},l=await L.handleResponse({req:e,nextConfig:y,cacheKey:U,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:S,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!H)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(u=l.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),N&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let E=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&H||E.delete(m.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||E.get("Cache-Control")||E.set("Cache-Control",(0,f.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(B,W,new Response(l.value.body,{headers:E,status:l.value.status||200})),null};k?await u(k):await M.withPropagatedContext(e.headers,()=>M.trace(l.BaseServerSpan.handleRequest,{spanName:`${F} ${b}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},u))}catch(t){if(t instanceof E.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:q,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:T})},!1,w),H)throw t;return await (0,p.sendResponse)(B,W,new Response(null,{status:500})),null}}e.s(["handler",()=>B,"patchFetch",()=>j,"routeModule",()=>L,"serverHooks",()=>k,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>M],999634)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_6854730e.js.map