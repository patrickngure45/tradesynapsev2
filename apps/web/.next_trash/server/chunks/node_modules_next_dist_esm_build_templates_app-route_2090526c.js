module.exports=[59860,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),l=e.i(869741),d=e.i(316795),s=e.i(487718),u=e.i(995169),c=e.i(47587),m=e.i(666012),h=e.i(570101),p=e.i(626937),_=e.i(10372),w=e.i(193695);e.i(52474);var v=e.i(600220),y=e.i(469719),E=e.i(300959),g=e.i(843793),f=e.i(184883),R=e.i(977775),k=e.i(720290);let T={common:[{kind:"cosmetic",code:"wheel_spark",rarity:"common",label:"Wheel Spark"},{kind:"cosmetic",code:"wheel_sticker",rarity:"common",label:"Wheel Sticker"}],uncommon:[{kind:"cosmetic",code:"wheel_glow",rarity:"uncommon",label:"Wheel Glow"},{kind:"cosmetic",code:"wheel_frame",rarity:"uncommon",label:"Wheel Frame"}],rare:[{kind:"cosmetic",code:"wheel_aura",rarity:"rare",label:"Wheel Aura"},{kind:"cosmetic",code:"wheel_title",rarity:"rare",label:"Wheel Title"}],epic:[{kind:"cosmetic",code:"wheel_comet",rarity:"epic",label:"Wheel Comet"}],legendary:[{kind:"cosmetic",code:"wheel_crown",rarity:"legendary",label:"Wheel Crown"},{kind:"key",code:"gate_key",rarity:"legendary",label:"Gate Key"}]},A={low:[{weight:8700,value:"common"},{weight:1100,value:"uncommon"},{weight:170,value:"rare"},{weight:25,value:"epic"},{weight:5,value:"legendary"}],medium:[{weight:7900,value:"common"},{weight:1500,value:"uncommon"},{weight:480,value:"rare"},{weight:95,value:"epic"},{weight:25,value:"legendary"}],high:[{weight:7e3,value:"common"},{weight:1900,value:"uncommon"},{weight:820,value:"rare"},{weight:210,value:"epic"},{weight:70,value:"legendary"}]};var b=e.i(60828),C=e.i(273278),x=e.i(796929);let S=y.z.object({action_id:y.z.string().uuid(),client_seed:y.z.string().min(8).max(256)}),$="rarity_wheel",N="shard",I="arcade_shard",O="common";async function P(e){let t,r=(0,R.getActingUserId)(e),a=(0,R.requireActingUserIdInProd)(r);if(a)return(0,E.apiError)(a);if(!r)return(0,E.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=S.parse(i)}catch(e){return(0,E.apiZodError)(e)??(0,E.apiError)("invalid_input")}let n=t.action_id,o=String(t.client_seed??"").trim(),l=(0,g.getSql)();try{let e=await (0,f.retryOnceOnTransientDbError)(async()=>await l.begin(async e=>{var t;let a,i,l,d,s,u,c,m,h=await (0,x.enforceArcadeSafety)(e,{userId:r,module:$,shardSpend:10});if(!h.ok)return{kind:"err",err:(0,E.apiError)(h.error,{details:h.details})};let p=await e`
          SELECT
            id::text AS id,
            user_id::text AS user_id,
            module,
            profile,
            status,
            client_commit_hash,
            server_commit_hash,
            server_seed_b64,
            outcome_json
          FROM arcade_action
          WHERE id = ${n}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(!p.length)return{kind:"err",err:(0,E.apiError)("not_found")};let _=p[0];if(_.user_id!==r)return{kind:"err",err:(0,E.apiError)("x_user_id_mismatch")};if(_.module!==$)return{kind:"err",err:(0,E.apiError)("invalid_input")};if("resolved"===_.status)return{kind:"ok",already:!0,outcome:_.outcome_json};if("committed"!==_.status)return{kind:"err",err:(0,E.apiError)("trade_state_conflict",{details:{status:_.status}})};let w=(0,k.sha256Hex)(o);if(!(0,k.isSha256Hex)(w)||w!==String(_.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,E.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,k.sha256Hex)(`${_.server_seed_b64}:${_.client_commit_hash}:${_.module}:${_.profile}:${r}`)!==String(_.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,E.apiError)("internal_error",{details:"server_commit_mismatch"})};let v=await e`
          SELECT value_json
          FROM arcade_state
          WHERE user_id = ${r}::uuid AND key = 'rarity_wheel'
          LIMIT 1
          FOR UPDATE
        `,y=Number(v[0]?.value_json?.pity_rare??0),g=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${N}
            AND code = ${I}
            AND rarity = ${O}
          LIMIT 1
          FOR UPDATE
        `,f=Number(g[0]?.quantity??0);if(f<10)return{kind:"err",err:(0,E.apiError)("insufficient_balance",{details:{message:"Need 10 shards to spin."}})};let R=(t={actionId:_.id,userId:r,module:_.module,profile:_.profile,serverSeedB64:_.server_seed_b64,clientSeed:o,clientCommitHash:_.client_commit_hash,pityRare:y},a=Math.max(0,Math.min(50,Math.floor(t.pityRare))),i=(0,k.sha256Hex)(`${t.serverSeedB64}:${t.clientSeed}:${t.actionId}:${t.userId}:${t.module}:${t.profile}:${t.clientCommitHash}:rarity:pity=${a}`),l=function(e,t){let r=t.reduce((e,t)=>e+t.weight,0),a=Number(e%BigInt(r)),i=0;for(let e of t)if(a<(i+=e.weight))return{picked:e.value,roll:a,total:r};return{picked:t[t.length-1].value,roll:a,total:r}}((0,k.bytesToU64BigInt)(Buffer.from(i.slice(0,16),"hex")),A[t.profile]),d=a>=10&&("common"===l.picked||"uncommon"===l.picked)?"rare":l.picked,s=(0,k.sha256Hex)(`${i}:item:${d}`),{outcome:(u=(0,k.bytesToU64BigInt)(Buffer.from(s.slice(0,16),"hex")),c=T[d],m=Number(u%BigInt(c.length)),c[m]??c[0]),audit:{random_hash:s,roll:Number(u%10000n),total:1e4,pity_rare:a,rarity_roll:l.roll,rarity_total:l.total}}),S=g[0].id,P=f-10;0===P?await e`
            DELETE FROM arcade_inventory
            WHERE id = ${S}::uuid
          `:await e`
            UPDATE arcade_inventory
            SET quantity = ${P}, updated_at = now()
            WHERE id = ${S}::uuid
          `,await (0,b.logArcadeConsumption)(e,{user_id:r,kind:N,code:I,rarity:O,quantity:10,context_type:"rarity_wheel",context_id:_.id,module:"rarity_wheel",metadata:{cost_shards:10}}),await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${r}::uuid,
            ${R.outcome.kind},
            ${R.outcome.code},
            ${R.outcome.rarity},
            1,
            ${e.json({label:R.outcome.label,source:$,action_id:_.id})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `;let D="common"===R.outcome.rarity||"uncommon"===R.outcome.rarity?y+1:0;await e`
          INSERT INTO arcade_state (user_id, key, value_json, created_at, updated_at)
          VALUES (${r}::uuid, 'rarity_wheel', ${e.json({pity_rare:D})}::jsonb, now(), now())
          ON CONFLICT (user_id, key)
          DO UPDATE SET value_json = EXCLUDED.value_json, updated_at = now()
        `;let H={module:_.module,profile:_.profile,outcome:R.outcome,audit:{client_commit_hash:_.client_commit_hash,server_commit_hash:_.server_commit_hash,server_seed_b64:_.server_seed_b64,...R.audit}};return await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(H)}
          WHERE id = ${_.id}::uuid
        `,await (0,C.addArcadeXp)(e,{userId:r,deltaXp:1,contextRandomHash:R.audit.random_hash,source:"rarity_wheel"}),{kind:"ok",already:!1,outcome:H}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:n,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,f.responseForDbError)("arcade_wheel_reveal",t);if(e)return e;return(0,E.apiError)("internal_error")}}e.s(["POST",()=>P,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],240043);var D=e.i(240043);let H=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/wheel/reveal/route",pathname:"/api/arcade/wheel/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/wheel/reveal/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:U,workUnitAsyncStorage:j,serverHooks:q}=H;function M(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:j})}async function F(e,t,a){H.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let y="/api/arcade/wheel/reveal/route";y=y.replace(/\/index$/,"")||"/";let E=await H.prepare(e,t,{srcPage:y,multiZoneDraftMode:!1});if(!E)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:g,params:f,nextConfig:R,parsedUrl:k,isDraftMode:T,prerenderManifest:A,routerServerContext:b,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,resolvedPathname:S,clientReferenceManifest:$,serverActionsManifest:N}=E,I=(0,l.normalizeAppPath)(y),O=!!(A.dynamicRoutes[I]||A.routes[S]),P=async()=>((null==b?void 0:b.render404)?await b.render404(e,t,k,!1):t.end("This page could not be found"),null);if(O&&!T){let e=!!A.routes[S],t=A.dynamicRoutes[I];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await P();throw new w.NoFallbackError}}let D=null;!O||H.isDev||T||(D="/index"===(D=S)?"/":D);let U=!0===H.isDev||!O,j=O&&!U;N&&$&&(0,o.setManifestsSingleton)({page:y,clientReferenceManifest:$,serverActionsManifest:N});let q=e.method||"GET",M=(0,n.getTracer)(),F=M.getActiveScopeSpan(),L={params:f,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>H.onRequestError(e,t,a,i,b)},sharedContext:{buildId:g}},W=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),K=s.NextRequestAdapter.fromNodeNextRequest(W,(0,s.signalFromNodeResponse)(t));try{let o=async e=>H.handle(K,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${y}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let s=async({previousCacheEntry:r})=>{try{if(!l&&C&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let d=L.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let s=L.renderOpts.collectedTags;if(!O)return await (0,m.sendResponse)(W,B,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);s&&(t[_.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await H.onRequestError(e,t,{routerKind:"App Router",routePath:y,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,b),t}},u=await H.handleResponse({req:e,nextConfig:R,cacheKey:D,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,responseGenerator:s,waitUntil:a.waitUntil,isMinimalMode:l});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let w=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&O||w.delete(_.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||w.get("Cache-Control")||w.set("Cache-Control",(0,p.getCacheControlHeader)(u.cacheControl)),await (0,m.sendResponse)(W,B,new Response(u.value.body,{headers:w,status:u.value.status||200})),null};F?await d(F):await M.withPropagatedContext(e.headers,()=>M.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${y}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof w.NoFallbackError||await H.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:C})},!1,b),O)throw t;return await (0,m.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>M,"routeModule",()=>H,"serverHooks",()=>q,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>j],59860)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_2090526c.js.map