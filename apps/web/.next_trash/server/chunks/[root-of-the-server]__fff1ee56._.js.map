{"version":3,"sources":["../../../src/lib/api/errors.ts","../../../src/lib/dbTransient.ts","../../../src/lib/auth/session.ts","../../../src/lib/auth/party.ts","../../../src/lib/auth/admin.ts","../../../src/lib/blockchain/tokens.ts","../../../src/lib/blockchain/hotWallet.ts"],"sourcesContent":["import { ZodError } from \"zod\";\r\n\r\nexport type ApiErrorResponse = {\r\n  error: string;\r\n  details?: unknown;\r\n};\r\n\r\nexport function statusForApiError(code: string): number {\r\n  switch (code) {\r\n    // AuthN\r\n    case \"missing_x_user_id\":\r\n    case \"missing_user_id\":\r\n    case \"reviewer_key_invalid\":\r\n    case \"session_bootstrap_key_invalid\":\r\n    case \"admin_key_invalid\":\r\n    case \"session_token_expired\":\r\n      return 401;\r\n\r\n    // AuthZ\r\n    case \"not_party\":\r\n    case \"opened_by_not_party\":\r\n    case \"x_user_id_mismatch\":\r\n    case \"actor_not_allowed\":\r\n    case \"withdrawal_address_not_allowlisted\":\r\n    case \"email_not_verified\":\r\n    case \"kyc_required_for_asset\":\r\n    case \"withdrawal_requires_kyc\":\r\n    case \"withdrawal_allowlist_cooldown\":\r\n    case \"totp_setup_required\":\r\n    case \"stepup_required\":\r\n    case \"user_not_active\":\r\n    case \"buyer_not_active\":\r\n    case \"seller_not_active\":\r\n    case \"p2p_country_not_supported\":\r\n    case \"arcade_key_required\":\r\n      return 403;\r\n\r\n    // Not found\r\n    case \"not_found\":\r\n    case \"recipient_not_found\":\r\n    case \"trade_not_found\":\r\n    case \"dispute_not_found\":\r\n    case \"user_not_found\":\r\n    case \"market_not_found\":\r\n    case \"order_not_found\":\r\n    case \"ad_not_found\":\r\n    case \"transfer_not_found\":\r\n      return 404;\r\n\r\n    // Conflict / state machine\r\n    case \"trade_not_disputable\":\r\n    case \"trade_not_disputed\":\r\n    case \"trade_not_resolvable\":\r\n    case \"dispute_not_open\":\r\n    case \"dispute_already_exists\":\r\n    case \"dispute_transition_not_allowed\":\r\n    case \"trade_transition_not_allowed\":\r\n    case \"trade_not_cancelable\":\r\n    case \"trade_state_conflict\":\r\n    case \"insufficient_balance\":\r\n    case \"recipient_inactive\":\r\n    case \"recipient_same_as_sender\":\r\n    case \"transfer_not_reversible\":\r\n    case \"transfer_already_reversed\":\r\n    case \"recipient_insufficient_balance_for_reversal\":\r\n    case \"seller_insufficient_funds\":\r\n    case \"insufficient_liquidity_on_ad\":\r\n    case \"seller_payment_details_missing\":\r\n    case \"order_state_conflict\":\r\n    case \"market_disabled\":\r\n    case \"withdrawal_risk_blocked\":\r\n    case \"ad_is_not_online\":\r\n    case \"p2p_open_orders_limit\":\r\n    case \"post_only_would_take\":\r\n    case \"fok_insufficient_liquidity\":\r\n    case \"idempotency_key_conflict\":\r\n    case \"open_orders_limit\":\r\n    case \"order_notional_too_large\":\r\n    case \"exchange_price_out_of_band\":\r\n    case \"market_halted\":\r\n    case \"stp_cancel_newest\":\r\n    case \"stp_cancel_both\":\r\n    case \"passkey_not_configured\":\r\n      return 409;\r\n\r\n    // Gas token\r\n    case \"insufficient_gas\":\r\n      return 409;\r\n    case \"gas_disabled\":\r\n      return 403;\r\n    case \"gas_asset_not_found\":\r\n    case \"gas_fee_invalid\":\r\n      return 500;\r\n\r\n    // Forbidden\r\n    case \"cannot_trade_own_ad\":\r\n      return 403;\r\n\r\n    // Rate limiting\r\n    case \"rate_limit_exceeded\":\r\n    case \"p2p_order_create_cooldown\":\r\n      return 429;\r\n\r\n    // Validation\r\n    case \"invalid_input\":\r\n    case \"price_not_multiple_of_tick\":\r\n    case \"quantity_not_multiple_of_lot\":\r\n    case \"unsupported_version\":\r\n    case \"missing_file\":\r\n    case \"invalid_metadata_json\":\r\n    case \"buyer_not_found\":\r\n    case \"seller_not_found\":\r\n    case \"seller_payment_method_required\":\r\n    case \"invalid_seller_payment_method\":\r\n    case \"webauthn_verification_failed\":\r\n      return 400;\r\n\r\n    // Server misconfig\r\n    case \"reviewer_key_not_configured\":\r\n    case \"session_secret_not_configured\":\r\n    case \"session_bootstrap_not_configured\":\r\n    case \"admin_key_not_configured\":\r\n      return 500;\r\n\r\n    // Internal\r\n    case \"internal_error\":\r\n      return 500;\r\n\r\n    // Upstream / dependencies\r\n    case \"upstream_unavailable\":\r\n      return 503;\r\n\r\n    default:\r\n      return 400;\r\n  }\r\n}\r\n\r\nexport function apiError(\r\n  code: string,\r\n  init?: {\r\n    status?: number;\r\n    details?: unknown;\r\n    headers?: HeadersInit;\r\n  }\r\n): Response {\r\n  const status = init?.status ?? statusForApiError(code);\r\n  \r\n  // Ensure message is included if details is just a string, or if we can extract it.\r\n  // But strictly, we should output { error: code, message?: string, details?: any }\r\n  // The UI expects `message`.\r\n  const body: any = { error: code };\r\n  \r\n  if (typeof init?.details === 'string') {\r\n      body.message = init.details;\r\n      body.details = init.details;\r\n  } else if (typeof init?.details === 'object' && init?.details !== null) {\r\n      body.details = init.details;\r\n      if ('message' in init.details) {\r\n          body.message = (init.details as any).message;\r\n      }\r\n  }\r\n\r\n  const headers = init?.headers ? new Headers(init.headers) : new Headers();\r\n  if (code === \"upstream_unavailable\" && !headers.has(\"Retry-After\")) {\r\n    headers.set(\"Retry-After\", \"3\");\r\n  }\r\n\r\n  return Response.json(body, { status, headers });\r\n}\r\n\r\nexport function apiZodError(err: unknown): Response | null {\r\n  if (!(err instanceof ZodError)) return null;\r\n  return apiError(\"invalid_input\", { status: 400, details: err.issues });\r\n}\r\n\r\nexport function apiUpstreamUnavailable(\r\n  details?: unknown,\r\n  init?: {\r\n    retryAfterSeconds?: number;\r\n  }\r\n): Response {\r\n  const headers: HeadersInit | undefined =\r\n    typeof init?.retryAfterSeconds === \"number\"\r\n      ? { \"Retry-After\": String(Math.max(0, Math.floor(init.retryAfterSeconds))) }\r\n      : undefined;\r\n\r\n  return apiError(\"upstream_unavailable\", {\r\n    status: 503,\r\n    details,\r\n    headers,\r\n  });\r\n}\r\n","import { apiUpstreamUnavailable } from \"@/lib/api/errors\";\r\n\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((r) => setTimeout(r, ms));\r\n}\r\n\r\nfunction getErrorCode(err: unknown): string | undefined {\r\n  if (!err || typeof err !== \"object\") return undefined;\r\n  const anyErr = err as { code?: unknown };\r\n  return typeof anyErr.code === \"string\" ? anyErr.code : undefined;\r\n}\r\n\r\nfunction getErrorMessage(err: unknown): string {\r\n  if (!err || typeof err !== \"object\") return String(err);\r\n  const anyErr = err as { message?: unknown };\r\n  return typeof anyErr.message === \"string\" ? anyErr.message : String(err);\r\n}\r\n\r\nexport function isTransientDbError(err: unknown): boolean {\r\n  const code = (getErrorCode(err) ?? \"\").toUpperCase();\r\n  const msg = getErrorMessage(err);\r\n\r\n  // postgres.js (and some serverless poolers) commonly surface these.\r\n  const transientCodes = new Set([\r\n    \"CONNECTION_CLOSED\",\r\n    \"CONNECTION_ENDED\",\r\n    \"CONNECTION_DESTROYED\",\r\n    \"ECONNRESET\",\r\n    \"ETIMEDOUT\",\r\n    \"EPIPE\",\r\n    \"ENOTFOUND\",\r\n  ]);\r\n  if (code && transientCodes.has(code)) return true;\r\n\r\n  // SQLSTATE classes for connection / availability issues.\r\n  // 08xxx: connection exception, 57P0x: operator intervention.\r\n  const transientSqlState = new Set([\r\n    \"08000\",\r\n    \"08003\",\r\n    \"08006\",\r\n    \"08001\",\r\n    \"08004\",\r\n    \"57P01\",\r\n    \"57P02\",\r\n    \"57P03\",\r\n    \"53300\", // too_many_connections\r\n  ]);\r\n  if (code && transientSqlState.has(code)) return true;\r\n\r\n  if (\r\n    /CONNECTION_CLOSED|connection\\s+terminated|terminating\\s+connection|socket\\s+hang\\s+up|ECONNRESET|EPIPE/i.test(\r\n      msg\r\n    )\r\n  ) {\r\n    return true;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport async function retryOnceOnTransientDbError<T>(\r\n  fn: () => Promise<T>,\r\n  init?: { delayMs?: number }\r\n): Promise<T> {\r\n  try {\r\n    return await fn();\r\n  } catch (e) {\r\n    if (!isTransientDbError(e)) throw e;\r\n    await sleep(init?.delayMs ?? 50);\r\n    return await fn();\r\n  }\r\n}\r\n\r\nexport function responseForDbError(op: string, err: unknown): Response | null {\r\n  if (!isTransientDbError(err)) return null;\r\n\r\n  return apiUpstreamUnavailable(\r\n    {\r\n      dependency: \"db\",\r\n      op,\r\n    },\r\n    { retryAfterSeconds: 3 }\r\n  );\r\n}\r\n","import { createHmac, timingSafeEqual } from \"node:crypto\";\r\n\r\nconst COOKIE_NAME = \"pp_session\";\r\n\r\ntype SessionPayload = {\r\n  uid: string;\r\n  iat: number;\r\n  exp: number;\r\n  sv?: number;\r\n};\r\n\r\nfunction base64UrlEncode(buf: Buffer): string {\r\n  return buf\r\n    .toString(\"base64\")\r\n    .replace(/\\+/g, \"-\")\r\n    .replace(/\\//g, \"_\")\r\n    .replace(/=+$/g, \"\");\r\n}\r\n\r\nfunction base64UrlDecode(text: string): Buffer {\r\n  const pad = text.length % 4;\r\n  const padded = text + (pad ? \"=\".repeat(4 - pad) : \"\");\r\n  const b64 = padded.replace(/-/g, \"+\").replace(/_/g, \"/\");\r\n  return Buffer.from(b64, \"base64\");\r\n}\r\n\r\nfunction sign(secret: string, payloadB64: string): string {\r\n  const mac = createHmac(\"sha256\", secret).update(payloadB64, \"utf8\").digest();\r\n  return base64UrlEncode(mac);\r\n}\r\n\r\nexport function getSessionCookieName(): string {\r\n  return COOKIE_NAME;\r\n}\r\n\r\nexport function parseCookieHeader(header: string | null): Record<string, string> {\r\n  if (!header) return {};\r\n  const out: Record<string, string> = {};\r\n  const parts = header.split(/;\\s*/g);\r\n  for (const part of parts) {\r\n    const idx = part.indexOf(\"=\");\r\n    if (idx <= 0) continue;\r\n    const k = part.slice(0, idx).trim();\r\n    const v = part.slice(idx + 1).trim();\r\n    if (!k) continue;\r\n    out[k] = decodeURIComponent(v);\r\n  }\r\n  return out;\r\n}\r\n\r\nexport function getSessionTokenFromRequest(request: Request): string | null {\r\n  const cookies = parseCookieHeader(request.headers.get(\"cookie\"));\r\n  return cookies[COOKIE_NAME] ?? null;\r\n}\r\n\r\nexport function createSessionToken(opts: {\r\n  userId: string;\r\n  secret: string;\r\n  sessionVersion?: number;\r\n  ttlSeconds?: number;\r\n  now?: number;\r\n}): string {\r\n  const nowSec = Math.floor((opts.now ?? Date.now()) / 1000);\r\n  const ttl = typeof opts.ttlSeconds === \"number\" ? opts.ttlSeconds : 60 * 60 * 24 * 7;\r\n  const payload: SessionPayload = {\r\n    uid: opts.userId,\r\n    iat: nowSec,\r\n    exp: nowSec + ttl,\r\n    ...(typeof opts.sessionVersion === \"number\" && Number.isFinite(opts.sessionVersion)\r\n      ? { sv: Math.max(0, Math.trunc(opts.sessionVersion)) }\r\n      : {}),\r\n  };\r\n\r\n  const payloadB64 = base64UrlEncode(Buffer.from(JSON.stringify(payload), \"utf8\"));\r\n  const sigB64 = sign(opts.secret, payloadB64);\r\n  return `${payloadB64}.${sigB64}`;\r\n}\r\n\r\nexport function verifySessionToken(opts: {\r\n  token: string;\r\n  secret: string;\r\n  now?: number;\r\n}): { ok: true; payload: SessionPayload } | { ok: false; error: string } {\r\n  const token = opts.token.trim();\r\n  const dot = token.indexOf(\".\");\r\n  if (dot <= 0) return { ok: false, error: \"session_token_invalid\" };\r\n\r\n  const payloadB64 = token.slice(0, dot);\r\n  const sigB64 = token.slice(dot + 1);\r\n  if (!payloadB64 || !sigB64) return { ok: false, error: \"session_token_invalid\" };\r\n\r\n  const expectedSig = sign(opts.secret, payloadB64);\r\n  const a = Buffer.from(sigB64);\r\n  const b = Buffer.from(expectedSig);\r\n  if (a.length !== b.length || !timingSafeEqual(a, b)) {\r\n    return { ok: false, error: \"session_token_invalid\" };\r\n  }\r\n\r\n  let payload: SessionPayload;\r\n  try {\r\n    payload = JSON.parse(base64UrlDecode(payloadB64).toString(\"utf8\")) as SessionPayload;\r\n  } catch {\r\n    return { ok: false, error: \"session_token_invalid\" };\r\n  }\r\n\r\n  if (!payload || typeof payload !== \"object\") return { ok: false, error: \"session_token_invalid\" };\r\n  if (typeof payload.uid !== \"string\" || !payload.uid) return { ok: false, error: \"session_token_invalid\" };\r\n  if (typeof payload.exp !== \"number\" || !Number.isFinite(payload.exp)) {\r\n    return { ok: false, error: \"session_token_invalid\" };\r\n  }\r\n\r\n  if (payload.sv != null) {\r\n    const sv = Number(payload.sv);\r\n    if (!Number.isFinite(sv) || sv < 0) return { ok: false, error: \"session_token_invalid\" };\r\n    payload.sv = Math.max(0, Math.trunc(sv));\r\n  }\r\n\r\n  const nowSec = Math.floor((opts.now ?? Date.now()) / 1000);\r\n  if (payload.exp <= nowSec) return { ok: false, error: \"session_token_expired\" };\r\n\r\n  return { ok: true, payload };\r\n}\r\n\r\n\r\nexport function serializeSessionCookie(opts: {\r\n  token: string;\r\n  maxAgeSeconds: number;\r\n  secure: boolean;\r\n}): string {\r\n  const parts = [\r\n    `${COOKIE_NAME}=${encodeURIComponent(opts.token)}`,\r\n    \"Path=/\",\r\n    \"HttpOnly\",\r\n    \"SameSite=Lax\",\r\n    `Max-Age=${Math.max(0, Math.floor(opts.maxAgeSeconds))}`,\r\n  ];\r\n  if (opts.secure) parts.push(\"Secure\");\r\n  return parts.join(\"; \");\r\n}\r\n\r\nexport function serializeClearSessionCookie(opts?: { secure?: boolean }): string {\r\n  const parts = [\r\n    `${COOKIE_NAME}=`,\r\n    \"Path=/\",\r\n    \"HttpOnly\",\r\n    \"SameSite=Lax\",\r\n    \"Max-Age=0\",\r\n  ];\r\n  if (opts?.secure) parts.push(\"Secure\");\r\n  return parts.join(\"; \");\r\n}\r\n","import { getSessionTokenFromRequest, verifySessionToken } from \"@/lib/auth/session\";\r\n\r\nconst isProd = process.env.NODE_ENV === \"production\";\r\nconst enforceAuth = isProd || process.env.ENFORCE_AUTH === \"1\";\r\n\r\n/**\r\n * Resolve the acting user identity from the request.\r\n *\r\n * In production (or when ENFORCE_AUTH=1), **only** the signed session cookie\r\n * or a valid internal service token is trusted.\r\n * In development, the `x-user-id` header is also accepted\r\n * (convenience for scripts/smoke tests).\r\n */\r\nexport function getActingUserId(request: Request): string | null {\r\n  // 1. Try signed session cookie first (always trusted).\r\n  const secret = process.env.PROOFPACK_SESSION_SECRET ?? \"\";\r\n  if (secret) {\r\n    const token = getSessionTokenFromRequest(request);\r\n    if (token) {\r\n      const verified = verifySessionToken({ token, secret });\r\n      if (verified.ok) return verified.payload.uid;\r\n    }\r\n  } else if (enforceAuth) {\r\n    // In production, refuse to operate without a session secret.\r\n    // This prevents silent auth bypass if the env var is unset.\r\n    console.error(\"[FATAL] PROOFPACK_SESSION_SECRET is not set in production!\");\r\n    return null;\r\n  }\r\n\r\n  // 2. Internal service-to-service calls (e.g. copy trading placing orders\r\n  //    on behalf of subscribers). Trusted in ALL environments when the\r\n  //    shared secret matches.\r\n  const internalSecret = process.env.INTERNAL_SERVICE_SECRET;\r\n  if (internalSecret) {\r\n    const headerSecret = request.headers.get(\"x-internal-service-token\");\r\n    if (headerSecret && headerSecret === internalSecret) {\r\n      const uid = request.headers.get(\"x-user-id\");\r\n      if (uid) return uid;\r\n    }\r\n  }\r\n\r\n  // 3. In dev only (without ENFORCE_AUTH), fall back to the x-user-id header.\r\n  if (!enforceAuth) {\r\n    const header = request.headers.get(\"x-user-id\");\r\n    if (header) return header;\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nexport function requireActingUserIdInProd(actingUserId: string | null): string | null {\r\n  if (enforceAuth && !actingUserId) {\r\n    return \"missing_x_user_id\";\r\n  }\r\n  return null;\r\n}\r\n\r\nexport function isParty(actingUserId: string | null, trade: { buyer_user_id: string; seller_user_id: string }): boolean {\r\n  if (!actingUserId) return false;\r\n  return actingUserId === trade.buyer_user_id || actingUserId === trade.seller_user_id;\r\n}\r\n","import type { Sql } from \"postgres\";\r\nimport { getActingUserId } from \"@/lib/auth/party\";\r\nimport { apiError } from \"@/lib/api/errors\";\r\nimport { getSessionTokenFromRequest, serializeClearSessionCookie } from \"@/lib/auth/session\";\r\n\r\nexport type AdminCheckResult =\r\n  | { ok: true; userId: string }\r\n  | { ok: false; error: string };\r\n\r\nexport type AdminApiCheckResult =\r\n  | { ok: true; userId: string }\r\n  | { ok: false; response: Response };\r\n\r\n/**\r\n * Require the request to come from a signed-in user with `role = 'admin'`.\r\n *\r\n * Returns the admin user ID on success (useful for audit trails).\r\n * In dev mode without ENFORCE_AUTH, falls back to the header identity\r\n * but still checks the DB role column.\r\n */\r\nexport async function requireAdmin(\r\n  sql: Sql,\r\n  request: Request,\r\n): Promise<AdminCheckResult> {\r\n  const userId = getActingUserId(request);\r\n  if (!userId) return { ok: false, error: \"auth_required\" };\r\n\r\n  const rows = await sql<{ role: string }[]>`\r\n    SELECT role FROM app_user WHERE id = ${userId}::uuid LIMIT 1\r\n  `;\r\n\r\n  if (rows.length === 0) return { ok: false, error: \"user_not_found\" };\r\n  if (rows[0]!.role !== \"admin\") return { ok: false, error: \"admin_required\" };\r\n\r\n  return { ok: true, userId };\r\n}\r\n\r\n/**\r\n * Wrapper for API route handlers.\r\n *\r\n * If the request has a session cookie that verifies but its uid no longer exists\r\n * (common after user cleanup), we clear the cookie and return `auth_required`\r\n * so the UI can re-login cleanly.\r\n */\r\nexport async function requireAdminForApi(\r\n  sql: Sql,\r\n  request: Request,\r\n): Promise<AdminApiCheckResult> {\r\n  const sessionToken = getSessionTokenFromRequest(request);\r\n  const secure = process.env.NODE_ENV === \"production\";\r\n\r\n  const admin = await requireAdmin(sql, request);\r\n  if (admin.ok) return admin;\r\n\r\n  if (admin.error === \"user_not_found\" || admin.error === \"auth_required\") {\r\n    const headers: HeadersInit | undefined = sessionToken\r\n      ? { \"set-cookie\": serializeClearSessionCookie({ secure }) }\r\n      : undefined;\r\n    return { ok: false, response: apiError(\"auth_required\", { headers }) };\r\n  }\r\n\r\n  return { ok: false, response: apiError(admin.error) };\r\n}\r\n","/**\r\n * BEP-20 Token interactions on BSC\r\n *\r\n * Provides balance checks, transfer functions, and deposit detection\r\n * for USDT and native BNB.\r\n */\r\nimport { ethers } from \"ethers\";\r\nimport { getBscProvider, getBscReadProvider } from \"./wallet\";\r\nimport { isLikelyRpcTransportError, markRpcFail, markRpcOk, rankRpcUrls } from \"@/lib/blockchain/rpcHealth\";\r\n\r\n// ── Standard BEP-20 ABI (minimal) ───────────────────────────────────\r\nconst ERC20_ABI = [\r\n  \"function balanceOf(address owner) view returns (uint256)\",\r\n  \"function transfer(address to, uint256 amount) returns (bool)\",\r\n  \"function decimals() view returns (uint8)\",\r\n  \"function symbol() view returns (string)\",\r\n  \"event Transfer(address indexed from, address indexed to, uint256 value)\",\r\n] as const;\r\n\r\n// ── Known contract addresses ─────────────────────────────────────────\r\nexport type KnownToken = \"USDT\" | \"BNB\";\r\n\r\nconst MAINNET_TOKENS: Record<string, string> = {\r\n  USDT: \"0x55d398326f99059fF775485246999027B3197955\", // BSC-USD (Binance-Peg)\r\n};\r\n\r\nconst TESTNET_TOKENS: Record<string, string> = {\r\n  USDT: \"0x337610d27c682E347C9cD60BD4b3b107C9d34dDd\", // Testnet USDT mock\r\n};\r\n\r\nexport function getTokenAddress(symbol: string): string | null {\r\n  const isMainnet = process.env.NEXT_PUBLIC_USE_MAINNET !== \"false\";\r\n  const tokens = isMainnet ? MAINNET_TOKENS : TESTNET_TOKENS;\r\n  return tokens[symbol.toUpperCase()] ?? null;\r\n}\r\n\r\n// ── Balance queries ──────────────────────────────────────────────────\r\n\r\n/** Get native BNB balance */\r\nexport async function getBnbBalance(address: string): Promise<string> {\r\n  const provider = getBscReadProvider();\r\n  const bal = await provider.getBalance(address);\r\n  return ethers.formatEther(bal);\r\n}\r\n\r\n/** Get BEP-20 token balance */\r\nexport async function getTokenBalance(\r\n  tokenAddress: string,\r\n  walletAddress: string,\r\n): Promise<{ balance: string; decimals: number }> {\r\n  const provider = getBscReadProvider();\r\n  const contract = new ethers.Contract(tokenAddress, ERC20_ABI, provider);\r\n  const [bal, decimals] = await Promise.all([\r\n    contract.balanceOf(walletAddress) as Promise<bigint>,\r\n    contract.decimals() as Promise<number>,\r\n  ]);\r\n  return {\r\n    balance: ethers.formatUnits(bal, decimals),\r\n    decimals,\r\n  };\r\n}\r\n\r\n/** Get all known token balances for a wallet */\r\nexport async function getAllBalances(walletAddress: string): Promise<\r\n  { symbol: string; balance: string; contractAddress: string | null }[]\r\n> {\r\n  const results: { symbol: string; balance: string; contractAddress: string | null }[] = [];\r\n\r\n  // BNB (native)\r\n  try {\r\n    const bnb = await getBnbBalance(walletAddress);\r\n    results.push({ symbol: \"BNB\", balance: bnb, contractAddress: null });\r\n  } catch {\r\n    results.push({ symbol: \"BNB\", balance: \"0\", contractAddress: null });\r\n  }\r\n\r\n  // BEP-20 tokens\r\n  for (const symbol of [\"USDT\"] as const) {\r\n    const addr = getTokenAddress(symbol);\r\n    if (!addr) continue;\r\n    try {\r\n      const { balance } = await getTokenBalance(addr, walletAddress);\r\n      results.push({ symbol, balance, contractAddress: addr });\r\n    } catch {\r\n      results.push({ symbol, balance: \"0\", contractAddress: addr });\r\n    }\r\n  }\r\n\r\n  return results;\r\n}\r\n\r\n// ── Transfer functions ───────────────────────────────────────────────\r\n\r\n/** Send BEP-20 tokens from a wallet (requires private key) */\r\nexport async function sendToken(\r\n  tokenAddress: string,\r\n  privateKey: string,\r\n  to: string,\r\n  amount: string,\r\n  decimals: number = 18,\r\n): Promise<{ txHash: string }> {\r\n  // Prefer multi-RPC failover when BSC_RPC_URLS is configured.\r\n  const urls = rankRpcUrls(\"bsc\");\r\n  const chainId = Number(process.env.NEXT_PUBLIC_USE_MAINNET) === 0 ? 97 : 56;\r\n  const network = ethers.Network.from({ name: \"bnb\", chainId });\r\n\r\n  const amountWei = ethers.parseUnits(amount, decimals);\r\n  let lastErr: unknown = null;\r\n\r\n  // If only one URL is configured, keep the historical behavior.\r\n  if (urls.length <= 1) {\r\n    const provider = getBscProvider();\r\n    const signer = new ethers.Wallet(privateKey, provider);\r\n    const contract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);\r\n    const tx = (await contract.transfer(to, amountWei)) as ethers.TransactionResponse;\r\n    await tx.wait(1);\r\n    return { txHash: tx.hash };\r\n  }\r\n\r\n  for (const url of urls) {\r\n    const provider = new ethers.JsonRpcProvider(url, network, { staticNetwork: network });\r\n    const signer = new ethers.Wallet(privateKey, provider);\r\n    const contract = new ethers.Contract(tokenAddress, ERC20_ABI, signer);\r\n    const t0 = Date.now();\r\n    try {\r\n      const tx = (await contract.transfer(to, amountWei)) as ethers.TransactionResponse;\r\n      markRpcOk(url, Date.now() - t0);\r\n      // Waiting can fail due to transport issues even when the tx broadcast succeeded.\r\n      await tx.wait(1).catch(() => undefined);\r\n      return { txHash: tx.hash };\r\n    } catch (e) {\r\n      markRpcFail(url);\r\n      lastErr = e;\r\n      if (!isLikelyRpcTransportError(e)) throw e;\r\n    }\r\n  }\r\n\r\n  throw lastErr instanceof Error ? lastErr : new Error(\"bsc_rpc_all_failed\");\r\n}\r\n\r\n/** Send native BNB */\r\nexport async function sendBnb(\r\n  privateKey: string,\r\n  to: string,\r\n  amount: string,\r\n): Promise<{ txHash: string }> {\r\n  const urls = rankRpcUrls(\"bsc\");\r\n  const chainId = Number(process.env.NEXT_PUBLIC_USE_MAINNET) === 0 ? 97 : 56;\r\n  const network = ethers.Network.from({ name: \"bnb\", chainId });\r\n\r\n  const value = ethers.parseEther(amount);\r\n  let lastErr: unknown = null;\r\n\r\n  if (urls.length <= 1) {\r\n    const provider = getBscProvider();\r\n    const signer = new ethers.Wallet(privateKey, provider);\r\n    const tx = await signer.sendTransaction({ to, value });\r\n    await tx.wait(1);\r\n    return { txHash: tx.hash };\r\n  }\r\n\r\n  for (const url of urls) {\r\n    const provider = new ethers.JsonRpcProvider(url, network, { staticNetwork: network });\r\n    const signer = new ethers.Wallet(privateKey, provider);\r\n    const t0 = Date.now();\r\n    try {\r\n      const tx = await signer.sendTransaction({ to, value });\r\n      markRpcOk(url, Date.now() - t0);\r\n      await tx.wait(1).catch(() => undefined);\r\n      return { txHash: tx.hash };\r\n    } catch (e) {\r\n      markRpcFail(url);\r\n      lastErr = e;\r\n      if (!isLikelyRpcTransportError(e)) throw e;\r\n    }\r\n  }\r\n\r\n  throw lastErr instanceof Error ? lastErr : new Error(\"bsc_rpc_all_failed\");\r\n}\r\n","/**\r\n * Hot Wallet accessor for withdrawal broadcasting.\r\n *\r\n * The hot wallet is defined by DEPLOYER_PRIVATE_KEY in .env.\r\n * It holds a minimized float and is only accessed server-side.\r\n *\r\n * AI never signs transactions.  AI never directly moves money.\r\n * Only this module and the broadcast handler touch the private key.\r\n */\r\nimport { ethers } from \"ethers\";\r\n\r\nlet _cachedAddress: string | null = null;\r\nlet _cachedKey: string | null = null;\r\n\r\nfunction getEnvKey(): string {\r\n  const k = process.env.DEPLOYER_PRIVATE_KEY;\r\n  if (!k) throw new Error(\"DEPLOYER_PRIVATE_KEY is not set\");\r\n  return k.startsWith(\"0x\") ? k : `0x${k}`;\r\n}\r\n\r\n/** Get the hot wallet address (public, safe to log). */\r\nexport function getHotWalletAddress(): string {\r\n  if (!_cachedAddress) {\r\n    const wallet = new ethers.Wallet(getEnvKey());\r\n    _cachedAddress = wallet.address.toLowerCase();\r\n  }\r\n  return _cachedAddress;\r\n}\r\n\r\n/**\r\n * Get the hot wallet private key.\r\n * NEVER log this value. Callers must use it only inside sendToken / sendBnb.\r\n */\r\nexport function getHotWalletKey(): string {\r\n  if (!_cachedKey) {\r\n    _cachedKey = getEnvKey();\r\n  }\r\n  return _cachedKey;\r\n}\r\n"],"names":[],"mappings":"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"}