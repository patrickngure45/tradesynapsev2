module.exports=[276550,e=>{"use strict";var t=e.i(747909),r=e.i(174017),n=e.i(996250),a=e.i(759756),i=e.i(561916),s=e.i(174677),o=e.i(869741),l=e.i(316795),d=e.i(487718),c=e.i(995169),u=e.i(47587),p=e.i(666012),h=e.i(570101),_=e.i(626937),m=e.i(10372),g=e.i(193695);e.i(52474);var f=e.i(600220),E=e.i(469719),x=e.i(56778),y=e.i(843793),R=e.i(300959),v=e.i(184883),b=e.i(977775),w=e.i(364608),A=e.i(315569),S=e.i(901323),N=e.i(831075),T=e.i(90878),C=e.i(371276);let O=null,I=E.z.object({tx_hash:E.z.string().min(10),chain:E.z.literal("bsc").optional().default("bsc"),confirmations_required:E.z.number().int().min(0).max(200).optional()});function k(e){return String(e||"").trim().toLowerCase()}let D=x.ethers.id("Transfer(address,address,uint256)"),P=new x.ethers.Interface(["event Transfer(address indexed from, address indexed to, uint256 value)"]);async function M(e,t){let r=String(t??"").trim();if(!r)return null;try{let t=await e.getCode(r);if(!t)return null;return"0x"!==String(t).toLowerCase()}catch{return null}}async function q(e){let t=Date.now(),r=(0,y.getSql)(),n=(0,b.getActingUserId)(e),a=(r,a)=>{try{(0,C.logRouteResponse)(e,r,{startMs:t,userId:n,meta:a})}catch{}return r},i=(0,b.requireActingUserIdInProd)(n);if(i)return a((0,R.apiError)(i,{status:401}),{code:i});if(!n)return a((0,R.apiError)("missing_x_user_id",{status:401}),{code:"missing_x_user_id"});let s=await (0,v.retryOnceOnTransientDbError)(()=>(0,A.resolveReadOnlyUserScope)(r,e,n));if(!s.ok)return a((0,R.apiError)(s.error,{status:403}),{code:s.error});let o=s.scope.userId;try{let t,i;try{if(!(await (function(e){if(O)return O;let t=Number(String(process.env.EXCHANGE_DEPOSIT_TRACE_MAX_PER_MIN??"20").trim()),r=Number.isFinite(t)&&t>0?Math.trunc(t):20;return O=(0,N.createPgRateLimiter)(e,{name:"exchange-deposit-trace",windowMs:6e4,max:r})})(r).consume(`u:${o}`)).allowed)return a((0,R.apiError)("rate_limit_exceeded",{status:429}),{code:"rate_limit_exceeded"})}catch{}let s=await e.json().catch(()=>({}));try{t=I.parse(s)}catch(e){return a((0,R.apiZodError)(e)??(0,R.apiError)("invalid_input",{status:400}),{code:"invalid_input"})}try{let a=(0,T.auditContextFromRequest)(e);await (0,T.writeAuditLog)(r,{actorId:n,actorType:"user",action:"exchange.deposits.trace",resourceType:"deposit_trace",resourceId:String(t.tx_hash??"").trim()||null,ip:a.ip,userAgent:a.userAgent,requestId:a.requestId,detail:{scope_user_id:o,chain:t.chain,tx_hash:String(t.tx_hash??"").trim(),confirmations_required:t.confirmations_required??null}})}catch{}let l=String(t.tx_hash||"").trim();if(i=String(l||"").trim(),!/^0x[0-9a-fA-F]{64}$/.test(i))return a((0,R.apiError)("invalid_tx_hash",{status:400}),{code:"invalid_tx_hash"});let d=String(process.env.BSC_DEPOSIT_CONFIRMATIONS??"2").trim(),c=Number(d),u=Number.isFinite(c)?Math.trunc(c):2,p=Math.max(0,Math.min(200,Math.trunc(null!=t.confirmations_required?t.confirmations_required:u))),h=await (0,v.retryOnceOnTransientDbError)(()=>(0,w.requireActiveUser)(r,o));if(h)return a((0,R.apiError)(h),{code:h});let _=await (0,v.retryOnceOnTransientDbError)(async()=>await r`
        SELECT address
        FROM ex_deposit_address
        WHERE chain = 'bsc'
          AND status = 'active'
          AND user_id = ${o}::uuid
        ORDER BY created_at DESC
        LIMIT 1
      `),m=_[0]?.address?k(_[0].address):"";if(!m)return a((0,R.apiError)("deposit_address_missing",{status:400}),{code:"deposit_address_missing"});let g=(0,S.getBscReadProvider)(),[f,E,y,b]=await Promise.all([g.getBlockNumber().catch(()=>null),g.getTransaction(l).catch(()=>null),g.getTransactionReceipt(l).catch(()=>null),(0,v.retryOnceOnTransientDbError)(async()=>await r`
          SELECT
            e.id,
            e.tx_hash,
            e.log_index,
            e.block_number,
            e.from_address,
            e.to_address,
            e.amount::text AS amount,
            a.symbol AS asset_symbol,
            a.decimals AS asset_decimals,
            e.journal_entry_id::text AS journal_entry_id,
            e.created_at::text AS created_at
          FROM ex_chain_deposit_event e
          JOIN ex_asset a ON a.id = e.asset_id
          WHERE e.chain = 'bsc'
            AND e.user_id = ${o}::uuid
            AND e.tx_hash = ${l}
          ORDER BY e.log_index ASC
        `).catch(()=>[])]),A=E?.to?k(E.to):"",C=E?.from?k(E.from):null,q="bigint"==typeof E?.value?E.value:0n,U=y?.blockNumber!=null?Number(y.blockNumber):null,H="number"==typeof y?.status?y.status:null,F=null!=f&&null!=U&&Number.isFinite(U)&&U>0?Math.max(0,Number(f)-U+1):0,L=!!(A&&A===m&&q>0n),$=[];if(y&&Array.isArray(y.logs))for(let e of y.logs)try{if(String(e?.topics?.[0]??"")!==D)continue;let t=P.decodeEventLog("Transfer",e.data,e.topics),r=t?.to?k(String(t.to)):"";if(!r||r!==m)continue;let n=t?.from?k(String(t.from)):null,a="bigint"==typeof t?.value?t.value:0n;if(a<=0n)continue;$.push({contract:k(String(e.address??"")),from:n,to:r,value_wei:a.toString(),log_index:"number"==typeof e?.logIndex?e.logIndex:null})}catch{}let j=Array.from(new Set($.map(e=>e.contract).filter(Boolean))),B=j.length?await (0,v.retryOnceOnTransientDbError)(async()=>await r`
            SELECT symbol, decimals, contract_address
            FROM ex_asset
            WHERE chain = 'bsc'
              AND contract_address IS NOT NULL
              AND lower(contract_address) = ANY(${j})
          `).catch(()=>[]):[],K=new Map;for(let e of B)K.set(k(e.contract_address),{symbol:e.symbol,decimals:e.decimals});let W=$.map(e=>{let t=K.get(e.contract),r=t?.decimals??18,n=x.ethers.formatUnits(BigInt(e.value_wei),r);return{kind:"token",asset_symbol:t?.symbol??"UNKNOWN",contract:e.contract,amount:n,log_index:e.log_index}}),z=L?[{kind:"native",asset_symbol:"BNB",amount:x.ethers.formatEther(q),log_index:null}]:[],X=L||W.length>0||Array.isArray(b)&&b.length>0,G=Array.isArray(b)&&b.some(e=>!!e.journal_entry_id),V=Array.isArray(b)&&b.length>0,Y=X?G?"credited":V?"seen":"pending":"not_ours",Z=null==H?null:1===H,J="not_ours"!==Y&&"pending"!==Y||y||V?Y:"pending",Q=y&&E?.to&&"not_ours"===J&&!V&&!L&&0===W.length?await M(g,E.to):null,ee=y||E?0===H?{kind:"reverted_tx",message:"This transaction reverted on-chain (status=0), so it did not complete."}:"not_ours"===J&&y?V||L||0!==W.length?null:E?.to?!0===Q?{kind:"contract_interaction_no_transfer_logs",tx_to_is_contract:!0,message:"This transaction is a contract interaction. If you expected a deposit, you must send directly to your deposit address. Internal transfers from contracts may not be detectable without tracing support."}:{kind:"no_matching_transfers",message:"No native transfer or token Transfer logs were found to your active deposit address in this tx."}:{kind:"contract_creation_or_missing_to",message:"This transaction has no 'to' address (contract creation). It does not look like a direct deposit to your address."}:null:null,et=Response.json({ok:!0,chain:"bsc",tx_hash:l,verdict:J,deposit_address:m,tip:f,receipt:{found:!!(y||E),status:H,block_number:U,confirmations:F,confirmations_required:p},tx:E?{from:C,to:A||null,value_wei:q.toString(),...null!=Q?{to_is_contract:Q}:{}}:null,matches:{native:z,token:W},events:b,can_post:"credited"!==Y&&X&&!1!==Z&&(0===p||F>=p),...ee?{diagnostic:ee}:{}});return a(et,{ok:!0,verdict:J,scope_user_id:o})}catch(r){let e=(0,v.responseForDbError)("exchange.deposits.trace",r);if(e)return a(e,{code:"db_error"});let t=r instanceof Error?r.message:String(r);return a((0,R.apiError)("internal_error",{details:{message:t}}),{code:"internal_error"})}}e.s(["POST",()=>q,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],6139);var U=e.i(6139);let H=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/exchange/deposits/trace/route",pathname:"/api/exchange/deposits/trace",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/deposits/trace/route.ts",nextConfigOutput:"",userland:U}),{workAsyncStorage:F,workUnitAsyncStorage:L,serverHooks:$}=H;function j(){return(0,n.patchFetch)({workAsyncStorage:F,workUnitAsyncStorage:L})}async function B(e,t,n){H.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/exchange/deposits/trace/route";E=E.replace(/\/index$/,"")||"/";let x=await H.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:y,params:R,nextConfig:v,parsedUrl:b,isDraftMode:w,prerenderManifest:A,routerServerContext:S,isOnDemandRevalidate:N,revalidateOnlyGenerated:T,resolvedPathname:C,clientReferenceManifest:O,serverActionsManifest:I}=x,k=(0,o.normalizeAppPath)(E),D=!!(A.dynamicRoutes[k]||A.routes[C]),P=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,b,!1):t.end("This page could not be found"),null);if(D&&!w){let e=!!A.routes[C],t=A.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await P();throw new g.NoFallbackError}}let M=null;!D||H.isDev||w||(M="/index"===(M=C)?"/":M);let q=!0===H.isDev||!D,U=D&&!q;I&&O&&(0,s.setManifestsSingleton)({page:E,clientReferenceManifest:O,serverActionsManifest:I});let F=e.method||"GET",L=(0,i.getTracer)(),$=L.getActiveScopeSpan(),j={params:R,prerenderManifest:A,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,a)=>H.onRequestError(e,t,n,a,S)},sharedContext:{buildId:y}},B=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(B,(0,d.signalFromNodeResponse)(t));try{let s=async e=>H.handle(W,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${F} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${E}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&N&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(a);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=j.renderOpts.collectedTags;if(!D)return await (0,p.sendResponse)(B,K,i,j.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[m.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=m.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,n=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=m.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await H.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})},!1,S),t}},c=await H.handleResponse({req:e,nextConfig:v,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:A,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:o});if(!D)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let g=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&D||g.delete(m.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||g.get("Cache-Control")||g.set("Cache-Control",(0,_.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(B,K,new Response(c.value.body,{headers:g,status:c.value.status||200})),null};$?await l($):await L.withPropagatedContext(e.headers,()=>L.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${E}`,kind:i.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await H.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:N})},!1,S),D)throw t;return await (0,p.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>B,"patchFetch",()=>j,"routeModule",()=>H,"serverHooks",()=>$,"workAsyncStorage",()=>F,"workUnitAsyncStorage",()=>L],276550)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_56c096ec.js.map