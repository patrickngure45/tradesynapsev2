module.exports=[246219,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),s=e.i(869741),u=e.i(316795),l=e.i(487718),d=e.i(995169),p=e.i(47587),c=e.i(666012),_=e.i(570101),m=e.i(626937),E=e.i(10372),h=e.i(193695);e.i(52474);var g=e.i(600220),w=e.i(469719),f=e.i(300959),R=e.i(364608),y=e.i(977775),x=e.i(795374),v=e.i(843793),A=e.i(184883),b=e.i(630862),S=e.i(939249);let T=w.z.object({limit:w.z.coerce.number().int().min(1).max(200).optional(),market_id:w.z.string().uuid().optional()}),O=w.z.object({market_id:w.z.string().uuid(),side:w.z.enum(["buy","sell"]),total_quantity:w.z.string().min(1).max(80),slice_count:w.z.coerce.number().int().min(2).max(50),interval_sec:w.z.coerce.number().int().min(10).max(86400),first_run_in_sec:w.z.coerce.number().int().min(1).max(3600).optional().default(5),totp_code:w.z.string().length(6).regex(/^\d{6}$/).optional()}),I=w.z.object({id:w.z.string().uuid(),status:w.z.enum(["active","paused","canceled"]),totp_code:w.z.string().length(6).regex(/^\d{6}$/).optional()});function C(){let e=Number(String(process.env.EXCHANGE_AUTOMATION_AUTH_TTL_SEC??"").trim()||"2592000");return!Number.isFinite(e)||e<=0?2592e3:Math.max(3600,Math.min(e,15552e3))}async function q(e){let t,r=new URL(e.url);try{t=T.parse({limit:r.searchParams.get("limit")??void 0,market_id:r.searchParams.get("market_id")??void 0})}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}let a=(0,v.getSql)(),i=(0,y.getActingUserId)(e),n=(0,y.requireActingUserIdInProd)(i);if(n)return(0,f.apiError)(n);if(!i)return(0,f.apiError)("unauthorized",{status:401});try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,R.requireActiveUser)(a,i));if(e)return(0,f.apiError)(e);let r=t.limit??50,n=await (0,A.retryOnceOnTransientDbError)(async()=>await a`
        SELECT
          p.id::text AS id,
          p.status,
          p.market_id::text AS market_id,
          m.symbol AS market_symbol,
          p.side,
          p.total_quantity::text AS total_quantity,
          p.remaining_quantity::text AS remaining_quantity,
          p.slice_quantity::text AS slice_quantity,
          p.interval_sec,
          p.next_run_at::text AS next_run_at,
          p.last_run_at::text AS last_run_at,
          p.auth_expires_at::text AS auth_expires_at,
          p.last_run_status,
          p.last_run_error,
          p.created_at::text AS created_at,
          p.updated_at::text AS updated_at
        FROM app_twap_plan p
        JOIN ex_market m ON m.id = p.market_id
        WHERE p.user_id = ${i}::uuid
          ${t.market_id?a`AND p.market_id = ${t.market_id}::uuid`:a``}
        ORDER BY p.created_at DESC
        LIMIT ${r}
      `);return Response.json({plans:n,limit:r})}catch(t){let e=(0,A.responseForDbError)("exchange.twap.list",t);if(e)return e;throw t}}async function N(e){let t,r,a=(0,v.getSql)(),i=(0,y.getActingUserId)(e),n=(0,y.requireActingUserIdInProd)(i);if(n)return(0,f.apiError)(n);if(!i)return(0,f.apiError)("missing_x_user_id");try{t=await e.json()}catch{return(0,f.apiError)("invalid_input")}try{r=O.parse(t)}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}try{let e,t,n=await (0,A.retryOnceOnTransientDbError)(()=>(0,R.requireActiveUser)(a,i));if(n)return(0,f.apiError)(n);let o=await (0,x.enforceTotpIfEnabled)(a,i,r.totp_code);if(o)return o;let s=(await (0,A.retryOnceOnTransientDbError)(async()=>await a`
        SELECT id::text AS id, lot_size::text AS lot_size
        FROM ex_market
        WHERE id = ${r.market_id}::uuid
          AND status = 'enabled'
        LIMIT 1
      `))[0];if(!s)return(0,f.apiError)("market_not_found",{status:404});let u=String(s.lot_size??"0.00000001");try{if(e=(0,S.quantizeDownToStep3818)(String(r.total_quantity),u),0n>=(0,b.toBigInt3818)(e))return(0,f.apiError)("invalid_input",{status:400,details:"quantity_too_small"});let a=(0,b.toBigInt3818)(e),i=BigInt(r.slice_count),n=a/i;if(n<=0n||(t=(0,S.quantizeDownToStep3818)((0,b.fromBigInt3818)(n),u),0n>=(0,b.toBigInt3818)(t)))return(0,f.apiError)("invalid_input",{status:400,details:"slice_too_small"})}catch{return(0,f.apiError)("invalid_input",{status:400,details:"invalid_quantity"})}let l=await (0,A.retryOnceOnTransientDbError)(async()=>await a`
        SELECT totp_enabled
        FROM app_user
        WHERE id = ${i}::uuid
        LIMIT 1
      `),d=l[0]?.totp_enabled?new Date(Date.now()+1e3*C()):null,p=new Date(Date.now()+1e3*Math.max(1,r.first_run_in_sec)),c=await a.begin(async a=>{let n=await a`
        INSERT INTO app_twap_plan (
          user_id,
          market_id,
          side,
          status,
          total_quantity,
          remaining_quantity,
          slice_quantity,
          interval_sec,
          next_run_at,
          auth_expires_at
        )
        VALUES (
          ${i}::uuid,
          ${r.market_id}::uuid,
          ${r.side},
          'active',
          ${e}::numeric(38,18),
          ${e}::numeric(38,18),
          ${t}::numeric(38,18),
          ${r.interval_sec},
          ${p.toISOString()}::timestamptz,
          ${d?d.toISOString():null}::timestamptz
        )
        RETURNING id::text AS id
      `;return{status:201,body:{ok:!0,id:n[0].id}}});return Response.json(c.body,{status:c.status})}catch(t){let e=(0,A.responseForDbError)("exchange.twap.create",t);if(e)return e;throw t}}async function D(e){let t,r,a=(0,v.getSql)(),i=(0,y.getActingUserId)(e),n=(0,y.requireActingUserIdInProd)(i);if(n)return(0,f.apiError)(n);if(!i)return(0,f.apiError)("missing_x_user_id");try{t=await e.json()}catch{return(0,f.apiError)("invalid_input")}try{r=I.parse(t)}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}try{let e=await (0,A.retryOnceOnTransientDbError)(()=>(0,R.requireActiveUser)(a,i));if(e)return(0,f.apiError)(e);if("active"===r.status){let e=await (0,x.enforceTotpIfEnabled)(a,i,r.totp_code);if(e)return e}let t=await a.begin(async e=>{let t=await e`
        SELECT p.user_id::text AS user_id, u.totp_enabled
        FROM app_twap_plan p
        JOIN app_user u ON u.id = p.user_id
        WHERE p.id = ${r.id}::uuid
        LIMIT 1
        FOR UPDATE
      `;if(!t.length)return{status:404,body:{error:"not_found"}};if(t[0].user_id!==i)return{status:403,body:{error:"actor_not_allowed"}};let a=null;return"active"===r.status&&t[0].totp_enabled&&(a=new Date(Date.now()+1e3*C()).toISOString()),await e`
        UPDATE app_twap_plan
        SET status = ${r.status},
            auth_expires_at = ${a}::timestamptz,
            updated_at = now()
        WHERE id = ${r.id}::uuid
      `,{status:200,body:{ok:!0}}}),n=t.body;if(n?.error)return(0,f.apiError)(n.error,{status:t.status});return Response.json(t.body,{status:t.status})}catch(t){let e=(0,A.responseForDbError)("exchange.twap.patch",t);if(e)return e;throw t}}e.s(["GET",()=>q,"PATCH",()=>D,"POST",()=>N,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],863443);var k=e.i(863443);let P=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/exchange/twap/route",pathname:"/api/exchange/twap",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/twap/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:U,workUnitAsyncStorage:$,serverHooks:z}=P;function H(){return(0,a.patchFetch)({workAsyncStorage:U,workUnitAsyncStorage:$})}async function M(e,t,a){P.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/exchange/twap/route";w=w.replace(/\/index$/,"")||"/";let f=await P.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:R,params:y,nextConfig:x,parsedUrl:v,isDraftMode:A,prerenderManifest:b,routerServerContext:S,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,resolvedPathname:I,clientReferenceManifest:C,serverActionsManifest:q}=f,N=(0,s.normalizeAppPath)(w),D=!!(b.dynamicRoutes[N]||b.routes[I]),k=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,v,!1):t.end("This page could not be found"),null);if(D&&!A){let e=!!b.routes[I],t=b.dynamicRoutes[N];if(t&&!1===t.fallback&&!e){if(x.experimental.adapterPath)return await k();throw new h.NoFallbackError}}let U=null;!D||P.isDev||A||(U="/index"===(U=I)?"/":U);let $=!0===P.isDev||!D,z=D&&!$;q&&C&&(0,o.setManifestsSingleton)({page:w,clientReferenceManifest:C,serverActionsManifest:q});let H=e.method||"GET",M=(0,n.getTracer)(),F=M.getActiveScopeSpan(),j={params:y,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,i)=>P.onRequestError(e,t,a,i,S)},sharedContext:{buildId:R}},L=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),K=l.NextRequestAdapter.fromNodeNextRequest(L,(0,l.signalFromNodeResponse)(t));try{let o=async e=>P.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${w}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),u=async i=>{var n,u;let l=async({previousCacheEntry:r})=>{try{if(!s&&T&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let u=j.renderOpts.pendingWaitUntil;u&&a.waitUntil&&(a.waitUntil(u),u=void 0);let l=j.renderOpts.collectedTags;if(!D)return await (0,c.sendResponse)(L,B,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);l&&(t[E.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:T})},!1,S),t}},d=await P.handleResponse({req:e,nextConfig:x,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:O,responseGenerator:l,waitUntil:a.waitUntil,isMinimalMode:s});if(!D)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",T?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&D||h.delete(E.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(L,B,new Response(d.value.body,{headers:h,status:d.value.status||200})),null};F?await u(F):await M.withPropagatedContext(e.headers,()=>M.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},u))}catch(t){if(t instanceof h.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:N,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:z,isOnDemandRevalidate:T})},!1,S),D)throw t;return await (0,c.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>H,"routeModule",()=>P,"serverHooks",()=>z,"workAsyncStorage",()=>U,"workUnitAsyncStorage",()=>$],246219)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_f9a9e4a7.js.map