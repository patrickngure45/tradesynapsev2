module.exports=[498253,e=>{"use strict";var t=e.i(747909),E=e.i(174017),a=e.i(996250),T=e.i(759756),r=e.i(561916),s=e.i(174677),n=e.i(869741),o=e.i(316795),i=e.i(487718),N=e.i(995169),c=e.i(47587),l=e.i(666012),A=e.i(570101),I=e.i(626937),C=e.i(10372),_=e.i(193695);e.i(52474);var d=e.i(600220),u=e.i(89171),R=e.i(469719),p=e.i(843793),D=e.i(583627),S=e.i(300959),U=e.i(184883);let L=R.z.object({confirm:R.z.literal("RESET_EVERYTHING"),reset_assets:R.z.boolean().optional().default(!0)});async function g(e){let t=Date.now(),E=(0,p.getSql)(),a=[],T=await (0,D.requireAdminForApi)(E,e);if(!T.ok)return T.response;let r=function(e){let t=process.env.ADMIN_RESET_SECRET??process.env.RESET_SECRET;if(!t)return"reset_secret_not_configured";let E=e.headers.get("x-reset-secret")??e.nextUrl.searchParams.get("secret");return E&&E===t?null:"reset_unauthorized"}(e);if(r)return(0,S.apiError)(r,{status:"reset_unauthorized"===r?401:500});let s=await e.json().catch(()=>({})),n=L.safeParse(s);if(!n.success)return(0,S.apiError)("invalid_input",{status:400});for(let e=1;e<=3;e+=1){a.splice(0,a.length);try{let r=await E.begin(async e=>{try{await e`SET LOCAL lock_timeout = '5s'`}catch{}let t=async(e,t)=>{try{await t(),a.push({step:e,ok:!0})}catch(t){throw a.push({step:e,ok:!1,detail:t instanceof Error?t.message:String(t)}),t}};return n.data.reset_assets&&await t("truncate:assets",async()=>{await e`DO $$ BEGIN
            IF to_regclass('ex_asset') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_asset RESTART IDENTITY CASCADE'; END IF;
          END $$;`}),await t("truncate:p2p",async()=>{await e`DO $$ BEGIN
          IF to_regclass('p2p_chat_message') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_chat_message RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('p2p_feedback') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_feedback RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('p2p_dispute') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_dispute RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('p2p_order') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_order RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('p2p_ad') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_ad RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('p2p_payment_method') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE p2p_payment_method RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:notifications",async()=>{await e`DO $$ BEGIN
          IF to_regclass('ex_notification') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_notification RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:outbox+signals",async()=>{await e`DO $$ BEGIN
          IF to_regclass('app_outbox_event') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE app_outbox_event RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('app_signal') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE app_signal RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:bots",async()=>{await e`DO $$ BEGIN IF to_regclass('trading_bot_execution') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE trading_bot_execution RESTART IDENTITY CASCADE'; END IF; END $$;`}),await t("truncate:legacy",async()=>{await e`DO $$ BEGIN
          IF to_regclass('message') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE message RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('trade_state_transition') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE trade_state_transition RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('trade') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE trade RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('dispute_decision') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE dispute_decision RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('dispute') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE dispute RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('risk_assessment') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE risk_assessment RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('evidence_object') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE evidence_object RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('onchain_tx') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE onchain_tx RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('market_snapshot') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE market_snapshot RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('counterparty_profile') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE counterparty_profile RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('wallet') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE wallet RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:connections+copytrade+arb",async()=>{await e`DO $$ BEGIN
          IF to_regclass('user_exchange_connection') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE user_exchange_connection RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('copy_trading_subscription') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE copy_trading_subscription RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('copy_trading_leader') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE copy_trading_leader RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('arb_price_snapshot') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE arb_price_snapshot RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:compliance+email+rate",async()=>{await e`DO $$ BEGIN
          IF to_regclass('email_verification_token') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE email_verification_token RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('kyc_submission') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE kyc_submission RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('rate_limit_bucket') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE rate_limit_bucket RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:audit",async()=>{await e`DO $$ BEGIN IF to_regclass('audit_log') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE audit_log RESTART IDENTITY CASCADE'; END IF; END $$;`}),await t("truncate:exchange-core",async()=>{await e`DO $$ BEGIN
          IF to_regclass('ex_chain_tx') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_chain_tx RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_chain_block') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_chain_block RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_chain_deposit_event') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_chain_deposit_event RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_chain_deposit_cursor') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_chain_deposit_cursor RESTART IDENTITY CASCADE'; END IF;

          IF to_regclass('ex_withdrawal_request') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_withdrawal_request RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_withdrawal_allowlist') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_withdrawal_allowlist RESTART IDENTITY CASCADE'; END IF;

          IF to_regclass('ex_execution') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_execution RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_order') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_order RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_market') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_market RESTART IDENTITY CASCADE'; END IF;

          IF to_regclass('ex_hold') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_hold RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_journal_line') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_journal_line RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_journal_entry') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_journal_entry RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_ledger_account') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_ledger_account RESTART IDENTITY CASCADE'; END IF;
          IF to_regclass('ex_deposit_address') IS NOT NULL THEN EXECUTE 'TRUNCATE TABLE ex_deposit_address RESTART IDENTITY CASCADE'; END IF;
        END $$;`}),await t("truncate:fx",async()=>{await e`DO $$ BEGIN IF to_regclass('fx_reference_rate') IS NOT NULL THEN TRUNCATE TABLE fx_reference_rate RESTART IDENTITY; END IF; END $$;`}),{ok:!0,admin_user_id:T.userId,steps:a}});return u.NextResponse.json({...r,attempt:e,took_ms:Date.now()-t,note:"Users preserved; all balances/orders/ads/notifications/outbox/assets cleared."})}catch(r){let E=r instanceof Error?r.message:String(r);if((/deadlock detected/i.test(E)||"string"==typeof r?.code&&"40P01"===r.code)&&e<3){await new Promise(t=>setTimeout(t,350*e));continue}let T=(0,U.responseForDbError)("admin.reset",r);if(T)return T;return u.NextResponse.json({ok:!1,attempt:e,error:E,steps:a,took_ms:Date.now()-t},{status:500})}}return u.NextResponse.json({ok:!1,error:"reset_failed",steps:a,took_ms:Date.now()-t},{status:500})}e.s(["POST",()=>g,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],330293);var h=e.i(330293);let F=new t.AppRouteRouteModule({definition:{kind:E.RouteKind.APP_ROUTE,page:"/api/admin/reset/route",pathname:"/api/admin/reset",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/reset/route.ts",nextConfigOutput:"",userland:h}),{workAsyncStorage:x,workUnitAsyncStorage:w,serverHooks:O}=F;function m(){return(0,a.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:w})}async function f(e,t,a){F.isDev&&(0,T.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let u="/api/admin/reset/route";u=u.replace(/\/index$/,"")||"/";let R=await F.prepare(e,t,{srcPage:u,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:p,params:D,nextConfig:S,parsedUrl:U,isDraftMode:L,prerenderManifest:g,routerServerContext:h,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,resolvedPathname:O,clientReferenceManifest:m,serverActionsManifest:f}=R,H=(0,n.normalizeAppPath)(u),B=!!(g.dynamicRoutes[H]||g.routes[O]),y=async()=>((null==h?void 0:h.render404)?await h.render404(e,t,U,!1):t.end("This page could not be found"),null);if(B&&!L){let e=!!g.routes[O],t=g.dynamicRoutes[H];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await y();throw new _.NoFallbackError}}let v=null;!B||F.isDev||L||(v="/index"===(v=O)?"/":v);let $=!0===F.isDev||!B,b=B&&!$;f&&m&&(0,s.setManifestsSingleton)({page:u,clientReferenceManifest:m,serverActionsManifest:f});let X=e.method||"GET",Y=(0,r.getTracer)(),k=Y.getActiveScopeSpan(),P={params:D,prerenderManifest:g,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:$,incrementalCache:(0,T.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,E,a,T)=>F.onRequestError(e,t,a,T,h)},sharedContext:{buildId:p}},j=new o.NodeNextRequest(e),q=new o.NodeNextResponse(t),G=i.NextRequestAdapter.fromNodeNextRequest(j,(0,i.signalFromNodeResponse)(t));try{let s=async e=>F.handle(G,P).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let E=Y.getRootSpanAttributes();if(!E)return;if(E.get("next.span_type")!==N.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${E.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=E.get("next.route");if(a){let t=`${X} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${X} ${u}`)}),n=!!(0,T.getRequestMeta)(e,"minimalMode"),o=async T=>{var r,o;let i=async({previousCacheEntry:E})=>{try{if(!n&&x&&w&&!E)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await s(T);e.fetchMetrics=P.renderOpts.fetchMetrics;let o=P.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let i=P.renderOpts.collectedTags;if(!B)return await (0,l.sendResponse)(j,q,r,P.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,A.toNodeOutgoingHttpHeaders)(r.headers);i&&(t[C.NEXT_CACHE_TAGS_HEADER]=i),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let E=void 0!==P.renderOpts.collectedRevalidate&&!(P.renderOpts.collectedRevalidate>=C.INFINITE_CACHE)&&P.renderOpts.collectedRevalidate,a=void 0===P.renderOpts.collectedExpire||P.renderOpts.collectedExpire>=C.INFINITE_CACHE?void 0:P.renderOpts.collectedExpire;return{value:{kind:d.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:E,expire:a}}}}catch(t){throw(null==E?void 0:E.isStale)&&await F.onRequestError(e,t,{routerKind:"App Router",routePath:u,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:b,isOnDemandRevalidate:x})},!1,h),t}},N=await F.handleResponse({req:e,nextConfig:S,cacheKey:v,routeKind:E.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:g,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:w,responseGenerator:i,waitUntil:a.waitUntil,isMinimalMode:n});if(!B)return null;if((null==N||null==(r=N.value)?void 0:r.kind)!==d.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==N||null==(o=N.value)?void 0:o.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",x?"REVALIDATED":N.isMiss?"MISS":N.isStale?"STALE":"HIT"),L&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,A.fromNodeOutgoingHttpHeaders)(N.value.headers);return n&&B||_.delete(C.NEXT_CACHE_TAGS_HEADER),!N.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,I.getCacheControlHeader)(N.cacheControl)),await (0,l.sendResponse)(j,q,new Response(N.value.body,{headers:_,status:N.value.status||200})),null};k?await o(k):await Y.withPropagatedContext(e.headers,()=>Y.trace(N.BaseServerSpan.handleRequest,{spanName:`${X} ${u}`,kind:r.SpanKind.SERVER,attributes:{"http.method":X,"http.target":e.url}},o))}catch(t){if(t instanceof _.NoFallbackError||await F.onRequestError(e,t,{routerKind:"App Router",routePath:H,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:b,isOnDemandRevalidate:x})},!1,h),B)throw t;return await (0,l.sendResponse)(j,q,new Response(null,{status:500})),null}}e.s(["handler",()=>f,"patchFetch",()=>m,"routeModule",()=>F,"serverHooks",()=>O,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>w],498253)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_784a7e9d.js.map