{"version":3,"sources":["../../../../src/lib/api/client.ts"],"sourcesContent":["export type ApiErrorPayload = {\r\n  error?: string;\r\n  message?: string;\r\n  details?: unknown;\r\n  _raw?: unknown;\r\n};\r\n\r\nexport class ApiError extends Error {\r\n  code: string;\r\n  details?: unknown;\r\n  status?: number;\r\n  requestId?: string;\r\n\r\n  constructor(code: string, opts?: { details?: unknown; status?: number; requestId?: string }) {\r\n    const msg = opts?.requestId ? `${code} (req ${opts.requestId})` : code;\r\n    super(msg);\r\n    this.name = \"ApiError\";\r\n    this.code = code;\r\n    this.details = opts?.details;\r\n    this.status = opts?.status;\r\n    this.requestId = opts?.requestId;\r\n  }\r\n}\r\n\r\nfunction safeJsonParse(text: string): unknown {\r\n  try {\r\n    return text ? JSON.parse(text) : null;\r\n  } catch {\r\n    return { _raw: text };\r\n  }\r\n}\r\n\r\nfunction looksLikeHtml(text: string): boolean {\r\n  const s = String(text ?? \"\").trimStart();\r\n  return s.startsWith(\"<!DOCTYPE html\") || s.startsWith(\"<html\") || s.startsWith(\"<!doctype html\");\r\n}\r\n\r\nfunction sleep(ms: number): Promise<void> {\r\n  return new Promise((r) => setTimeout(r, Math.max(0, Math.floor(ms))));\r\n}\r\n\r\nfunction getImpersonateUserIdFromLocation(): string | null {\r\n  if (typeof window === \"undefined\") return null;\r\n  try {\r\n    const v = new URL(window.location.href).searchParams.get(\"user_id\") ?? \"\";\r\n    const trimmed = v.trim();\r\n    return trimmed ? trimmed : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nfunction shouldAttachImpersonationHeader(input: RequestInfo | URL): boolean {\r\n  if (typeof window === \"undefined\") return false;\r\n\r\n  try {\r\n    const origin = window.location.origin;\r\n    const url =\r\n      typeof input === \"string\"\r\n        ? new URL(input, origin)\r\n        : input instanceof URL\r\n          ? input\r\n          : input instanceof Request\r\n            ? new URL(input.url)\r\n            : null;\r\n\r\n    if (!url) return false;\r\n    if (url.origin !== origin) return false;\r\n    return url.pathname.startsWith(\"/api/\");\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\nfunction getCsrfToken(): string | null {\r\n  if (typeof document === \"undefined\") return null;\r\n  const match = document.cookie.match(/(?:^|;\\s*)__csrf=([^;]+)/);\r\n  return match?.[1] ?? null;\r\n}\r\n\r\nexport async function fetchJsonOrThrow<T>(\r\n  input: RequestInfo | URL,\r\n  init?: RequestInit\r\n): Promise<T> {\r\n  const mergedInit: RequestInit | undefined = init\r\n    ? ({\r\n        ...init,\r\n        credentials: init.credentials ?? \"same-origin\",\r\n      } as RequestInit)\r\n    : ({ credentials: \"same-origin\" } as RequestInit);\r\n\r\n  // Attach CSRF double-submit token on mutating requests\r\n  const method = (mergedInit?.method ?? \"GET\").toUpperCase();\r\n\r\n  // Read-only admin view-as: on GET/HEAD requests to our own API, forward the\r\n  // `user_id` from the current page URL as `x-impersonate-user-id`.\r\n  if ((method === \"GET\" || method === \"HEAD\") && shouldAttachImpersonationHeader(input)) {\r\n    const desired = getImpersonateUserIdFromLocation();\r\n    if (desired) {\r\n      const headers = new Headers(mergedInit?.headers);\r\n      if (!headers.has(\"x-impersonate-user-id\")) {\r\n        headers.set(\"x-impersonate-user-id\", desired);\r\n      }\r\n      mergedInit!.headers = headers;\r\n    }\r\n  }\r\n\r\n  if ([\"POST\", \"PUT\", \"PATCH\", \"DELETE\"].includes(method)) {\r\n    const csrf = getCsrfToken();\r\n    if (csrf) {\r\n      const headers = new Headers(mergedInit?.headers);\r\n      if (!headers.has(\"x-csrf-token\")) {\r\n        headers.set(\"x-csrf-token\", csrf);\r\n      }\r\n      mergedInit!.headers = headers;\r\n    }\r\n  }\r\n\r\n  const method0 = (mergedInit?.method ?? \"GET\").toUpperCase();\r\n  const canRetry = method0 === \"GET\" || method0 === \"HEAD\";\r\n  const maxRetries = canRetry ? 2 : 0;\r\n\r\n  let lastErr: unknown = null;\r\n  for (let attempt = 0; attempt <= maxRetries; attempt += 1) {\r\n    try {\r\n      const res = await fetch(input, mergedInit);\r\n      const requestId = res.headers.get(\"x-request-id\") ?? undefined;\r\n\r\n      // Best-effort: remember the last request id so UI/support flows can display it.\r\n      try {\r\n        if (typeof window !== \"undefined\" && requestId) {\r\n          window.sessionStorage.setItem(\"ts.last_request_id\", requestId);\r\n        }\r\n      } catch {\r\n        // ignore\r\n      }\r\n\r\n      const text = await res.text().catch(() => \"\");\r\n      const contentType = res.headers.get(\"content-type\") ?? \"\";\r\n      const isHtml = contentType.includes(\"text/html\") || looksLikeHtml(text);\r\n      const json = (isHtml ? { _raw: \"<html/>\" } : safeJsonParse(text)) as ApiErrorPayload | unknown;\r\n\r\n      if (!res.ok) {\r\n        // Retry transient upstream errors for idempotent requests.\r\n        if (canRetry && (res.status === 502 || res.status === 503 || res.status === 504) && attempt < maxRetries) {\r\n          await sleep(250 * Math.pow(2, attempt));\r\n          continue;\r\n        }\r\n\r\n        if (json && typeof json === \"object\" && \"error\" in (json as ApiErrorPayload)) {\r\n          const payload = json as ApiErrorPayload;\r\n          const code = typeof payload.error === \"string\" ? payload.error : `http_${res.status}`;\r\n          const details =\r\n            payload.details !== undefined\r\n              ? payload.details\r\n              : typeof payload.message === \"string\"\r\n                ? payload.message\r\n                : isHtml\r\n                  ? { message: `Upstream error (HTTP ${res.status}). Please retry.` }\r\n                  : undefined;\r\n          throw new ApiError(code, { details, status: res.status, requestId });\r\n        }\r\n\r\n        if (json && typeof json === \"object\" && \"message\" in (json as ApiErrorPayload)) {\r\n          const payload = json as ApiErrorPayload;\r\n          const details = typeof payload.message === \"string\" ? payload.message : json;\r\n          throw new ApiError(`http_${res.status}`, { details, status: res.status, requestId });\r\n        }\r\n\r\n        const details = isHtml ? { message: `Upstream error (HTTP ${res.status}). Please retry.` } : json;\r\n        throw new ApiError(`http_${res.status}`, { details, status: res.status, requestId });\r\n      }\r\n\r\n      return json as T;\r\n    } catch (e) {\r\n      lastErr = e;\r\n      // Retry network errors on idempotent requests.\r\n      if (canRetry && attempt < maxRetries) {\r\n        await sleep(250 * Math.pow(2, attempt));\r\n        continue;\r\n      }\r\n      throw e;\r\n    }\r\n  }\r\n\r\n  throw lastErr;\r\n}\r\n"],"names":[],"mappings":"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"}