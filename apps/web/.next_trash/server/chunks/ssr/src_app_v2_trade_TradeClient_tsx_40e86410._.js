module.exports=[541991,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(556836),f=a.i(214373),g=a.i(56773),h=a.i(825683),i=a.i(782691),j=a.i(152608);function k(a){let b="number"==typeof a?a:Number(String(a));return Number.isFinite(b)?b:null}function l(a,b){let c=k(a),d=k(b);return null==c||null==d||c<=0?null:(d-c)/c*100}function m(a){let b=k(a);if(null==b)return"—";if(0===b)return"0";let c=Math.abs(b);return b.toLocaleString(void 0,{maximumFractionDigits:c>=1e3?2:c>=1?4:c>=.01?6:8})}let n={base:"BTC",quote:"USDT"};function o(){let a,o,p=(0,d.useSearchParams)(),q=(a=String(p?.get("base")??"").trim().toUpperCase(),o=String(p?.get("quote")??"").trim().toUpperCase(),a&&o?{base:a,quote:o}:n),[r,s]=(0,c.useState)(q),[t,u]=(0,c.useState)(!1),[v,w]=(0,c.useState)("chart"),[x,y]=(0,c.useState)(!0),[z,A]=(0,c.useState)(null),[B,C]=(0,c.useState)([]),[D,E]=(0,c.useState)(""),[F,G]=(0,c.useState)(!1),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)(null),[L,M]=(0,c.useState)(!1),[N,O]=(0,c.useState)(null),[P,Q]=(0,c.useState)(null),[R,S]=(0,c.useState)("1h"),[T,U]=(0,c.useState)(!1),[V,W]=(0,c.useState)(null),[X,Y]=(0,c.useState)(null),[Z,$]=(0,c.useState)("buy"),[_,aa]=(0,c.useState)("market"),[ab,ac]=(0,c.useState)(""),[ad,ae]=(0,c.useState)(""),[af,ag]=(0,c.useState)({kind:"idle"}),ah=(0,c.useRef)(0),ai=(0,c.useRef)(null),aj=`${r.base}/${r.quote}`;(0,c.useEffect)(()=>{try{localStorage.setItem("cw:v2:lastPair",JSON.stringify({base:r.base,quote:r.quote}))}catch{}},[r.base,r.quote]),(0,c.useEffect)(()=>{let a=String(p?.get("base")??"").trim().toUpperCase(),b=String(p?.get("quote")??"").trim().toUpperCase();a&&b&&(a!==r.base||b!==r.quote)&&s({base:a,quote:b})},[p]),(0,c.useEffect)(()=>{let a=!1,b=async()=>{A(null);try{let b=await fetch("/api/exchange/markets/overview?fiat=USD",{cache:"no-store"}),c=await b.json().catch(()=>null);if(!b.ok)throw Error("markets_unavailable");let d=(Array.isArray(c?.markets)?c.markets:[]).filter(a=>"USDT"===String(a.quote_symbol).toUpperCase());a||C(d)}catch(b){a||A(b instanceof Error?b.message:String(b))}finally{a||y(!1)}};b();let c=window.setInterval(()=>void b(),15e3);return()=>{a=!0,window.clearInterval(c)}},[]);let ak=(0,c.useMemo)(()=>{let a=r.base.toUpperCase(),b=r.quote.toUpperCase();return B.find(c=>String(c.base_symbol).toUpperCase()===a&&String(c.quote_symbol).toUpperCase()===b)??null},[B,r.base,r.quote]),al=ak?.id??null,am=ak?.stats?.last??null,an=l(ak?.stats?.open??null,ak?.stats?.last??null),ao=null==an?"—":`${an>=0?"+":""}${an.toFixed(2)}%`,ap=null==an?"text-[var(--v2-muted)]":an>=0?"text-[var(--up)]":"text-[var(--down)]",aq=ak?.stats&&ak.stats.high?String(ak.stats.high):null,ar=ak?.stats&&ak.stats.low?String(ak.stats.low):null,as=ak?.stats?.quote_volume??null,at=(0,c.useMemo)(()=>[{id:"chart",label:"Chart"},{id:"book",label:"Book"},{id:"trades",label:"Trades"}],[]),au=async(a,b)=>{I(null),G(!0);try{let c=await fetch(`/api/exchange/marketdata/depth?market_id=${encodeURIComponent(a)}&levels=12`,{cache:"no-store",signal:b}),d=await c.json().catch(()=>null);if(!c.ok)throw Error("depth_unavailable");K(d)}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)return;I(a instanceof Error?a.message:String(a))}finally{G(!1)}},av=async(a,b)=>{O(null),M(!0);try{let c=await fetch(`/api/exchange/marketdata/trades?market_id=${encodeURIComponent(a)}&limit=30`,{cache:"no-store",signal:b}),d=await c.json().catch(()=>null);if(!c.ok)throw Error("trades_unavailable");Q(d)}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)return;O(a instanceof Error?a.message:String(a))}finally{M(!1)}},aw=async(a,b,c)=>{W(null),U(!0);try{let d=await fetch(`/api/exchange/marketdata/candles?market_id=${encodeURIComponent(a)}&interval=1m&limit=${encodeURIComponent(String(b))}`,{cache:"no-store",signal:c}),e=await d.json().catch(()=>null);if(!d.ok)throw Error("candles_unavailable");Y(e)}catch(a){if(a instanceof DOMException&&"AbortError"===a.name)return;W(a instanceof Error?a.message:String(a))}finally{U(!1)}};(0,c.useEffect)(()=>{if(!al)return;let a=new AbortController,b=null,c=null,d=()=>{try{ai.current?.close()}catch{}ai.current=null},e=()=>{b&&(window.clearInterval(b),b=null)},f=()=>{c&&(window.clearTimeout(c),c=null)},g=()=>{"book"===v?("visible"===document.visibilityState&&au(al,a.signal),b=window.setInterval(()=>{"visible"===document.visibilityState&&au(al,a.signal)},2200)):"trades"===v&&("visible"===document.visibilityState&&av(al,a.signal),b=window.setInterval(()=>{"visible"===document.visibilityState&&av(al,a.signal)},2800))},h=a=>{"visible"!==document.visibilityState||"book"!==v&&"trades"!==v||"u"<typeof EventSource||ai.current||c||(c=window.setTimeout(()=>{c=null,"visible"===document.visibilityState&&("book"===v?j():"trades"===v&&k())},a))},i=()=>{"visible"!==document.visibilityState||b||g()},j=()=>{if("visible"===document.visibilityState){d(),f(),e(),I(null),G(!0);try{let a=`/api/exchange/marketdata/stream?market_id=${encodeURIComponent(al)}&topics=depth&levels=12&poll_ms=1000&heartbeat_ms=15000`,b=new EventSource(a);b.addEventListener("depth",a=>{try{let b=JSON.parse(String(a.data??"{}"));K(b)}catch{}finally{G(!1)}}),b.onerror=()=>{d(),G(!1),i(),h(4500)},ai.current=b}catch{d(),G(!1),i(),h(4500)}}},k=()=>{if("visible"===document.visibilityState){d(),f(),e(),O(null),M(!0);try{let a=`/api/exchange/marketdata/stream?market_id=${encodeURIComponent(al)}&topics=trades&trades_limit=30&trades_delta=1&poll_ms=1200&heartbeat_ms=15000`,b=new EventSource(a);b.addEventListener("trades",a=>{try{let b=JSON.parse(String(a.data??"{}")),c=Array.isArray(b?.trades)?b.trades:[],d=String(b?.mode??"snapshot");"delta"===d?Q(a=>{let b=a?.trades??[],d=[...c,...b],e=new Set,f=[];for(let a of d){let b=String(a?.id??"");if(!(!b||e.has(b))&&(e.add(b),f.push(a),f.length>=30))break}return{trades:f}}):Q({trades:c})}catch{}finally{M(!1)}}),b.onerror=()=>{d(),M(!1),i(),h(4500)},ai.current=b}catch{d(),M(!1),i(),h(4500)}}},l=()=>{if("visible"===document.visibilityState)if("book"===v)"u">typeof EventSource?j():g();else if("trades"===v)"u">typeof EventSource?k():g();else if("chart"===v){let c;d(),f(),c="6h"===R?360:"8h"===R?500:60,"visible"===document.visibilityState&&aw(al,c,a.signal),b=window.setInterval(()=>{"visible"===document.visibilityState&&aw(al,c,a.signal)},15e3)}else d(),f()},m=()=>{d(),f(),e()},n=()=>{"visible"===document.visibilityState?(m(),l()):m()};return document.addEventListener("visibilitychange",n),l(),()=>{document.removeEventListener("visibilitychange",n),m(),a.abort()}},[al,v,R]),(0,c.useEffect)(()=>{K(null),Q(null),Y(null),I(null),O(null),W(null)},[al]);let ax=(0,c.useMemo)(()=>(X?.candles??[]).map(a=>k(a.close)).filter(a=>"number"==typeof a&&Number.isFinite(a)),[X]),ay=(0,c.useMemo)(()=>{if(ax.length<2)return null;let a=Math.min(...ax),b=Math.max(...ax),c=b-a||1,d=100/(ax.length-1);return{d:ax.map((b,e)=>`${0===e?"M":"L"}${(e*d).toFixed(2)} ${(40-(b-a)/c*40).toFixed(2)}`).join(" "),up:ax[ax.length-1]>=ax[0],min:a,max:b,first:ax[0],last:ax[ax.length-1]}},[ax]),az=async()=>{if(!al)return void ag({kind:"error",message:"Market not available."});if(ak?.is_halted)return void ag({kind:"error",message:"This market is halted."});let a=ab.trim();if(!a)return void ag({kind:"error",message:"Enter an amount."});if("limit"===_&&!ad.trim())return void ag({kind:"error",message:"Enter a limit price."});let b=Date.now();if(!(b-ah.current<900)){ah.current=b,ag({kind:"placing"});try{let b="limit"===_?{market_id:al,side:Z,type:"limit",price:ad.trim(),quantity:a}:{market_id:al,side:Z,type:"market",quantity:a},c=await fetch("/api/exchange/orders",{method:"POST",credentials:"include",headers:{"content-type":"application/json"},body:JSON.stringify(b)}),d=await c.text(),e=null;try{e=JSON.parse(d)}catch{e={_raw:d}}if(!c.ok){let a="string"==typeof e?.error?e.error:`http_${c.status}`;ag({kind:"error",message:a});return}ag({kind:"ok",message:"Order placed"}),ac("")}catch(a){ag({kind:"error",message:a instanceof Error?a.message:String(a)})}}};return(0,b.jsxs)("main",{className:"space-y-4",children:[(0,b.jsx)("header",{className:"space-y-2",children:(0,b.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,b.jsxs)("div",{className:"min-w-0",children:[(0,b.jsx)("div",{className:"text-[11px] font-bold uppercase tracking-widest text-[var(--v2-muted)]",children:"Trade"}),(0,b.jsxs)("div",{className:"mt-0.5 flex items-center gap-2",children:[(0,b.jsx)("button",{type:"button",onClick:()=>u(!0),className:"truncate rounded-xl bg-[var(--v2-surface)] px-2 py-1 text-xl font-extrabold tracking-tight shadow-[var(--v2-shadow-sm)] hover:bg-[var(--v2-surface-2)]",title:"Change pair",children:aj}),(0,b.jsx)("span",{className:"rounded-full border border-[var(--v2-border)] bg-[var(--v2-surface)] px-2 py-1 text-[12px] font-semibold text-[var(--v2-muted)]",children:"Spot"})]}),(0,b.jsxs)("div",{className:"mt-1 flex flex-wrap items-center gap-3 text-[13px]",children:[(0,b.jsx)("span",{className:"font-semibold text-[var(--v2-text)]",children:x?"…":m(am)}),(0,b.jsx)("span",{className:`font-semibold ${ap}`,children:x?"…":ao}),ak?.is_halted?(0,b.jsx)("span",{className:"rounded-full border border-[var(--v2-border)] bg-[var(--warn-bg)] px-2 py-0.5 text-[11px] font-semibold text-[var(--warn)]",children:"Halted"}):null,z?(0,b.jsx)("span",{className:"text-[12px] text-[var(--down)]",children:"Live data unavailable"}):null]}),(0,b.jsxs)("div",{className:"mt-2 flex flex-wrap items-center gap-3 text-[12px] text-[var(--v2-muted)]",children:[(0,b.jsxs)("span",{children:["24h H ",x?"…":m(aq)]}),(0,b.jsxs)("span",{children:["24h L ",x?"…":m(ar)]}),(0,b.jsxs)("span",{children:["Vol ",x?"…":m(as)," ",String(r.quote).toUpperCase()]})]})]}),(0,b.jsx)(e.V2Button,{variant:"primary",size:"sm",onClick:()=>u(!0),children:"Pairs"})]})}),(0,b.jsx)(j.V2Tabs,{tabs:at,activeId:v,onChange:a=>w(a)}),(0,b.jsxs)(f.V2Card,{children:[(0,b.jsx)(f.V2CardHeader,{title:"chart"===v?"Chart":"book"===v?"Order book":"Recent trades",subtitle:"chart"===v?"Price action":"book"===v?"Liquidity":"Latest fills"}),(0,b.jsx)(f.V2CardBody,{children:"chart"===v?V?(0,b.jsx)("div",{className:"text-sm text-[var(--down)]",children:"Chart unavailable."}):T&&!X?(0,b.jsx)(i.V2Skeleton,{className:"h-48 w-full"}):ay?(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("div",{className:"grid grid-cols-3 gap-2",children:[{id:"1h",label:"1H"},{id:"6h",label:"6H"},{id:"8h",label:"8H"}].map(a=>{let c=R===a.id;return(0,b.jsx)("button",{type:"button",onClick:()=>S(a.id),className:"h-10 rounded-xl border px-3 text-[13px] font-semibold shadow-[var(--v2-shadow-sm)] "+(c?"border-[var(--v2-border)] bg-[var(--v2-surface-2)] text-[var(--v2-text)]":"border-[var(--v2-border)] bg-[var(--v2-surface)] text-[var(--v2-muted)] hover:bg-[var(--v2-surface-2)]"),children:a.label},a.id)})}),(0,b.jsxs)("div",{className:"rounded-2xl border border-[var(--v2-border)] bg-[var(--v2-surface-2)] p-3",children:[(0,b.jsx)("svg",{viewBox:"0 0 100 40",width:"100%",height:"180",preserveAspectRatio:"none","aria-label":"Price chart",children:(0,b.jsx)("path",{d:ay.d,fill:"none",stroke:ay.up?"var(--up)":"var(--down)",strokeWidth:"2",strokeLinejoin:"round",strokeLinecap:"round"})}),(0,b.jsxs)("div",{className:"mt-2 flex items-center justify-between gap-3 text-[12px]",children:[(0,b.jsxs)("div",{className:"text-[var(--v2-muted)]",children:["min ",m(String(ay.min))]}),(0,b.jsxs)("div",{className:`font-semibold ${ay.up?"text-[var(--up)]":"text-[var(--down)]"}`,children:["last ",m(String(ay.last))]}),(0,b.jsxs)("div",{className:"text-[var(--v2-muted)]",children:["max ",m(String(ay.max))]})]})]})]}):(0,b.jsx)("div",{className:"text-[12px] text-[var(--v2-muted)]",children:"No trades yet."}):"book"===v?H?(0,b.jsx)("div",{className:"text-sm text-[var(--down)]",children:"Order book unavailable."}):F&&!J?(0,b.jsx)(i.V2Skeleton,{className:"h-48 w-full"}):(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"mb-2 text-[12px] font-semibold text-[var(--v2-muted)]",children:"Bids"}),(0,b.jsxs)("div",{className:"grid gap-1",children:[(J?.depth?.bids??[]).slice(0,12).map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2 rounded-xl bg-[var(--v2-surface-2)] px-2 py-1",children:[(0,b.jsx)("div",{className:"font-mono text-[12px] font-semibold text-[var(--up)]",children:m(a.price)}),(0,b.jsx)("div",{className:"font-mono text-[12px] text-[var(--v2-text)]",children:m(a.quantity)})]},`b:${c}`)),0===(J?.depth?.bids??[]).length?(0,b.jsx)("div",{className:"text-[12px] text-[var(--v2-muted)]",children:"No bids."}):null]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"mb-2 text-[12px] font-semibold text-[var(--v2-muted)]",children:"Asks"}),(0,b.jsxs)("div",{className:"grid gap-1",children:[(J?.depth?.asks??[]).slice(0,12).map((a,c)=>(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2 rounded-xl bg-[var(--v2-surface-2)] px-2 py-1",children:[(0,b.jsx)("div",{className:"font-mono text-[12px] font-semibold text-[var(--down)]",children:m(a.price)}),(0,b.jsx)("div",{className:"font-mono text-[12px] text-[var(--v2-text)]",children:m(a.quantity)})]},`a:${c}`)),0===(J?.depth?.asks??[]).length?(0,b.jsx)("div",{className:"text-[12px] text-[var(--v2-muted)]",children:"No asks."}):null]})]})]}):N?(0,b.jsx)("div",{className:"text-sm text-[var(--down)]",children:"Trades unavailable."}):L&&!P?(0,b.jsx)(i.V2Skeleton,{className:"h-48 w-full"}):(0,b.jsxs)("div",{className:"grid gap-1",children:[(P?.trades??[]).slice(0,30).map(a=>{let c=a.created_at?new Date(a.created_at).toLocaleTimeString():"";return(0,b.jsxs)("div",{className:"flex items-center justify-between gap-2 rounded-xl bg-[var(--v2-surface-2)] px-2 py-1",children:[(0,b.jsx)("div",{className:"font-mono text-[12px] text-[var(--v2-muted)]",children:c}),(0,b.jsx)("div",{className:"font-mono text-[12px] font-semibold text-[var(--v2-text)]",children:m(a.price)}),(0,b.jsx)("div",{className:"font-mono text-[12px] text-[var(--v2-text)]",children:m(a.quantity)})]},a.id)}),0===(P?.trades??[]).length?(0,b.jsx)("div",{className:"text-[12px] text-[var(--v2-muted)]",children:"No trades yet."}):null]})})]}),(0,b.jsxs)(f.V2Card,{children:[(0,b.jsx)(f.V2CardHeader,{title:"Place order",subtitle:ak?.is_halted?"Market halted":"Market / Limit"}),(0,b.jsx)(f.V2CardBody,{children:(0,b.jsxs)("div",{className:"grid gap-3",children:[(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsx)(e.V2Button,{variant:"buy"===Z?"primary":"secondary",fullWidth:!0,onClick:()=>$("buy"),children:"Buy"}),(0,b.jsx)(e.V2Button,{variant:"sell"===Z?"danger":"secondary",fullWidth:!0,onClick:()=>$("sell"),children:"Sell"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-2",children:[(0,b.jsx)(e.V2Button,{variant:"market"===_?"primary":"secondary",fullWidth:!0,onClick:()=>aa("market"),children:"Market"}),(0,b.jsx)(e.V2Button,{variant:"limit"===_?"primary":"secondary",fullWidth:!0,onClick:()=>aa("limit"),children:"Limit"})]}),"limit"===_?(0,b.jsxs)("div",{className:"grid gap-2",children:[(0,b.jsxs)("div",{className:"text-[12px] font-semibold text-[var(--v2-muted)]",children:["Limit price (",r.quote,")"]}),(0,b.jsx)(g.V2Input,{inputMode:"decimal",placeholder:`0.00 ${r.quote}`,value:ad,onChange:a=>ae(a.target.value)})]}):null,(0,b.jsxs)("div",{className:"grid gap-2",children:[(0,b.jsx)("div",{className:"text-[12px] font-semibold text-[var(--v2-muted)]",children:"Amount"}),(0,b.jsx)(g.V2Input,{inputMode:"decimal",placeholder:`0.00 ${r.base}`,value:ab,onChange:a=>ac(a.target.value)})]}),(0,b.jsx)(e.V2Button,{variant:"buy"===Z?"primary":"danger",size:"lg",fullWidth:!0,disabled:"placing"===af.kind||!al||!!ak?.is_halted,onClick:()=>void az(),children:"placing"===af.kind?"Placing…":"buy"===Z?"Buy":"Sell"}),"ok"===af.kind?(0,b.jsx)("div",{className:"rounded-2xl border border-[var(--v2-border)] bg-[var(--up-bg)] px-3 py-2 text-[13px] font-semibold text-[var(--up)]",children:af.message??"Order placed"}):"error"===af.kind?(0,b.jsx)("div",{className:"rounded-2xl border border-[var(--v2-border)] bg-[var(--down-bg)] px-3 py-2 text-[13px] font-semibold text-[var(--down)]",children:af.message??"Order failed"}):null,(0,b.jsx)("div",{className:"text-[12px] text-[var(--v2-muted)]",children:"Next: fee preview, balance checks, and one-tap confirm."})]})})]}),(0,b.jsx)(h.V2Sheet,{open:t,title:"Select a pair",onClose:()=>u(!1),children:(0,b.jsxs)("div",{className:"grid gap-3",children:[(0,b.jsx)(g.V2Input,{value:D,onChange:a=>E(a.target.value),placeholder:"Search BTC, ETH…"}),(0,b.jsx)("div",{className:"grid gap-2",children:(B.length?B:[{id:"fallback",symbol:"BTC/USDT",is_halted:!1,base_symbol:r.base,quote_symbol:r.quote,stats:null}]).filter(a=>{let b=D.trim().toUpperCase();return!b||`${String(a.base_symbol).toUpperCase()}/${String(a.quote_symbol).toUpperCase()}`.includes(b)||String(a.symbol).toUpperCase().includes(b)}).slice(0,60).map(a=>{let c={base:String(a.base_symbol).toUpperCase(),quote:String(a.quote_symbol).toUpperCase()},d=`${c.base}/${c.quote}`,e=c.base===r.base&&c.quote===r.quote,f=a.stats?.last??null,g=l(a.stats?.open??null,a.stats?.last??null),h=null==g?"—":`${g>=0?"+":""}${g.toFixed(2)}%`,i=null==g?"text-[var(--v2-muted)]":g>=0?"text-[var(--up)]":"text-[var(--down)]";return(0,b.jsxs)("button",{type:"button",onClick:()=>{s(c),u(!1)},className:"flex h-12 items-center justify-between rounded-2xl border px-4 text-left shadow-[var(--v2-shadow-sm)] transition "+(e?"border-[color-mix(in_srgb,var(--v2-accent)_55%,transparent)] bg-[color-mix(in_srgb,var(--v2-accent)_10%,transparent)]":"border-[var(--v2-border)] bg-[var(--v2-surface)] hover:bg-[var(--v2-surface-2)]"),children:[(0,b.jsx)("div",{className:"text-[15px] font-semibold text-[var(--v2-text)]",children:d}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("div",{className:"text-[12px] font-semibold text-[var(--v2-text)]",children:x?"…":m(f)}),(0,b.jsx)("div",{className:`text-[11px] font-semibold ${i}`,children:x?"…":h})]})]},d)})})]})})]})}a.s(["TradeClient",()=>o])}];

//# sourceMappingURL=src_app_v2_trade_TradeClient_tsx_40e86410._.js.map