module.exports=[227375,e=>{"use strict";var t=e.i(747909),r=e.i(174017),a=e.i(996250),s=e.i(759756),n=e.i(561916),i=e.i(174677),o=e.i(869741),l=e.i(316795),d=e.i(487718),u=e.i(995169),p=e.i(47587),c=e.i(666012),_=e.i(570101),E=e.i(626937),h=e.i(10372),m=e.i(193695);e.i(52474);var g=e.i(600220),f=e.i(666680),R=e.i(469719),v=e.i(300959),S=e.i(843793),w=e.i(184883),T=e.i(24672),A=e.i(909815),O=e.i(303395);function x(e,t,r){let a=Number(process.env[e]),s=r?.min??-1/0,n=r?.max??1/0;return Number.isFinite(a)?Math.max(s,Math.min(n,Math.trunc(a))):t}let N=R.z.object({force:R.z.string().optional().transform(e=>"1"===String(e??"").trim())});async function C(e){let t,r=Date.now(),a=(0,S.getSql)();if(!function(e){let t=String(process.env.EXCHANGE_CRON_SECRET??process.env.CRON_SECRET??"").trim();if(!t)return!1;let r=new URL(e.url),a=String(e.headers.get("x-cron-secret")??r.searchParams.get("secret")??"").trim();return!!a&&a===t}(e))return(0,v.apiError)("unauthorized",{status:401});let s=new URL(e.url);try{t=N.parse({force:s.searchParams.get("force")??void 0})}catch(e){return(0,v.apiZodError)(e)??(0,v.apiError)("invalid_input")}let n=function(e,t=""){let r=String(process.env[e]??t).trim();return r?r.split(",").map(e=>e.trim()).filter(Boolean):[]}("OPS_ALERT_EMAIL_TO");if(0===n.length)return await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"degraded",details:{skipped:!0,reason:"ops_alert_email_to_not_configured",duration_ms:Date.now()-r}}).catch(()=>void 0),Response.json({ok:!0,skipped:!0,reason:"ops_alert_email_to_not_configured"});if(!(0,A.isEmailConfigured)())return await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"degraded",details:{skipped:!0,reason:"email_not_configured",duration_ms:Date.now()-r}}).catch(()=>void 0),Response.json({ok:!0,skipped:!0,reason:"email_not_configured"});let i=x("OPS_ALERT_MIN_INTERVAL_MINUTES",30,{min:1,max:1440}),o=x("OPS_OUTBOX_DEAD_THRESHOLD",1,{min:0,max:1e6}),l=x("OPS_OUTBOX_OPEN_THRESHOLD",5e3,{min:0,max:1e6}),d=x("OPS_EMAIL_OUTBOX_PENDING_THRESHOLD",200,{min:0,max:1e6}),u=x("OPS_EMAIL_OUTBOX_AGE_MINUTES",20,{min:0,max:1440});try{let e=await (0,w.retryOnceOnTransientDbError)(async()=>{var e;let r,s,n,[{open:p,dead:c,with_errors:_}={open:0,dead:0,with_errors:0}]=await a`
        SELECT
          count(*) FILTER (WHERE processed_at IS NULL AND dead_lettered_at IS NULL)::int AS open,
          count(*) FILTER (WHERE dead_lettered_at IS NOT NULL)::int AS dead,
          count(*) FILTER (WHERE last_error IS NOT NULL)::int AS with_errors
        FROM app_outbox_event
      `,[{pending:E,failed:h,oldest_pending_at:m}={pending:0,failed:0,oldest_pending_at:null}]=await a`
        SELECT
          count(*) FILTER (WHERE status = 'pending')::int AS pending,
          count(*) FILTER (WHERE status = 'failed')::int AS failed,
          min(created_at) FILTER (WHERE status = 'pending')::timestamptz::text AS oldest_pending_at
        FROM ex_email_outbox
      `,g=await (0,T.listServiceHeartbeats)(a),R=Date.now(),v=new Map;for(let e of g){let t=Date.parse(String(e.last_seen_at??""));v.set(String(e.service),{lastSeenAtMs:Number.isFinite(t)?t:0,status:String(e.status??"ok")})}let S=[],w=(r=[],"1"===(process.env.EXPECT_OUTBOX_WORKER??"").trim()&&r.push({service:"outbox-worker",staleAfterMs:6e5}),"1"===(process.env.EXCHANGE_ENABLE_CONDITIONAL_ORDERS??"").trim()&&r.push({service:"exchange:conditional-orders",staleAfterMs:6e5}),"1"===(process.env.EXCHANGE_ENABLE_PRICE_ALERTS??"").trim()&&r.push({service:"cron:price-alerts",staleAfterMs:9e5}),s="1"===(process.env.EXPECT_DEPOSIT_SCAN??"").trim(),n="1"===(process.env.EXPECT_SWEEP_DEPOSITS??"").trim(),s&&r.push({service:"deposit-scan:bsc",staleAfterMs:36e5}),n&&r.push({service:"sweep-deposits:bsc",staleAfterMs:36e5}),(0,A.isEmailConfigured)()&&r.push({service:"cron:email-notifications",staleAfterMs:36e5}),r);for(let e of w){let t=v.get(e.service);if(!t){S.push(e.service);continue}(!t.lastSeenAtMs||R-t.lastSeenAtMs>e.staleAfterMs)&&S.push(e.service)}let O=m?Date.parse(m):NaN,x=Number.isFinite(O)?Math.max(0,Math.floor((R-O)/6e4)):null,N=[];o>=0&&c>o&&N.push(`app_outbox_event dead letters: ${c} (threshold ${o})`),l>=0&&p>l&&N.push(`app_outbox_event backlog open: ${p} (threshold ${l})`),_>0&&N.push(`app_outbox_event has errors: ${_}`),d>=0&&E>d&&N.push(`ex_email_outbox pending: ${E} (threshold ${d})`),h>0&&N.push(`ex_email_outbox failed: ${h}`),u>0&&null!=x&&x>=u&&N.push(`ex_email_outbox oldest pending age: ${x}m (threshold ${u}m)`),S.length>0&&N.push(`stale services: ${S.join(", ")}`);let C=N.length>0,b=(e=JSON.stringify({issues:N,outboxOpen:p,outboxDead:c,outboxWithErrors:_,emailPending:E,emailFailed:h,oldestPendingAt:m,staleExpectedServices:S}),(0,f.createHash)("sha256").update(e,"utf8").digest("hex")),[D]=await a`
        SELECT last_sent_at::text AS last_sent_at, last_fingerprint
        FROM app_ops_alert_state
        WHERE key = ${"ops:degraded"}
        LIMIT 1
      `,L=D?.last_sent_at?Date.parse(String(D.last_sent_at)):0,I=L&&Number.isFinite(L)?Math.floor((R-L)/6e4):1e4,P=!!(D?.last_fingerprint&&D.last_fingerprint===b),H=C&&(t.force||!P||I>=i);return{degraded:C,issues:N,fingerprint:b,shouldSend:H,minutesSince:I,expectedServices:w,staleExpectedServices:S,metrics:{outbox:{open:p,dead:c,with_errors:_},email_outbox:{pending:E,failed:h,oldest_pending_at:m,oldest_age_min:x}}}});if(!e.degraded)return await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"ok",details:{degraded:!1,duration_ms:Date.now()-r}}).catch(()=>void 0),Response.json({ok:!0,degraded:!1,took_ms:Date.now()-r});if(!e.shouldSend)return await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"degraded",details:{degraded:!0,sent:!1,reason:"deduped",minutes_since_last:e.minutesSince,duration_ms:Date.now()-r}}).catch(()=>void 0),Response.json({ok:!0,degraded:!0,sent:!1,reason:"deduped",issues:e.issues,took_ms:Date.now()-r});let s="http://localhost:3000".trim(),p=(()=>{try{if(!s)return"";return new URL("/status",s).toString()}catch{return""}})(),c=(0,O.opsAlertEmail)({title:"Degraded health detected",summary:"One or more operational signals exceeded thresholds.",lines:e.issues,statusUrl:p});for(let e of n)await (0,A.sendMail)({to:e,subject:c.subject,text:c.text,html:c.html});return await a`
      INSERT INTO app_ops_alert_state (key, last_sent_at, last_fingerprint, updated_at)
      VALUES (${"ops:degraded"}, now(), ${e.fingerprint}, now())
      ON CONFLICT (key) DO UPDATE
        SET last_sent_at = EXCLUDED.last_sent_at,
            last_fingerprint = EXCLUDED.last_fingerprint,
            updated_at = EXCLUDED.updated_at
    `,await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"degraded",details:{degraded:!0,sent:!0,issues:e.issues,duration_ms:Date.now()-r}}).catch(()=>void 0),Response.json({ok:!0,degraded:!0,sent:!0,to:n.length,issues:e.issues,took_ms:Date.now()-r})}catch(t){await (0,T.upsertServiceHeartbeat)(a,{service:"cron:ops-alerts",status:"error",details:{error:t instanceof Error?t.message:String(t),duration_ms:Date.now()-r}}).catch(()=>void 0);let e=(0,w.responseForDbError)("cron.ops-alerts",t);if(e)return e;throw t}}async function b(e){return C(e)}e.s(["GET",()=>b,"POST",()=>C,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],930299);var D=e.i(930299);let L=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/cron/ops-alerts/route",pathname:"/api/cron/ops-alerts",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/cron/ops-alerts/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:I,workUnitAsyncStorage:P,serverHooks:H}=L;function y(){return(0,a.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:P})}async function M(e,t,a){L.isDev&&(0,s.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/cron/ops-alerts/route";f=f.replace(/\/index$/,"")||"/";let R=await L.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:v,params:S,nextConfig:w,parsedUrl:T,isDraftMode:A,prerenderManifest:O,routerServerContext:x,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,resolvedPathname:b,clientReferenceManifest:D,serverActionsManifest:I}=R,P=(0,o.normalizeAppPath)(f),H=!!(O.dynamicRoutes[P]||O.routes[b]),y=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,T,!1):t.end("This page could not be found"),null);if(H&&!A){let e=!!O.routes[b],t=O.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await y();throw new m.NoFallbackError}}let M=null;!H||L.isDev||A||(M="/index"===(M=b)?"/":M);let U=!0===L.isDev||!H,k=H&&!U;I&&D&&(0,i.setManifestsSingleton)({page:f,clientReferenceManifest:D,serverActionsManifest:I});let F=e.method||"GET",$=(0,n.getTracer)(),j=$.getActiveScopeSpan(),X={params:S,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,s.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a,s)=>L.onRequestError(e,t,a,s,x)},sharedContext:{buildId:v}},q=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),W=d.NextRequestAdapter.fromNodeNextRequest(q,(0,d.signalFromNodeResponse)(t));try{let i=async e=>L.handle(W,X).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${F} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${f}`)}),o=!!(0,s.getRequestMeta)(e,"minimalMode"),l=async s=>{var n,l;let d=async({previousCacheEntry:r})=>{try{if(!o&&N&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(s);e.fetchMetrics=X.renderOpts.fetchMetrics;let l=X.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let d=X.renderOpts.collectedTags;if(!H)return await (0,c.sendResponse)(q,B,n,X.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==X.renderOpts.collectedRevalidate&&!(X.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&X.renderOpts.collectedRevalidate,a=void 0===X.renderOpts.collectedExpire||X.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:X.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await L.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:N})},!1,x),t}},u=await L.handleResponse({req:e,nextConfig:w,cacheKey:M,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:N,revalidateOnlyGenerated:C,responseGenerator:d,waitUntil:a.waitUntil,isMinimalMode:o});if(!H)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",N?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,_.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&H||m.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,E.getCacheControlHeader)(u.cacheControl)),await (0,c.sendResponse)(q,B,new Response(u.value.body,{headers:m,status:u.value.status||200})),null};j?await l(j):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await L.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:N})},!1,x),H)throw t;return await (0,c.sendResponse)(q,B,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>y,"routeModule",()=>L,"serverHooks",()=>H,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>P],227375)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0eb75f5e.js.map