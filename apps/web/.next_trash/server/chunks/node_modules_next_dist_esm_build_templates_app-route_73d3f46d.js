module.exports=[873608,e=>{"use strict";var t=e.i(747909),r=e.i(174017),i=e.i(996250),a=e.i(759756),n=e.i(561916),o=e.i(174677),d=e.i(869741),s=e.i(316795),u=e.i(487718),l=e.i(995169),c=e.i(47587),p=e.i(666012),_=e.i(570101),m=e.i(626937),E=e.i(10372),h=e.i(193695);e.i(52474);var y=e.i(600220),R=e.i(469719),f=e.i(300959),v=e.i(843793),A=e.i(184883),w=e.i(977775),g=e.i(720290),T=e.i(66137),S=e.i(533821),x=e.i(60828),C=e.i(273278),k=e.i(796929);let b=R.z.object({action_id:R.z.string().uuid(),client_seed:R.z.string().min(8).max(256)}),N="fusion";async function D(e){let t,r=(0,w.getActingUserId)(e),i=(0,w.requireActingUserIdInProd)(r);if(i)return(0,f.apiError)(i);if(!r)return(0,f.apiError)("missing_x_user_id");let a=await e.json().catch(()=>({}));try{t=b.parse(a)}catch(e){return(0,f.apiZodError)(e)??(0,f.apiError)("invalid_input")}let n=t.action_id,o=String(t.client_seed??"").trim(),d=(0,v.getSql)();try{let e=await (0,A.retryOnceOnTransientDbError)(async()=>await d.begin(async e=>{let t=await (0,k.enforceArcadeSafety)(e,{userId:r,module:N,shardSpend:25});if(!t.ok)return{kind:"err",err:(0,f.apiError)(t.error,{details:t.details})};let i=await e`
          SELECT
            id::text AS id,
            user_id::text AS user_id,
            module,
            profile,
            status,
            client_commit_hash,
            server_commit_hash,
            server_seed_b64,
            input_json,
            outcome_json
          FROM arcade_action
          WHERE id = ${n}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(!i.length)return{kind:"err",err:(0,f.apiError)("not_found")};let a=i[0];if(a.user_id!==r)return{kind:"err",err:(0,f.apiError)("x_user_id_mismatch")};if(a.module!==N)return{kind:"err",err:(0,f.apiError)("invalid_input")};if("resolved"===a.status)return{kind:"ok",already:!0,outcome:a.outcome_json};if("committed"!==a.status)return{kind:"err",err:(0,f.apiError)("trade_state_conflict",{details:{status:a.status}})};let d=(0,g.sha256Hex)(o);if(!(0,g.isSha256Hex)(d)||d!==String(a.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,g.sha256Hex)(`${a.server_seed_b64}:${a.client_commit_hash}:${a.module}:${a.profile}:${r}`)!==String(a.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,f.apiError)("internal_error",{details:"server_commit_mismatch"})};let s=a.input_json?.item_a,u=a.input_json?.item_b,l=String(s?.kind??"").trim(),c=String(s?.code??"").trim(),p=String(s?.rarity??"").trim(),_=String(u?.kind??"").trim(),m=String(u?.code??"").trim(),E=String(u?.rarity??"").trim();if("cosmetic"!==l||"cosmetic"!==_||!c||!m||!p||!E||c===m&&p===E)return{kind:"err",err:(0,f.apiError)("internal_error",{details:"invalid_action_input"})};let h=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${l}
            AND code = ${c}
            AND rarity = ${p}
          LIMIT 1
          FOR UPDATE
        `,y=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${_}
            AND code = ${m}
            AND rarity = ${E}
          LIMIT 1
          FOR UPDATE
        `;if(!h.length||!y.length)return{kind:"err",err:(0,f.apiError)("not_found")};if(1>Number(h[0].quantity??0)||1>Number(y[0].quantity??0))return{kind:"err",err:(0,f.apiError)("insufficient_balance")};let R=await e`
          SELECT id::text AS id, quantity
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = ${S.SHARD_ITEM.kind}
            AND code = ${S.SHARD_ITEM.code}
            AND rarity = ${S.SHARD_ITEM.rarity}
          LIMIT 1
          FOR UPDATE
        `,v=Number(R[0]?.quantity??0);if(v<25)return{kind:"err",err:(0,f.apiError)("insufficient_balance",{details:{message:"Need 25 shards to fuse."}})};let A=(0,T.resolveFusion)({actionId:a.id,userId:r,module:a.module,profile:a.profile,serverSeedB64:a.server_seed_b64,clientSeed:o,clientCommitHash:a.client_commit_hash,input:{code_a:c,rarity_a:p,code_b:m,rarity_b:E}});async function w(t,r){let i=r-1;0===i?await e`DELETE FROM arcade_inventory WHERE id = ${t}::uuid`:await e`UPDATE arcade_inventory SET quantity = ${i}, updated_at = now() WHERE id = ${t}::uuid`}await w(h[0].id,Number(h[0].quantity)),await w(y[0].id,Number(y[0].quantity)),await (0,x.logArcadeConsumption)(e,{user_id:r,kind:l,code:c,rarity:p,quantity:1,context_type:"fusion_input",context_id:a.id,module:N,metadata:{slot:"a",consumed:!0}}),await (0,x.logArcadeConsumption)(e,{user_id:r,kind:_,code:m,rarity:E,quantity:1,context_type:"fusion_input",context_id:a.id,module:N,metadata:{slot:"b",consumed:!0}});let b=R[0].id,D=v-25;0===D?await e`DELETE FROM arcade_inventory WHERE id = ${b}::uuid`:await e`UPDATE arcade_inventory SET quantity = ${D}, updated_at = now() WHERE id = ${b}::uuid`,await (0,x.logArcadeConsumption)(e,{user_id:r,kind:S.SHARD_ITEM.kind,code:S.SHARD_ITEM.code,rarity:S.SHARD_ITEM.rarity,quantity:25,context_type:"fusion_cost",context_id:a.id,module:N,metadata:{cost_shards:25}}),await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${r}::uuid,
            ${A.outcome.kind},
            ${A.outcome.code},
            ${A.outcome.rarity},
            1,
            ${e.json({label:A.outcome.label,...A.outcome.metadata,source:N,action_id:a.id})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `;let $={module:a.module,profile:a.profile,input:{item_a:{kind:l,code:c,rarity:p},item_b:{kind:_,code:m,rarity:E}},outcome:A.outcome,audit:{client_commit_hash:a.client_commit_hash,server_commit_hash:a.server_commit_hash,server_seed_b64:a.server_seed_b64,random_hash:A.audit.random_hash,roll:A.audit.roll,total:A.audit.total,upgraded:A.audit.upgraded}};return await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json($)}
          WHERE id = ${a.id}::uuid
        `,await (0,C.addArcadeXp)(e,{userId:r,deltaXp:3,contextRandomHash:A.audit.random_hash,source:N}),{kind:"ok",already:!1,outcome:$}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:n,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,A.responseForDbError)("arcade_fusion_reveal",t);if(e)return e;return(0,f.apiError)("internal_error")}}e.s(["POST",()=>D,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],245102);var $=e.i(245102);let I=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/arcade/fusion/reveal/route",pathname:"/api/arcade/fusion/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/fusion/reveal/route.ts",nextConfigOutput:"",userland:$}),{workAsyncStorage:O,workUnitAsyncStorage:H,serverHooks:P}=I;function q(){return(0,i.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:H})}async function M(e,t,i){I.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/arcade/fusion/reveal/route";R=R.replace(/\/index$/,"")||"/";let f=await I.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:v,params:A,nextConfig:w,parsedUrl:g,isDraftMode:T,prerenderManifest:S,routerServerContext:x,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,resolvedPathname:b,clientReferenceManifest:N,serverActionsManifest:D}=f,$=(0,d.normalizeAppPath)(R),O=!!(S.dynamicRoutes[$]||S.routes[b]),H=async()=>((null==x?void 0:x.render404)?await x.render404(e,t,g,!1):t.end("This page could not be found"),null);if(O&&!T){let e=!!S.routes[b],t=S.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await H();throw new h.NoFallbackError}}let P=null;!O||I.isDev||T||(P="/index"===(P=b)?"/":P);let q=!0===I.isDev||!O,M=O&&!q;D&&N&&(0,o.setManifestsSingleton)({page:R,clientReferenceManifest:N,serverActionsManifest:D});let U=e.method||"GET",j=(0,n.getTracer)(),F=j.getActiveScopeSpan(),L={params:A,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,a)=>I.onRequestError(e,t,i,a,x)},sharedContext:{buildId:v}},W=new s.NodeNextRequest(e),K=new s.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(W,(0,u.signalFromNodeResponse)(t));try{let o=async e=>I.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${U} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${R}`)}),d=!!(0,a.getRequestMeta)(e,"minimalMode"),s=async a=>{var n,s;let u=async({previousCacheEntry:r})=>{try{if(!d&&C&&k&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=L.renderOpts.fetchMetrics;let s=L.renderOpts.pendingWaitUntil;s&&i.waitUntil&&(i.waitUntil(s),s=void 0);let u=L.renderOpts.collectedTags;if(!O)return await (0,p.sendResponse)(W,K,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,_.toNodeOutgoingHttpHeaders)(n.headers);u&&(t[E.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,i=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await I.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,x),t}},l=await I.handleResponse({req:e,nextConfig:w,cacheKey:P,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:k,responseGenerator:u,waitUntil:i.waitUntil,isMinimalMode:d});if(!O)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(s=l.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});d||t.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let h=(0,_.fromNodeOutgoingHttpHeaders)(l.value.headers);return d&&O||h.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||h.get("Cache-Control")||h.set("Cache-Control",(0,m.getCacheControlHeader)(l.cacheControl)),await (0,p.sendResponse)(W,K,new Response(l.value.body,{headers:h,status:l.value.status||200})),null};F?await s(F):await j.withPropagatedContext(e.headers,()=>j.trace(l.BaseServerSpan.handleRequest,{spanName:`${U} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},s))}catch(t){if(t instanceof h.NoFallbackError||await I.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,x),O)throw t;return await (0,p.sendResponse)(W,K,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>q,"routeModule",()=>I,"serverHooks",()=>P,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>H],873608)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_73d3f46d.js.map