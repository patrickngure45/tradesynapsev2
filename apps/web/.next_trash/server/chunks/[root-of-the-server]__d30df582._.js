module.exports=[918622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},556704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},832319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},270406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},193695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},522734,(e,t,r)=>{t.exports=e.x("fs",()=>require("fs"))},446786,(e,t,r)=>{t.exports=e.x("os",()=>require("os"))},504446,(e,t,r)=>{t.exports=e.x("net",()=>require("net"))},755004,(e,t,r)=>{t.exports=e.x("tls",()=>require("tls"))},254799,(e,t,r)=>{t.exports=e.x("crypto",()=>require("crypto"))},688947,(e,t,r)=>{t.exports=e.x("stream",()=>require("stream"))},60438,(e,t,r)=>{t.exports=e.x("perf_hooks",()=>require("perf_hooks"))},666680,(e,t,r)=>{t.exports=e.x("node:crypto",()=>require("node:crypto"))},691180,e=>{"use strict";var t=e.i(666680);let r="pp_session";function n(e){return e.toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function o(e,r){return n((0,t.createHmac)("sha256",e).update(r,"utf8").digest())}function i(e){if(!e)return{};let t={};for(let r of e.split(/;\s*/g)){let e=r.indexOf("=");if(e<=0)continue;let n=r.slice(0,e).trim(),o=r.slice(e+1).trim();n&&(t[n]=decodeURIComponent(o))}return t}function s(e){return i(e.headers.get("cookie"))[r]??null}function a(e){let t=Math.floor((e.now??Date.now())/1e3),r="number"==typeof e.ttlSeconds?e.ttlSeconds:604800,i={uid:e.userId,iat:t,exp:t+r,..."number"==typeof e.sessionVersion&&Number.isFinite(e.sessionVersion)?{sv:Math.max(0,Math.trunc(e.sessionVersion))}:{}},s=n(Buffer.from(JSON.stringify(i),"utf8")),a=o(e.secret,s);return`${s}.${a}`}function u(e){let r,n=e.token.trim(),i=n.indexOf(".");if(i<=0)return{ok:!1,error:"session_token_invalid"};let s=n.slice(0,i),a=n.slice(i+1);if(!s||!a)return{ok:!1,error:"session_token_invalid"};let u=o(e.secret,s),l=Buffer.from(a),d=Buffer.from(u);if(l.length!==d.length||!(0,t.timingSafeEqual)(l,d))return{ok:!1,error:"session_token_invalid"};try{let e,t;r=JSON.parse((e=s.length%4,t=(s+(e?"=".repeat(4-e):"")).replace(/-/g,"+").replace(/_/g,"/"),Buffer.from(t,"base64")).toString("utf8"))}catch{return{ok:!1,error:"session_token_invalid"}}if(!r||"object"!=typeof r||"string"!=typeof r.uid||!r.uid||"number"!=typeof r.exp||!Number.isFinite(r.exp))return{ok:!1,error:"session_token_invalid"};if(null!=r.sv){let e=Number(r.sv);if(!Number.isFinite(e)||e<0)return{ok:!1,error:"session_token_invalid"};r.sv=Math.max(0,Math.trunc(e))}let c=Math.floor((e.now??Date.now())/1e3);return r.exp<=c?{ok:!1,error:"session_token_expired"}:{ok:!0,payload:r}}function l(e){let t=[`${r}=${encodeURIComponent(e.token)}`,"Path=/","HttpOnly","SameSite=Lax",`Max-Age=${Math.max(0,Math.floor(e.maxAgeSeconds))}`];return e.secure&&t.push("Secure"),t.join("; ")}function d(e){let t=[`${r}=`,"Path=/","HttpOnly","SameSite=Lax","Max-Age=0"];return e?.secure&&t.push("Secure"),t.join("; ")}e.s(["createSessionToken",()=>a,"getSessionTokenFromRequest",()=>s,"parseCookieHeader",()=>i,"serializeClearSessionCookie",()=>d,"serializeSessionCookie",()=>l,"verifySessionToken",()=>u])},324725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},90878,e=>{"use strict";async function t(e,t){await e`
    INSERT INTO audit_log (
      actor_id,
      actor_type,
      action,
      resource_type,
      resource_id,
      ip,
      user_agent,
      request_id,
      detail
    ) VALUES (
      ${t.actorId??null},
      ${t.actorType??"user"},
      ${t.action},
      ${t.resourceType??null},
      ${t.resourceId??null},
      ${t.ip??null},
      ${t.userAgent??null},
      ${t.requestId??null},
      ${JSON.stringify(t.detail??{})}::jsonb
    )
  `}function r(e){return{ip:e.headers.get("x-real-ip")??e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()??null,userAgent:e.headers.get("user-agent"),requestId:e.headers.get("x-request-id")}}e.s(["auditContextFromRequest",()=>r,"writeAuditLog",()=>t])},371276,e=>{"use strict";let t=function(){let e=[];for(let t of["SECRET_KEY","PROOFPACK_SESSION_SECRET","PROOFPACK_SESSION_BOOTSTRAP_KEY","PROOFPACK_REVIEWER_KEY","EXCHANGE_ADMIN_KEY","EXCHANGE_CRON_SECRET","CRON_SECRET","RESET_SECRET","ADMIN_RESET_SECRET","INTERNAL_SERVICE_SECRET","DEPLOYER_PRIVATE_KEY","CITADEL_MASTER_SEED","GROQ_API_KEY","GOOGLE_API_KEY","PINATA_JWT","BINANCE_API_KEY","BINANCE_API_SECRET"]){let r=String(process.env[t]??"").trim();r&&r.length>=8&&e.push(r)}return e}();function r(e){let r=e;for(let e of t)e&&r.includes(e)&&(r=r.split(e).join("[REDACTED]"));return r}function n(e,t,n){var o;let i,s=e.headers.get("x-request-id")??"unknown",a=new URL(e.url,"http://localhost");i={...o={requestId:s,method:e.method,path:a.pathname,status:t.status,durationMs:Date.now()-n.startMs,ip:e.headers.get("x-real-ip")??e.headers.get("x-forwarded-for")?.split(",")[0]?.trim()??null,userAgent:e.headers.get("user-agent"),userId:n.userId??null,meta:n.meta,ts:new Date().toISOString()},userAgent:o.userAgent?r(o.userAgent):o.userAgent,meta:o.meta?function e(t,n){if(n>6)return"[TRUNCATED]";if(null==t)return t;if("string"==typeof t)return r(t);if("number"==typeof t||"boolean"==typeof t)return t;if(Array.isArray(t))return t.slice(0,50).map(t=>e(t,n+1));if("object"==typeof t){let r={},o=0;for(let[i,s]of Object.entries(t)){if((o+=1)>80){r.__more__="[TRUNCATED]";break}!function(e){let t=e.toLowerCase();return t.includes("password")||t.includes("secret")||t.includes("token")||t.includes("apikey")||t.includes("api_key")||t.includes("private")||t.includes("seed")||t.includes("jwt")||t.includes("authorization")||t.includes("cookie")}(i)?r[i]=e(s,n+1):r[i]="[REDACTED]"}return r}return String(t)}(o.meta,0):o.meta},process.stdout.write(JSON.stringify(i)+"\n")}e.s(["logRouteResponse",()=>n],371276)},279174,e=>{"use strict";var t=e.i(666680);let r="ABCDEFGHIJKLMNOPQRSTUVWXYZ234567";function n(e,n,o){let i=function(e){let t=e.replace(/[=\s]/g,"").toUpperCase(),n=0,o=0,i=[];for(let e of t){let t=r.indexOf(e);if(-1===t)throw Error(`Invalid base32 character: ${e}`);o=o<<5|t,(n+=5)>=8&&(i.push(o>>>n-8&255),n-=8)}return Buffer.from(i)}(e),s=Math.floor(Math.floor((o??Date.now())/1e3)/30);for(let e=-1;e<=1;e++)if(function(e,r){let n=Buffer.alloc(8);n.writeBigUInt64BE(r);let o=(0,t.createHmac)("sha1",e).update(n).digest(),i=15&o[o.length-1];return String(((127&o[i])<<24|(255&o[i+1])<<16|(255&o[i+2])<<8|255&o[i+3])%1e6).padStart(6,"0")}(i,BigInt(s+e))===n.trim())return!0;return!1}function o(){return function(e){let t=0,n=0,o="";for(let i of e)for(n=n<<8|i,t+=8;t>=5;)o+=r[n>>>t-5&31],t-=5;return t>0&&(o+=r[n<<5-t&31]),o}((0,t.randomBytes)(20))}function i(e){let t=e.issuer??"TradeSynapse",r=`${t}:${e.email}`,n=new URLSearchParams({secret:e.secret,issuer:t,algorithm:"SHA1",digits:String(6),period:String(30)});return`otpauth://totp/${encodeURIComponent(r)}?${n.toString()}`}function s(e=8){let r="ABCDEFGHJKLMNPQRSTUVWXYZ23456789",n=[];for(let o=0;o<e;o++){let e=(0,t.randomBytes)(8),o="";for(let t of e)o+=r[t%r.length];n.push(`${o.slice(0,4)}-${o.slice(4)}`)}return n}e.s(["buildTOTPUri",()=>i,"generateBackupCodes",()=>s,"generateTOTPSecret",()=>o,"verifyTOTP",()=>n])},449507,e=>{"use strict";var t=e.i(666680);function r(e,r){return new Promise((n,o)=>{(0,t.scrypt)(e,r,64,{N:16384,r:8,p:1},(e,t)=>{e?o(e):n(t)})})}async function n(e){let n=(0,t.randomBytes)(32),o=await r(e,n);return`${n.toString("hex")}:${o.toString("hex")}`}async function o(e,n){let[o,i]=n.split(":");if(!o||!i)return!1;let s=Buffer.from(o,"hex"),a=Buffer.from(i,"hex"),u=await r(e,s);return u.length===a.length&&(0,t.timingSafeEqual)(u,a)}e.s(["hashPassword",()=>n,"verifyPassword",()=>o])},630450,e=>{"use strict";var t=e.i(747909),r=e.i(174017),n=e.i(996250),o=e.i(759756),i=e.i(561916),s=e.i(174677),a=e.i(869741),u=e.i(316795),l=e.i(487718),d=e.i(995169),c=e.i(47587),p=e.i(666012),f=e.i(570101),g=e.i(626937),h=e.i(10372),_=e.i(193695);e.i(52474);var m=e.i(600220),E=e.i(469719),x=e.i(89171),R=e.i(843793),S=e.i(449507),y=e.i(691180),w=e.i(279174),v=e.i(90878),T=e.i(371276);let A=E.z.object({email:E.z.string().email(),password:E.z.string().min(1),totp_code:E.z.string().optional(),backup_code:E.z.string().optional()});async function C(e){let t,r=Date.now(),n=await e.json().catch(()=>({}));try{t=A.parse(n)}catch{return x.NextResponse.json({error:"Email and password required"},{status:400})}let o=(0,R.getSql)(),i=t.email.toLowerCase().trim(),s=await o`
    SELECT id, password_hash, status, display_name, email, totp_enabled, totp_secret, totp_backup_codes,
           coalesce(session_version, 0) AS session_version
    FROM app_user
    WHERE email = ${i}
    LIMIT 1
  `;if(0===s.length){try{await (0,v.writeAuditLog)(o,{actorId:null,actorType:"user",action:"auth.login.failed",resourceType:"user",resourceId:null,...(0,v.auditContextFromRequest)(e),detail:{reason:"unknown_email"}})}catch(e){console.error("[login] Failed to write audit log:",e instanceof Error?e.message:e)}return x.NextResponse.json({error:"invalid_credentials"},{status:401})}let a=s[0];if(!a.password_hash)return x.NextResponse.json({error:"invalid_credentials"},{status:401});if("active"!==a.status)return x.NextResponse.json({error:"account_not_active"},{status:403});if(!await (0,S.verifyPassword)(t.password,a.password_hash)){try{await (0,v.writeAuditLog)(o,{actorId:a.id,actorType:"user",action:"auth.login.failed",resourceType:"user",resourceId:a.id,...(0,v.auditContextFromRequest)(e),detail:{reason:"invalid_password"}})}catch(e){console.error("[login] Failed to write audit log:",e instanceof Error?e.message:e)}return x.NextResponse.json({error:"invalid_credentials"},{status:401})}if(a.totp_enabled&&a.totp_secret){let r,n=String(t.totp_code??"").trim(),i=8!==(r=String(t.backup_code??"").toUpperCase().replace(/[^A-Z0-9]/g,"")).length?"":`${r.slice(0,4)}-${r.slice(4)}`,s=!1,u=!1;if(/^\d{6}$/.test(n)&&(0,w.verifyTOTP)(String(a.totp_secret),n)&&(s=!0),!s&&i&&await o.begin(async e=>(await e`
          UPDATE app_user
          SET totp_backup_codes = array_remove(totp_backup_codes, ${i})
          WHERE id = ${a.id}::uuid
            AND totp_backup_codes IS NOT NULL
            AND ${i} = ANY(totp_backup_codes)
          RETURNING id
        `).length>0)&&(s=!0,u=!0),!s){try{await (0,v.writeAuditLog)(o,{actorId:a.id,actorType:"user",action:"auth.login.failed",resourceType:"user",resourceId:a.id,...(0,v.auditContextFromRequest)(e),detail:{reason:n||i?"invalid_2fa":"totp_required"}})}catch(e){console.error("[login] Failed to write audit log:",e instanceof Error?e.message:e)}return x.NextResponse.json({error:n||i?"invalid_totp_code":"totp_required",totp_required:!0},{status:401})}if(u)try{await (0,v.writeAuditLog)(o,{actorId:a.id,actorType:"user",action:"auth.totp.backup_code.used",resourceType:"user",resourceId:a.id,...(0,v.auditContextFromRequest)(e)})}catch(e){console.error("[login] Failed to write audit log:",e instanceof Error?e.message:e)}}let u=process.env.PROOFPACK_SESSION_SECRET??"";if(!u)return x.NextResponse.json({error:"Server misconfigured"},{status:500});let l=(0,y.createSessionToken)({userId:a.id,secret:u,ttlSeconds:604800,sessionVersion:Number(a.session_version??0)||0});try{await (0,v.writeAuditLog)(o,{actorId:a.id,actorType:"user",action:"auth.login.success",resourceType:"user",resourceId:a.id,...(0,v.auditContextFromRequest)(e),detail:{totp_enabled:!!a.totp_enabled}})}catch(e){console.error("[login] Failed to write audit log:",e instanceof Error?e.message:e)}let d=new x.NextResponse(JSON.stringify({ok:!0,user:{id:a.id,email:a.email,displayName:a.display_name}}),{status:200,headers:{"content-type":"application/json","set-cookie":(0,y.serializeSessionCookie)({token:l,maxAgeSeconds:604800,secure:!0})}});return(0,T.logRouteResponse)(e,d,{startMs:r,userId:a.id}),d}e.s(["POST",()=>C,"runtime",0,"nodejs"],211615);var N=e.i(211615);let k=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/auth/login/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:I,workUnitAsyncStorage:O,serverHooks:b}=k;function P(){return(0,n.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:O})}async function q(e,t,n){k.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/auth/login/route";E=E.replace(/\/index$/,"")||"/";let x=await k.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:R,params:S,nextConfig:y,parsedUrl:w,isDraftMode:v,prerenderManifest:T,routerServerContext:A,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,resolvedPathname:I,clientReferenceManifest:O,serverActionsManifest:b}=x,P=(0,a.normalizeAppPath)(E),q=!!(T.dynamicRoutes[P]||T.routes[I]),$=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,w,!1):t.end("This page could not be found"),null);if(q&&!v){let e=!!T.routes[I],t=T.dynamicRoutes[P];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await $();throw new _.NoFallbackError}}let j=null;!q||k.isDev||v||(j="/index"===(j=I)?"/":j);let D=!0===k.isDev||!q,M=q&&!D;b&&O&&(0,s.setManifestsSingleton)({page:E,clientReferenceManifest:O,serverActionsManifest:b});let U=e.method||"GET",F=(0,i.getTracer)(),H=F.getActiveScopeSpan(),L={params:S,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,o)=>k.onRequestError(e,t,n,o,A)},sharedContext:{buildId:R}},B=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),V=l.NextRequestAdapter.fromNodeNextRequest(B,(0,l.signalFromNodeResponse)(t));try{let s=async e=>k.handle(V,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${U} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${E}`)}),a=!!(0,o.getRequestMeta)(e,"minimalMode"),u=async o=>{var i,u;let l=async({previousCacheEntry:r})=>{try{if(!a&&C&&N&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await s(o);e.fetchMetrics=L.renderOpts.fetchMetrics;let u=L.renderOpts.pendingWaitUntil;u&&n.waitUntil&&(n.waitUntil(u),u=void 0);let l=L.renderOpts.collectedTags;if(!q)return await (0,p.sendResponse)(B,K,i,L.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[h.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await k.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,A),t}},d=await k.handleResponse({req:e,nextConfig:y,cacheKey:j,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:N,responseGenerator:l,waitUntil:n.waitUntil,isMinimalMode:a});if(!q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(u=d.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});a||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let _=(0,f.fromNodeOutgoingHttpHeaders)(d.value.headers);return a&&q||_.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||_.get("Cache-Control")||_.set("Cache-Control",(0,g.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(B,K,new Response(d.value.body,{headers:_,status:d.value.status||200})),null};H?await u(H):await F.withPropagatedContext(e.headers,()=>F.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${E}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},u))}catch(t){if(t instanceof _.NoFallbackError||await k.onRequestError(e,t,{routerKind:"App Router",routePath:P,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,A),q)throw t;return await (0,p.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>q,"patchFetch",()=>P,"routeModule",()=>k,"serverHooks",()=>b,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>O],630450)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__d30df582._.js.map