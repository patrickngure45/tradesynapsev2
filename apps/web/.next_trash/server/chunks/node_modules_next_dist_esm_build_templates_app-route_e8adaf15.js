module.exports=[201409,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),i=e.i(759756),o=e.i(561916),s=e.i(174677),n=e.i(869741),d=e.i(316795),u=e.i(487718),l=e.i(995169),_=e.i(47587),c=e.i(666012),p=e.i(570101),h=e.i(626937),w=e.i(10372),f=e.i(193695);e.i(52474);var m=e.i(600220),E=e.i(469719),y=e.i(843793),b=e.i(891454),A=e.i(364608),g=e.i(300959),R=e.i(677702),S=e.i(361179),T=e.i(184883),N=e.i(371276),I=e.i(90878),v=e.i(630862);let q=Number(process.env.WITHDRAWAL_MAX_COUNT_1H)||5,C=Number(process.env.WITHDRAWAL_MAX_COUNT_24H)||15,x=process.env.WITHDRAWAL_MAX_AMOUNT_24H??"0";async function H(e,t,a){let{c1h:r,c24h:i,sum24h:o}=(await e`
    SELECT
      count(*) FILTER (WHERE created_at >= now() - interval '1 hour')::int AS c1h,
      count(*)::int AS c24h,
      coalesce(sum(amount), 0)::text AS sum24h
    FROM ex_withdrawal_request
    WHERE user_id = ${t}::uuid
      AND created_at >= now() - interval '24 hours'
      AND status NOT IN ('failed', 'canceled', 'rejected')
  `)[0]??{c1h:0,c24h:0,sum24h:"0"};if(r>=q)return{ok:!1,code:"withdrawal_velocity_1h",detail:{limit:q,current:r,window:"1h"}};if(i>=C)return{ok:!1,code:"withdrawal_velocity_24h",detail:{limit:C,current:i,window:"24h"}};if("0"!==x)try{let e=(0,v.toBigInt3818)(x),t=(0,v.toBigInt3818)(o),r=(0,v.toBigInt3818)(a);if(t+r>e)return{ok:!1,code:"withdrawal_amount_24h",detail:{limit:x,current:o,window:"24h"}}}catch{}return{ok:!0}}var D=e.i(795374),L=e.i(430848),W=e.i(194748),O=e.i(151693),k=e.i(60828),$=e.i(831075);let U=null,M=E.z.string().regex(/^0x[a-fA-F0-9]{40}$/i,"Invalid address").transform(e=>e.toLowerCase()),F=E.z.object({asset_id:E.z.string().uuid(),amount:R.amount3818PositiveSchema,destination_address:M,reference:E.z.string().min(1).max(200).optional(),totp_code:E.z.string().length(6).regex(/^\d{6}$/).optional(),use_fee_boost:E.z.boolean().optional().default(!1),use_priority_boost:E.z.boolean().optional().default(!1)});class P extends Error{status;code;details;constructor(e){super(e.code),this.status=e.status,this.code=e.code,this.details=e.details}}function B(e,t){let a=(process.env[e]??t).trim();return a?a.split(",").map(e=>e.trim()).filter(Boolean):[]}function j(e,t){let a=((process.env[e]??"").trim()||t).trim();if(!a||"0"===a)return null;try{return(0,v.toBigInt3818)(a)}catch{try{return(0,v.toBigInt3818)(t)}catch{return null}}}async function G(e,t){let a=await e`
    SELECT coalesce(sum(amount), 0)::text AS sum24h
    FROM ex_withdrawal_request
    WHERE user_id = ${t.userId}::uuid
      AND asset_id = ${t.assetId}::uuid
      AND created_at >= now() - interval '24 hours'
      AND status NOT IN ('failed', 'canceled', 'rejected')
  `;return a[0]?.sum24h??"0"}async function X(e){let t=Date.now(),a=(0,y.getSql)(),r=null,i=(a,i)=>{try{(0,N.logRouteResponse)(e,a,{startMs:t,userId:r,meta:i})}catch{}return a},o=await (0,b.requireSessionUserId)(a,e);if(!o.ok)return i(o.response,{code:"unauthorized"});r=o.userId;try{let t,o;try{if(!(await (function(e){if(U)return U;let t=Number(String(process.env.EXCHANGE_WITHDRAW_REQUEST_MAX_PER_MIN??"6").trim()),a=Number.isFinite(t)&&t>0?Math.trunc(t):6;return U=(0,$.createPgRateLimiter)(e,{name:"exchange-withdraw-request",windowMs:6e4,max:a})})(a).consume(`u:${r}`)).allowed)return i((0,g.apiError)("rate_limit_exceeded",{status:429}),{code:"rate_limit_exceeded"})}catch{}let s=await (0,A.requireActiveUser)(a,r);if(s)return i((0,g.apiError)(s),{code:s});let n=await e.json().catch(()=>({}));try{t=F.parse(n)}catch(e){return i((0,g.apiZodError)(e)??(0,g.apiError)("invalid_input"),{code:"invalid_input"})}let d=await a`
      SELECT id, chain, symbol
      FROM ex_asset
      WHERE id = ${t.asset_id} AND is_enabled = true
      LIMIT 1
    `;if(0===d.length)return i((0,g.apiError)("not_found",{status:404}),{code:"not_found"});let u=d[0];if("bsc"!==u.chain)return i((0,g.apiError)("invalid_input",{status:400,details:"unsupported_chain"}),{code:"unsupported_chain"});let l=String(u.symbol??"").toUpperCase(),_=(await a`
      SELECT email_verified, kyc_level, totp_enabled
      FROM app_user
      WHERE id = ${r}::uuid
      LIMIT 1
    `)[0];if(!_)return i((0,g.apiError)("user_not_found"),{code:"user_not_found"});if(!_.email_verified)return i((0,g.apiError)("email_not_verified",{status:403,details:{message:"Verify your email before requesting a withdrawal."}}),{code:"email_not_verified"});let c=process.env.PROOFPACK_SESSION_SECRET??"";if(!c)return i((0,g.apiError)("session_secret_not_configured"),{code:"session_secret_not_configured"});let p=(0,O.getStepUpTokenFromRequest)(e),h="string"==typeof p&&p?(0,O.verifyStepUpToken)({token:p,secret:c}):null,w=!!h&&h.ok&&h.payload.uid===r,f=B("WITHDRAWAL_LARGE_STEPUP_ASSETS","USDT,USDC,BUSD").map(e=>e.toUpperCase()),m=j("WITHDRAWAL_LARGE_STEPUP_MIN","1000"),E=!!m&&f.includes(l)&&(0,v.toBigInt3818)(t.amount)>=m,y=null,b=async()=>{if(null!==y)return y;let e=await a`
        SELECT count(*)::int AS c
        FROM user_passkey_credential
        WHERE user_id = ${r}::uuid
      `;return y=e[0]?.c??0};if(!w)if(E){if(await b()>0)return i((0,g.apiError)("stepup_required",{status:403,details:{message:"Large withdrawals require passkey confirmation.",required_for:"large_withdrawal"}}),{code:"stepup_required"});if(!_.totp_enabled)return i((0,g.apiError)("totp_setup_required",{status:403,details:{message:"Set up 2FA before requesting large withdrawals."}}),{code:"totp_setup_required"});{let e=await (0,D.enforceTotpRequired)(a,r,t.totp_code);if(e)return i(e,{code:"totp_required"})}}else if(_.totp_enabled){let e=await (0,D.enforceTotpRequired)(a,r,t.totp_code);if(e)return i(e,{code:"totp_required"})}else{if(await b()>0)return i((0,g.apiError)("stepup_required",{status:403,details:{message:"Confirm with your passkey to continue."}}),{code:"stepup_required"});return i((0,g.apiError)("totp_setup_required",{status:403,details:{message:"Set up 2FA or add a passkey before requesting a withdrawal."}}),{code:"totp_setup_required"})}let R="full"===_.kyc_level||"basic"===_.kyc_level||"none"===_.kyc_level?_.kyc_level:"none",T=await H(a,r,t.amount);if(!T.ok)return i(Response.json({error:T.code,detail:T.detail},{status:429,headers:{"Retry-After":"60"}}),{code:T.code});let N=B("WITHDRAWAL_NO_KYC_ALLOWED_ASSETS","USDT").map(e=>e.toUpperCase()),q=B("WITHDRAWAL_BASIC_ALLOWED_ASSETS","USDT,USDC,BUSD").map(e=>e.toUpperCase()),C=j("WITHDRAWAL_NO_KYC_MAX_SINGLE","50"),x=j("WITHDRAWAL_NO_KYC_MAX_24H","100"),M=j("WITHDRAWAL_BASIC_MAX_SINGLE","2000"),X=j("WITHDRAWAL_BASIC_MAX_24H","5000");if("none"===R){if(!N.includes(l))return i((0,g.apiError)("kyc_required_for_asset",{status:403,details:{message:`Full verification is required to withdraw ${l}.`,required_kyc:"full"}}),{code:"kyc_required_for_asset"});if(C&&(0,v.toBigInt3818)(t.amount)>C)return i((0,g.apiError)("withdrawal_requires_kyc",{status:403,details:{message:"Withdrawal amount exceeds the no-KYC limit.",required_kyc:"basic",limit:process.env.WITHDRAWAL_NO_KYC_MAX_SINGLE??"50"}}),{code:"withdrawal_requires_kyc"});if(x){let e=await G(a,{userId:r,assetId:u.id});if((0,v.toBigInt3818)(e)+(0,v.toBigInt3818)(t.amount)>x)return i((0,g.apiError)("withdrawal_requires_kyc",{status:403,details:{message:"Daily withdrawal limit reached for non-verified accounts.",required_kyc:"basic",limit_24h:process.env.WITHDRAWAL_NO_KYC_MAX_24H??"100",current_24h:e}}),{code:"withdrawal_requires_kyc"})}}if("basic"===R){if(!q.includes(l))return i((0,g.apiError)("kyc_required_for_asset",{status:403,details:{message:`Full verification is required to withdraw ${l}.`,required_kyc:"full"}}),{code:"kyc_required_for_asset"});if(M&&(0,v.toBigInt3818)(t.amount)>M)return i((0,g.apiError)("withdrawal_requires_kyc",{status:403,details:{message:"Withdrawal amount exceeds the Basic tier limit.",required_kyc:"full",limit:process.env.WITHDRAWAL_BASIC_MAX_SINGLE??"2000"}}),{code:"withdrawal_requires_kyc"});if(X){let e=await G(a,{userId:r,assetId:u.id});if((0,v.toBigInt3818)(e)+(0,v.toBigInt3818)(t.amount)>X)return i((0,g.apiError)("withdrawal_requires_kyc",{status:403,details:{message:"Daily withdrawal limit reached for Basic tier.",required_kyc:"full",limit_24h:process.env.WITHDRAWAL_BASIC_MAX_24H??"5000",current_24h:e}}),{code:"withdrawal_requires_kyc"})}}try{o=await a.begin(async e=>{let a,i=await e`
      SELECT id, status, created_at
      FROM ex_withdrawal_allowlist
      WHERE user_id = ${r} AND chain = ${u.chain} AND address = ${t.destination_address}
      LIMIT 1
    `;if(0===i.length||"active"!==i[0].status)return{status:403,body:{error:"withdrawal_address_not_allowlisted"}};let o=(a=Number(process.env.WITHDRAWAL_ALLOWLIST_MIN_AGE_HOURS),Number.isFinite(a)&&a>=0?a:0);if(o>0){let t=await e`
        SELECT (created_at <= now() - make_interval(hours => ${o}::int)) AS ok
        FROM ex_withdrawal_allowlist
        WHERE id = ${i[0].id}::uuid
        LIMIT 1
      `;if(t.length>0&&t[0]&&!1===t[0].ok)return{status:403,body:{error:"withdrawal_allowlist_cooldown",details:{message:"New withdrawal addresses require a cooldown before use."}}}}let s=(await e`
      INSERT INTO ex_ledger_account (user_id, asset_id)
      VALUES (${r}, ${u.id})
      ON CONFLICT (user_id, asset_id) DO UPDATE SET user_id = EXCLUDED.user_id
      RETURNING id
    `)[0].id,n=(await e`
      WITH posted AS (
        SELECT coalesce(sum(amount), 0)::numeric AS posted
        FROM ex_journal_line
        WHERE account_id = ${s}
      ),
      held AS (
          SELECT coalesce(sum(remaining_amount), 0)::numeric AS held
        FROM ex_hold
        WHERE account_id = ${s} AND status = 'active'
      )
      SELECT
        posted.posted::text AS posted,
        held.held::text AS held,
        (posted.posted - held.held)::text AS available,
        ((posted.posted - held.held) >= (${t.amount}::numeric)) AS ok
      FROM posted, held
    `)[0],d=await (0,L.quoteGasFee)(e,{action:"withdrawal_request",chain:u.chain,assetSymbol:u.symbol});if("code"in d)return{status:409,body:{error:d.code,details:d.details}};let l=d.enabled?d.chargeAmount??"":"0";if(d.enabled&&(!l||0n>(0,v.toBigInt3818)(l)))return{status:409,body:{error:"gas_fee_invalid",details:{message:"missing_fee_charge_amount",quote:d}}};let _=null,c=null;if(t.use_fee_boost&&d.enabled){let a=(0,v.toBigInt3818)(l||"0");if(a>0n){let i=await e`
          SELECT id::text AS id, quantity, code
          FROM arcade_inventory
          WHERE user_id = ${r}::uuid
            AND kind = 'boost'
            AND code = ANY(ARRAY['fee_25bps_7d','fee_15bps_72h','fee_10bps_48h','fee_5bps_24h']::text[])
          ORDER BY
            CASE code
              WHEN 'fee_25bps_7d' THEN 1
              WHEN 'fee_15bps_72h' THEN 2
              WHEN 'fee_10bps_48h' THEN 3
              WHEN 'fee_5bps_24h' THEN 4
              ELSE 99
            END,
            updated_at DESC
          LIMIT 1
          FOR UPDATE
        `;if(!i.length||0>=Number(i[0].quantity??0))return{status:409,body:{error:"insufficient_balance",details:{message:"No fee discount boost available."}}};let o=i[0],s=String(o.code??"").match(/fee_(\d+)bps/i),n=s?Number(s[1]):0;if(!Number.isFinite(n)||n<=0||n>2500)return{status:409,body:{error:"internal_error",details:{message:"invalid_fee_boost"}}};let d=(0,v.bpsFeeCeil3818)(t.amount,n),u=(0,v.toBigInt3818)(d),p=u>=a?a:u,h=a-p,w=(0,v.fromBigInt3818)(h);l=w,_={code:o.code,bps:n,discount_amount:(0,v.fromBigInt3818)(p),fee_before:(0,v.fromBigInt3818)(a),fee_after:w},c={inventory_id:o.id,code:o.code,quantity:Number(o.quantity??0),fee_before:(0,v.fromBigInt3818)(a),fee_after:w,discount_amount:(0,v.fromBigInt3818)(p),bps:n}}}let p=(0,v.add3818)(t.amount,l||"0");if(!((0,v.toBigInt3818)(n?.available??"0")>=(0,v.toBigInt3818)(p)))return{status:409,body:{error:"insufficient_balance",details:{posted:n?.posted??"0",held:n?.held??"0",available:n?.available??"0",requested:t.amount,network_fee_display:d.enabled?{amount:d.amount,symbol:d.gasSymbol}:{amount:"0",symbol:d.gasSymbol},fee_charged_in_asset:l||"0",total_debit:p}}};let h=await e`
      INSERT INTO ex_withdrawal_request (
        user_id,
        asset_id,
        amount,
        destination_address,
        allowlist_id,
        status,
        reference
      )
      VALUES (
        ${r},
        ${u.id},
        (${t.amount}::numeric),
        ${t.destination_address},
        ${i[0].id},
        'requested',
        ${t.reference??null}
      )
      RETURNING id, status, created_at
    `,w=h[0].id,f=null;if(t.use_priority_boost){let t=await e`
        SELECT id::text AS id, quantity, code, metadata_json
        FROM arcade_inventory
        WHERE user_id = ${r}::uuid
          AND kind = 'boost'
          AND code = ANY(ARRAY['withdraw_priority_72h','withdraw_priority_12h']::text[])
        ORDER BY
          CASE code
            WHEN 'withdraw_priority_72h' THEN 1
            WHEN 'withdraw_priority_12h' THEN 2
            ELSE 99
          END,
          updated_at DESC
        LIMIT 1
        FOR UPDATE
      `;if(!t.length||0>=Number(t[0].quantity??0))return{status:409,body:{error:"insufficient_balance",details:{message:"No withdrawal priority boost available."}}};let a=t[0],i=Number(a.quantity??0),o=String(a.code??"").match(/priority_(\d+)h/i),s=o?Number(o[1]):0,n=a.metadata_json?.duration_hours,d=Math.max(1,Math.min(720,Number(n??s??12)));1===i?await e`
          DELETE FROM arcade_inventory
          WHERE id = ${a.id}::uuid
        `:await e`
          UPDATE arcade_inventory
          SET quantity = ${i-1}, updated_at = now()
          WHERE id = ${a.id}::uuid
        `;let u=await e`
        UPDATE ex_withdrawal_request
        SET priority_until = (
            CASE
              WHEN priority_until IS NULL OR priority_until < now() THEN now()
              ELSE priority_until
            END
          ) + make_interval(hours => ${d}::int),
          priority_boost_code = ${a.code},
          priority_applied_at = now(),
          updated_at = now()
        WHERE id = ${w}::uuid
        RETURNING priority_until::text AS priority_until
      `;f={code:a.code,hours:d,priority_until:String(u[0]?.priority_until??"")},await (0,k.logArcadeConsumption)(e,{user_id:r,kind:"boost",code:a.code,rarity:null,quantity:1,context_type:"withdrawal_request",context_id:w,module:"withdrawal_priority",metadata:{hours:d,priority_until:f.priority_until}})}let m=(await e`
      INSERT INTO ex_hold (account_id, asset_id, amount, reason)
      VALUES (${s}, ${u.id}, (${t.amount}::numeric), ${`withdrawal:${w}`})
      RETURNING id, amount::text AS amount, status, created_at
    `)[0].id;if(await e`
      UPDATE ex_withdrawal_request
      SET hold_id = ${m}, updated_at = now()
      WHERE id = ${w}
    `,d.enabled&&(0,v.toBigInt3818)(l||"0")>0n){let t={...d,chargeAmount:l,details:{...d.details??{},..._?{arcade_fee_boost:{code:_.code,bps:_.bps,fee_before:_.fee_before,fee_after:_.fee_after,discount_amount:_.discount_amount}}:{}}},a=await (0,L.chargeGasFeeFromQuote)(e,{userId:r,action:"withdrawal_request",reference:`withdrawal:${w}`,chain:u.chain,assetSymbol:u.symbol},t);if(a)throw new P({status:409,code:a.code,details:a.details})}if(c){let t=Number(c.quantity??0);if(t<=0)throw new P({status:409,code:"insufficient_balance",details:{message:"No fee discount boost available."}});1===t?await e`
          DELETE FROM arcade_inventory
          WHERE id = ${c.inventory_id}::uuid
        `:await e`
          UPDATE arcade_inventory
          SET quantity = ${t-1}, updated_at = now()
          WHERE id = ${c.inventory_id}::uuid
        `,await (0,k.logArcadeConsumption)(e,{user_id:r,kind:"boost",code:c.code,rarity:null,quantity:1,context_type:"withdrawal_request",context_id:w,module:"withdrawal_fee",metadata:{fee_before:c.fee_before,fee_after:c.fee_after,discount_amount:c.discount_amount,bps:c.bps}})}await (0,S.enqueueOutbox)(e,{topic:"ex.withdrawal.requested",aggregate_type:"withdrawal",aggregate_id:w,payload:{withdrawal_id:w,user_id:r,asset_id:u.id,asset_symbol:u.symbol,chain:u.chain,amount:t.amount,destination_address:t.destination_address}});let E=`${t.destination_address.slice(0,6)}â€¦${t.destination_address.slice(-4)}`;return await (0,W.createNotification)(e,{userId:r,type:"system",title:"Withdrawal requested",body:`You requested to send ${t.amount} ${u.symbol} to ${E}. Processing will start after review/approval.`,metadata:{withdrawal_id:w,asset_symbol:u.symbol,chain:u.chain,amount:t.amount,destination_address:t.destination_address,fee_boost:_,priority_boost:f}}),{status:201,body:{withdrawal:{id:w,asset_id:u.id,chain:u.chain,symbol:u.symbol,amount:t.amount,destination_address:t.destination_address,status:"requested",hold_id:m,created_at:h[0].created_at,priority:f,fees:d.enabled?{network_fee_display_amount:d.amount,network_fee_display_symbol:d.gasSymbol,fee_charged_in_asset_amount:l||"0",fee_charged_in_asset_symbol:u.symbol,fee_boost:_}:{network_fee_display_amount:"0",network_fee_display_symbol:d.gasSymbol,fee_charged_in_asset_amount:"0",fee_charged_in_asset_symbol:u.symbol,fee_boost:_}}}}})}catch(e){if(e instanceof P)return(0,g.apiError)(e.code,{status:e.status,details:e.details});throw e}let K=o.body;if("string"==typeof K.error)return i((0,g.apiError)(K.error,{status:o.status,details:K.details}),{code:K.error});let Y=i(Response.json(o.body,{status:o.status}),{withdrawalId:o.body?.withdrawal?.id});try{let t=o.body?.withdrawal;t?.id&&await (0,I.writeAuditLog)(a,{actorId:r,actorType:"user",action:"withdrawal.requested",resourceType:"withdrawal",resourceId:t.id,...(0,I.auditContextFromRequest)(e),detail:{amount:t.amount,asset_id:t.asset_id,destination:t.destination_address}})}catch{}return Y}catch(t){let e=(0,T.responseForDbError)("exchange.withdrawals.request",t);if(e)return i(e,{code:"db_error"});return console.error("exchange.withdrawals.request failed:",t),i((0,g.apiError)("internal_error",{details:{message:t instanceof Error?t.message:String(t)}}),{code:"internal_error"})}}e.s(["POST",()=>X,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],119745);var K=e.i(119745);let Y=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/exchange/withdrawals/request/route",pathname:"/api/exchange/withdrawals/request",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/withdrawals/request/route.ts",nextConfigOutput:"",userland:K}),{workAsyncStorage:z,workUnitAsyncStorage:V,serverHooks:Q}=Y;function Z(){return(0,r.patchFetch)({workAsyncStorage:z,workUnitAsyncStorage:V})}async function J(e,t,r){Y.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let E="/api/exchange/withdrawals/request/route";E=E.replace(/\/index$/,"")||"/";let y=await Y.prepare(e,t,{srcPage:E,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:b,params:A,nextConfig:g,parsedUrl:R,isDraftMode:S,prerenderManifest:T,routerServerContext:N,isOnDemandRevalidate:I,revalidateOnlyGenerated:v,resolvedPathname:q,clientReferenceManifest:C,serverActionsManifest:x}=y,H=(0,n.normalizeAppPath)(E),D=!!(T.dynamicRoutes[H]||T.routes[q]),L=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,R,!1):t.end("This page could not be found"),null);if(D&&!S){let e=!!T.routes[q],t=T.dynamicRoutes[H];if(t&&!1===t.fallback&&!e){if(g.experimental.adapterPath)return await L();throw new f.NoFallbackError}}let W=null;!D||Y.isDev||S||(W="/index"===(W=q)?"/":W);let O=!0===Y.isDev||!D,k=D&&!O;x&&C&&(0,s.setManifestsSingleton)({page:E,clientReferenceManifest:C,serverActionsManifest:x});let $=e.method||"GET",U=(0,o.getTracer)(),M=U.getActiveScopeSpan(),F={params:A,prerenderManifest:T,renderOpts:{experimental:{authInterrupts:!!g.experimental.authInterrupts},cacheComponents:!!g.cacheComponents,supportsDynamicResponse:O,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:g.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>Y.onRequestError(e,t,r,i,N)},sharedContext:{buildId:b}},P=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),j=u.NextRequestAdapter.fromNodeNextRequest(P,(0,u.signalFromNodeResponse)(t));try{let s=async e=>Y.handle(j,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=U.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==l.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${$} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${E}`)}),n=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let u=async({previousCacheEntry:a})=>{try{if(!n&&I&&v&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await s(i);e.fetchMetrics=F.renderOpts.fetchMetrics;let d=F.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let u=F.renderOpts.collectedTags;if(!D)return await (0,c.sendResponse)(P,B,o,F.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(o.headers);u&&(t[w.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,r=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await Y.onRequestError(e,t,{routerKind:"App Router",routePath:E,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:I})},!1,N),t}},l=await Y.handleResponse({req:e,nextConfig:g,cacheKey:W,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:T,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:v,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:n});if(!D)return null;if((null==l||null==(o=l.value)?void 0:o.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",I?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,p.fromNodeOutgoingHttpHeaders)(l.value.headers);return n&&D||f.delete(w.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,h.getCacheControlHeader)(l.cacheControl)),await (0,c.sendResponse)(P,B,new Response(l.value.body,{headers:f,status:l.value.status||200})),null};M?await d(M):await U.withPropagatedContext(e.headers,()=>U.trace(l.BaseServerSpan.handleRequest,{spanName:`${$} ${E}`,kind:o.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await Y.onRequestError(e,t,{routerKind:"App Router",routePath:H,routeType:"route",revalidateReason:(0,_.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:I})},!1,N),D)throw t;return await (0,c.sendResponse)(P,B,new Response(null,{status:500})),null}}e.s(["handler",()=>J,"patchFetch",()=>Z,"routeModule",()=>Y,"serverHooks",()=>Q,"workAsyncStorage",()=>z,"workUnitAsyncStorage",()=>V],201409)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_e8adaf15.js.map