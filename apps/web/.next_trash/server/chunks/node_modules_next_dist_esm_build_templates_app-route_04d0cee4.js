module.exports=[916959,e=>{"use strict";var t=e.i(747909),a=e.i(174017),s=e.i(996250),n=e.i(759756),r=e.i(561916),o=e.i(174677),i=e.i(869741),l=e.i(316795),c=e.i(487718),d=e.i(995169),u=e.i(47587),p=e.i(666012),h=e.i(570101),E=e.i(626937),g=e.i(10372),m=e.i(193695);e.i(52474);var _=e.i(600220),f=e.i(89171),w=e.i(843793),S=e.i(56778),N=e.i(901323),R=e.i(675677),b=e.i(695184),v=e.i(24672),C=e.i(10967);let T="00000000-0000-0000-0000-000000000001",x="00000000-0000-0000-0000-000000000003",A={WBNB:"0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c",USDC:"0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d",BUSD:"0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56",DAI:"0x1AF3F329e8BE154074D8769D1FFa4eE058B1DBc3",ETH:"0x2170Ed0880ac9A755fd29B2688956BD959F933F8",BTCB:"0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c"};function y(e){let t=String(process.env[e]??"").trim().toLowerCase();return"1"===t||"true"===t||"yes"===t}function P(e,t){let a=Number(String(process.env[e]??"").trim());return Number.isFinite(a)?a:t}function B(e,t,a){return Number.isFinite(e)?Math.max(t,Math.min(a,Math.trunc(e))):t}async function O(e,t){await e`
    INSERT INTO app_user (id, status, kyc_level, country)
    VALUES (${t}::uuid, 'active', 'none', NULL)
    ON CONFLICT (id) DO NOTHING
  `}async function k(e,t,a){return(await e`
    INSERT INTO ex_ledger_account (user_id, asset_id)
    VALUES (${t}::uuid, ${a}::uuid)
    ON CONFLICT (user_id, asset_id) DO UPDATE SET user_id = EXCLUDED.user_id
    RETURNING id::text AS id
  `)[0].id}async function D(e){let t=await e`
    SELECT id::text AS id
    FROM ex_asset
    WHERE LOWER(chain) = 'bsc'
      AND symbol = 'BNB'
      AND is_enabled = true
    LIMIT 1
  `;return t[0]?.id??null}async function $(e,t){let a=await e.getTransactionReceipt(t);if(!a)return null;let s=a.gasUsed,n=a.effectiveGasPrice??a.gasPrice;return"bigint"!=typeof s||"bigint"!=typeof n?null:s*n}async function L(e){let t=(0,C.rankRpcUrls)("bsc"),a=0===Number("true")?97:56,s=S.ethers.Network.from({name:"bnb",chainId:a}),n=null;if(t.length<=1){let a=new S.ethers.JsonRpcProvider(t[0]||process.env.BSC_RPC_URL||"https://bsc-dataseed1.binance.org",s,{staticNetwork:s}),n=new S.ethers.Wallet(e.privateKey,a),r=await n.sendTransaction({to:e.to,value:e.valueWei,gasLimit:e.gasLimit,gasPrice:e.gasPrice});return await r.wait(1),{txHash:r.hash}}for(let a of t){let t=new S.ethers.JsonRpcProvider(a,s,{staticNetwork:s}),r=new S.ethers.Wallet(e.privateKey,t),o=Date.now();try{let t=await r.sendTransaction({to:e.to,value:e.valueWei,gasLimit:e.gasLimit,gasPrice:e.gasPrice});return(0,C.markRpcOk)(a,Date.now()-o),await t.wait(1).catch(()=>void 0),{txHash:t.hash}}catch(e){if((0,C.markRpcFail)(a),n=e,!(0,C.isLikelyRpcTransportError)(e))throw e}}throw n instanceof Error?n:Error("bsc_rpc_all_failed")}async function I(e,t){if(t.gasWei<=0n)return;let a=await D(e);if(!a)return;let s=S.ethers.formatEther(t.gasWei);await e.begin(async e=>{await O(e,T),await O(e,x);let[n,r]=await Promise.all([k(e,T,a),k(e,x,a)]),o=(await e`
      INSERT INTO ex_journal_entry (type, reference, metadata_json)
      VALUES (
        'gas_spend',
        ${`onchain:bsc:${t.txHash}`},
        ${e.json({chain:"bsc",tx_hash:t.txHash,gas_wei:t.gasWei.toString(),gas_bnb:s,kind:t.kind,...t.metadata??{}})}::jsonb
      )
      RETURNING id::text AS id
    `)[0].id;await e`
      INSERT INTO ex_journal_line (entry_id, account_id, asset_id, amount)
      VALUES
        (${o}::uuid, ${n}::uuid, ${a}::uuid, ((${s}::numeric) * -1)),
        (${o}::uuid, ${r}::uuid, ${a}::uuid, (${s}::numeric))
    `})}async function U(e,t,a){if(a?.tokenSymbols&&0===a.tokenSymbols.length)return[];let s=(a?.tokenSymbols??[]).map(e=>String(e||"").trim().toUpperCase()).filter(Boolean),n=await e`
    SELECT symbol, contract_address, decimals
    FROM ex_asset
    WHERE chain = 'bsc'
      AND is_enabled = true
      AND contract_address IS NOT NULL
      AND (${0===s.length}::boolean OR upper(symbol) = ANY(${s}))
  `,r=new Set,o=[];for(let e of n){let a=e.contract_address.toLowerCase();if(r.has(a))continue;r.add(a);let s=process.env[`SWEEP_MIN_${e.symbol.toUpperCase()}`];o.push({symbol:e.symbol,contract:e.contract_address,decimals:e.decimals,minSweep:s?Number(s):t})}if(!y("SWEEP_INCLUDE_EXTRA_TOKENS"))return o;for(let[e,a]of Object.entries(A)){let s=a.toLowerCase();if(r.has(s))continue;r.add(s);let n=process.env[`SWEEP_MIN_${e.toUpperCase()}`];o.push({symbol:e,contract:a,decimals:null,minSweep:n?Number(n):t})}return o}async function H(e,t){let a=new Date().toISOString(),s=!!t?.execute,n=y("SWEEP_EXECUTE")&&s,r=!!t?.allowGasTopups,o=y("SWEEP_ALLOW_GAS_TOPUPS")&&r,i=y("SWEEP_ACCOUNT_GAS_LEDGER"),l=(process.env.SWEEP_MIN_BNB||"0.0001").trim(),c=(process.env.SWEEP_MIN_NATIVE_SWEEP_BNB||l).trim(),d=P("SWEEP_MIN_TOKEN",.001),u=y("SWEEP_TOKEN_CANDIDATES_ONLY"),p=B(P("SWEEP_TOKEN_LOOKBACK_HOURS",720),1,8760),h=(0,N.getBscReadProvider)(),E=(0,R.getHotWalletAddress)();if(!S.ethers.isAddress(E))throw Error("invalid_hot_wallet_address");let g=async t=>{try{await (0,v.upsertServiceHeartbeat)(e,{service:"sweep-deposits:bsc",status:"ok",details:{execute:n,min_bnb:l,min_token_default:d,...t??{}}})}catch{}};await g({event:"start"});let m=(await h.getFeeData()).gasPrice??S.ethers.parseUnits("3","gwei"),_=65000n*m,f=21000n*m,w=S.ethers.parseEther(l),C=S.ethers.parseEther(c),T=(t?.tokenSymbols??[]).map(e=>String(e||"").trim().toUpperCase()).filter(Boolean),x=await U(e,d,{tokenSymbols:t?.tokenSymbols??T}),A=B(P("SWEEP_MAX_TOKENS",10),0,50),O=0===A?[]:x.slice(0,A);if(console.log("--- DEPOSIT SWEEPER ---"),console.log(`Mode: ${n?"EXECUTE":"PLAN ONLY"}`),console.log(`Hot wallet: ${E}`),n&&(console.log(`Ledger gas accounting: ${i?"ON":"OFF"}`),console.log(`Gas top-ups: ${o?"ENABLED":"DISABLED"}`)),console.log(`Gas price: ${S.ethers.formatUnits(m,"gwei")} gwei`),console.log(`Token gas cost: ${S.ethers.formatEther(_)} BNB per token transfer`),console.log(`Native gas cost: ${S.ethers.formatEther(f)} BNB`),0===O.length)console.log("Tokens tracked: (none)");else{let e=O.slice(0,20).map(e=>e.symbol).join(", "),t=O.length>20?` …(+${O.length-20})`:"";console.log(`Tokens tracked: ${e}${t} (${O.length} total)`)}let k=B(P("SWEEP_MAX_DEPOSITS_PER_RUN",200),1,5e3),D=await e`
    SELECT address, derivation_index
    FROM ex_deposit_address
    WHERE chain = 'bsc' OR chain = 'BSC'
    ORDER BY derivation_index ASC
    LIMIT ${k}
  `,H=new Set;if(u&&O.length>0)try{let t=await e`
        SELECT DISTINCT lower(e.to_address) AS address
        FROM ex_chain_deposit_event e
        JOIN ex_asset a ON a.id = e.asset_id
        WHERE lower(e.chain) = 'bsc'
          AND a.contract_address IS NOT NULL
          AND e.created_at > now() - make_interval(hours => ${p})
        LIMIT ${k}
      `;H=new Set(t.map(e=>String(e.address||"").toLowerCase()).filter(Boolean))}catch{H=new Set}if(0===D.length){await g({event:"noop",deposits:0});let e=new Date().toISOString();return{ok:!0,chain:"bsc",execute:n,deposits:0,sweptTransfers:0,gasTopups:0,tokenContracts:O.length,startedAt:a,finishedAt:e}}let W=0,M=0;for(let t of D){let a=t.address.toLowerCase();if(a===E.toLowerCase())continue;let s=await h.getBalance(a),r=O.length>0&&(!u||s>=w||H.has(a)),l=!1,d=[];if(r)for(let e of(await Promise.allSettled(O.map(async e=>{let{balance:t,decimals:s}=await (0,b.getTokenBalance)(e.contract,a);return{token:e,balance:t,decimals:s,balNum:Number(t)}}))))"fulfilled"===e.status&&(e.value.balNum>0&&(l=!0),d.push(e.value));if(0n===s&&!l||s<w&&!l)continue;console.log(`
Address ${a} (idx ${t.derivation_index})`),console.log(`  BNB: ${S.ethers.formatEther(s)}`);let p=await (0,N.getDepositAddressKey)(e,a);if(!p){console.log("  Skipping (no private key available)");continue}let v=d.filter(e=>!Number.isNaN(e.balNum)&&e.balNum>=e.token.minSweep);for(let{token:e,balance:t,balNum:a}of d)a>0&&console.log(`  ${e.symbol}: ${t}`);if(v.length>0){let t=_*BigInt(v.length)*BigInt(Math.round(114.99999999999999))/100n;if(s<t){let r=t-s,l=S.ethers.formatEther(r);if(console.log(`  PLAN: top-up ${l} BNB for gas (${v.length} token transfers)`),n&&o)try{let t=(0,R.getHotWalletKey)(),n=await (0,b.sendBnb)(t,a,l);if(console.log(`  ✅ Gas top-up sent: ${n.txHash}`),i){let t=await $(h,n.txHash).catch(()=>null);t&&await I(e,{txHash:n.txHash,gasWei:t,kind:"sweep_gas_topup",metadata:{to:a,amount_bnb:l}}).catch(()=>void 0)}M+=1,await new Promise(e=>setTimeout(e,3e3)),s=await h.getBalance(a)}catch(e){console.log(`  ❌ Gas top-up failed: ${e?.message??String(e)}`)}else n&&!o&&console.log("  NOTE: gas top-ups disabled; token sweeps may be skipped for insufficient gas.")}}for(let{token:t,balance:r,decimals:o}of v){if(s<_){console.log(`  Skipping ${t.symbol} (insufficient gas: ${S.ethers.formatEther(s)} BNB)`);continue}if(console.log(`  PLAN: sweep ${r} ${t.symbol} -> ${E}`),n)try{let n=await (0,b.sendToken)(t.contract,p,E,r,o);if(console.log(`  ✅ ${t.symbol} swept: ${n.txHash}`),i){let s=await $(h,n.txHash).catch(()=>null);s&&await I(e,{txHash:n.txHash,gasWei:s,kind:"sweep_token",metadata:{from:a,token:t.symbol,contract:t.contract}}).catch(()=>void 0)}W+=1,s=await h.getBalance(a)}catch(e){console.log(`  ❌ ${t.symbol} sweep failed: ${e?.message??String(e)}`)}}let T=await h.getBalance(a);if(T>f){let t=T-f;if(t<C)console.log(`  Skip native sweep: ${S.ethers.formatEther(t)} BNB (< min ${c})`);else if(console.log(`  PLAN: sweep ${S.ethers.formatEther(t)} BNB -> ${E}`),n)try{let s=await L({privateKey:p,to:E,valueWei:t,gasLimit:21000n,gasPrice:m});if(console.log(`  ✅ BNB swept: ${s.txHash}`),i){let t=await $(h,s.txHash).catch(()=>null);t&&await I(e,{txHash:s.txHash,gasWei:t,kind:"sweep_native",metadata:{from:a}}).catch(()=>void 0)}W+=1}catch(e){console.log(`  ❌ BNB sweep failed: ${e?.message??String(e)}`)}}else T>0n&&console.log(`  Dust: ${S.ethers.formatEther(T)} BNB (< gas cost, leaving)`);await g({event:"progress",sweptTransfers:W,gasTopups:M,deposits:D.length})}await g({event:"done",sweptTransfers:W,gasTopups:M,deposits:D.length});let F=new Date().toISOString();return{ok:!0,chain:"bsc",execute:n,requestedExecute:s,requestedGasTopups:r,tokenSymbols:T.length?T:null,deposits:D.length,sweptTransfers:W,gasTopups:M,tokenContracts:O.length,startedAt:a,finishedAt:F}}async function W(e){let t,a=function(e){let t=process.env.EXCHANGE_CRON_SECRET??process.env.CRON_SECRET;if(!t)return"cron_secret_not_configured";let a=e.headers.get("x-cron-secret")??e.nextUrl.searchParams.get("secret");return a&&a===t?null:"cron_unauthorized"}(e);if(a)return f.NextResponse.json({error:a},{status:"cron_unauthorized"===a?401:500});let s="1"!==(t=String(process.env.EXCHANGE_ENABLE_SWEEP_DEPOSITS??"").trim())&&"true"!==t.toLowerCase()?"sweep_deposits_disabled":null;if(s)return f.NextResponse.json({ok:!1,error:s,hint:"Set EXCHANGE_ENABLE_SWEEP_DEPOSITS=1 in production to enable this endpoint."},{status:403});let n=(0,w.getSql)(),r=new URL(e.url),o="1"===(r.searchParams.get("force")??"").trim(),i="1"===(r.searchParams.get("execute")??"").trim(),l="1"===(r.searchParams.get("gas_topups")??"").trim(),c=(r.searchParams.get("tokens")??"").trim(),d=""===c||"0"!==c&&"false"!==c.toLowerCase(),u=(r.searchParams.get("symbols")??"").trim(),p=String(process.env.SWEEP_DEFAULT_SYMBOLS??"USDT,USDC,WBNB").split(",").map(e=>e.trim().toUpperCase()).filter(Boolean),h=d?u?u.split(",").map(e=>e.trim().toUpperCase()).filter(Boolean):p:[],E=String(process.env.SWEEP_CADENCE_MS??"").trim(),g=E?Math.max(0,Math.min(6048e5,Number(E)||0)):0;if(!o&&g>0)try{let e=await n`
        SELECT last_seen_at::text AS last_seen_at
        FROM app_service_heartbeat
        WHERE service = 'sweep-deposits:bsc'
        LIMIT 1
      `,t=e[0]?.last_seen_at?Date.parse(e[0].last_seen_at):NaN;if(Number.isFinite(t)){let e=Date.now()-t;if(e>=0&&e<g)return await (0,v.upsertServiceHeartbeat)(n,{service:"sweep-deposits:bsc",status:"ok",details:{event:"skipped_cadence",cadence_ms:g,age_ms:e}}).catch(()=>void 0),f.NextResponse.json({ok:!0,skipped:!0,reason:"cadence",cadence_ms:g,age_ms:e,next_allowed_in_ms:Math.max(0,g-e)})}}catch{}try{let e=await H(n,{execute:i,allowGasTopups:l,tokenSymbols:h});return f.NextResponse.json(e)}catch(t){let e=t instanceof Error?t.message:String(t);return f.NextResponse.json({ok:!1,error:"sweep_failed",message:e,hint:"Check hot wallet key (DEPLOYER_PRIVATE_KEY), master seed (CITADEL_MASTER_SEED), and BSC RPC connectivity (BSC_RPC_URL)."},{status:500})}}async function M(e){return W(e)}e.s(["GET",()=>M,"POST",()=>W,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],257457);var F=e.i(257457);let K=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/exchange/cron/sweep-deposits/route",pathname:"/api/exchange/cron/sweep-deposits",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/exchange/cron/sweep-deposits/route.ts",nextConfigOutput:"",userland:F}),{workAsyncStorage:j,workUnitAsyncStorage:G,serverHooks:q}=K;function X(){return(0,s.patchFetch)({workAsyncStorage:j,workUnitAsyncStorage:G})}async function V(e,t,s){K.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/exchange/cron/sweep-deposits/route";f=f.replace(/\/index$/,"")||"/";let w=await K.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:S,params:N,nextConfig:R,parsedUrl:b,isDraftMode:v,prerenderManifest:C,routerServerContext:T,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,resolvedPathname:y,clientReferenceManifest:P,serverActionsManifest:B}=w,O=(0,i.normalizeAppPath)(f),k=!!(C.dynamicRoutes[O]||C.routes[y]),D=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,b,!1):t.end("This page could not be found"),null);if(k&&!v){let e=!!C.routes[y],t=C.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await D();throw new m.NoFallbackError}}let $=null;!k||K.isDev||v||($="/index"===($=y)?"/":$);let L=!0===K.isDev||!k,I=k&&!L;B&&P&&(0,o.setManifestsSingleton)({page:f,clientReferenceManifest:P,serverActionsManifest:B});let U=e.method||"GET",H=(0,r.getTracer)(),W=H.getActiveScopeSpan(),M={params:N,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,s,n)=>K.onRequestError(e,t,s,n,T)},sharedContext:{buildId:S}},F=new l.NodeNextRequest(e),j=new l.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let o=async e=>K.handle(G,M).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${U} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${f}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var r,l;let c=async({previousCacheEntry:a})=>{try{if(!i&&x&&A&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=M.renderOpts.fetchMetrics;let l=M.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let c=M.renderOpts.collectedTags;if(!k)return await (0,p.sendResponse)(F,j,r,M.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[g.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==M.renderOpts.collectedRevalidate&&!(M.renderOpts.collectedRevalidate>=g.INFINITE_CACHE)&&M.renderOpts.collectedRevalidate,s=void 0===M.renderOpts.collectedExpire||M.renderOpts.collectedExpire>=g.INFINITE_CACHE?void 0:M.renderOpts.collectedExpire;return{value:{kind:_.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==a?void 0:a.isStale)&&await K.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:x})},!1,T),t}},d=await K.handleResponse({req:e,nextConfig:R,cacheKey:$,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:A,responseGenerator:c,waitUntil:s.waitUntil,isMinimalMode:i});if(!k)return null;if((null==d||null==(r=d.value)?void 0:r.kind)!==_.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",x?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),v&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return i&&k||m.delete(g.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,E.getCacheControlHeader)(d.cacheControl)),await (0,p.sendResponse)(F,j,new Response(d.value.body,{headers:m,status:d.value.status||200})),null};W?await l(W):await H.withPropagatedContext(e.headers,()=>H.trace(d.BaseServerSpan.handleRequest,{spanName:`${U} ${f}`,kind:r.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await K.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:x})},!1,T),k)throw t;return await (0,p.sendResponse)(F,j,new Response(null,{status:500})),null}}e.s(["handler",()=>V,"patchFetch",()=>X,"routeModule",()=>K,"serverHooks",()=>q,"workAsyncStorage",()=>j,"workUnitAsyncStorage",()=>G],916959)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_04d0cee4.js.map