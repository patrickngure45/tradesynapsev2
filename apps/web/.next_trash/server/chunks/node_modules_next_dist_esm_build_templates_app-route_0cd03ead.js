module.exports=[434750,e=>{"use strict";var t=e.i(747909),r=e.i(174017),i=e.i(996250),a=e.i(759756),n=e.i(561916),l=e.i(174677),o=e.i(869741),u=e.i(316795),s=e.i(487718),c=e.i(995169),d=e.i(47587),p=e.i(666012),h=e.i(570101),m=e.i(626937),R=e.i(10372),E=e.i(193695);e.i(52474);var N=e.i(600220),f=e.i(89171),g=e.i(29984),A=e.i(843793),b=e.i(930008);async function S(e,t,r="1h",i=24){let a=new b.default[e],n=t.includes("/")?t:t.replace("USDT","/USDT");if("function"!=typeof a.fetchOHLCV)return[];try{return await a.fetchOHLCV(n,r,void 0,i)}catch(e){return console.warn(`Failed to fetch candles for ${t}:`,e),[]}}async function T(e,t="1h",r=48){if("1h"!==t)return[];let i=(0,A.getSql)(),a=e.trim();if(!a)return[];let n=await i`
    SELECT id::text AS id
    FROM ex_market
    WHERE upper(symbol) = upper(${a})
      AND status = 'enabled'
    LIMIT 1
  `,l=n[0]?.id;if(!l)return[];let o=await i`
    WITH buckets AS (
      SELECT
        date_trunc('hour', created_at) AS ts,
        (array_agg(price ORDER BY created_at ASC, id ASC))[1] AS open,
        (array_agg(price ORDER BY created_at DESC, id DESC))[1] AS close,
        MAX(price) AS high,
        MIN(price) AS low,
        SUM(quantity) AS volume
      FROM ex_execution
      WHERE market_id = ${l}::uuid
        AND created_at >= NOW() - (${r}::int || ' hours')::interval
      GROUP BY 1
    )
    SELECT
      ts::text,
      open::text,
      high::text,
      low::text,
      close::text,
      volume::text
    FROM buckets
    ORDER BY ts ASC
  `,u=[];for(let e of o){let t=Date.parse(e.ts),r=e.open?Number(e.open):NaN,i=e.high?Number(e.high):NaN,a=e.low?Number(e.low):NaN,n=e.close?Number(e.close):NaN,l=e.volume?Number(e.volume):0;Number.isFinite(t)&&Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)&&Number.isFinite(n)&&u.push([t,r,i,a,n,Number.isFinite(l)?l:0])}return u}async function w(e){let t=(0,A.getSql)(),r=e.trim();if(!r)return null;let i=await t`
    SELECT id::text AS id
    FROM ex_market
    WHERE upper(symbol) = upper(${r})
      AND status = 'enabled'
    LIMIT 1
  `,a=i[0]?.id;if(!a)return null;let[n]=await t`
    SELECT price::text AS price
    FROM ex_order
    WHERE market_id = ${a}::uuid
      AND side = 'buy'
      AND status IN ('open','partially_filled')
    ORDER BY price DESC, created_at ASC
    LIMIT 1
  `,[l]=await t`
    SELECT price::text AS price
    FROM ex_order
    WHERE market_id = ${a}::uuid
      AND side = 'sell'
      AND status IN ('open','partially_filled')
    ORDER BY price ASC, created_at ASC
    LIMIT 1
  `,o=n?.price?Number(n.price):null,u=l?.price?Number(l.price):null;return{bid:null!=o&&Number.isFinite(o)&&o>0?o:null,ask:null!=u&&Number.isFinite(u)&&u>0?u:null}}async function C(e){let t=(0,A.getSql)(),r=e.trim();if(!r)return 0;let i=await t`
    SELECT id::text AS id
    FROM ex_market
    WHERE upper(symbol) = upper(${r})
      AND status = 'enabled'
    LIMIT 1
  `,a=i[0]?.id;if(!a)return 0;let n=await t`
    SELECT COALESCE(SUM(quantity), 0)::text AS volume
    FROM ex_execution
    WHERE market_id = ${a}::uuid
      AND created_at >= NOW() - INTERVAL '24 hours'
  `,l=n[0]?.volume?Number(n[0].volume):0;return Number.isFinite(l)?l:0}function _(e,t){if(!e||!t)return 0;let r=(e+t)/2;return!Number.isFinite(r)||r<=0?0:(t-e)/r*1e4}async function x(e,t){let r=(e??"").trim().toLowerCase(),i="internal"===r?await T(t,"1h",48):await S(r,t,"1h",48),a=0;if("internal"!==r){let e=(await (0,g.getExchangeFundingRates)(r).catch(()=>[])).find(e=>e.symbol===t||String(e.symbol??"").replace("/","")===t.replace("/",""));a=e?.fundingRate??0}let n=i.length?i[i.length-1][4]:0,l=50,o=0;if(i.length>20){let e=i.map(e=>e[4]);l=Math.min(100,Math.max(0,100*function(e){if(e.length<2)return 0;let t=e.reduce((e,t)=>e+t,0)/e.length;return Math.sqrt(e.reduce((e,r)=>e+Math.pow(r-t,2),0)/e.length)}(e.map((t,r)=>0===r?0:(t-e[r-1])/e[r-1]).slice(1))*20));let t=e.slice(-24).reduce((e,t)=>e+t,0)/24;o=Math.min(100,Math.max(-100,(n-t)/t*1e3))}let u="RANGING_QUIET";l>75&&(u="RANGING_VOLATILE"),o>20&&(u="TRENDING_UP"),o<-20&&(u="TRENDING_DOWN"),l>90&&o<-30&&(u="CRASH_RISK");let s="STAY_FLAT",c="Data insufficient";return"RANGING_QUIET"===u?(s="GRID_NEUTRAL",c="Low volatility suitable for mean reversion grid."):"RANGING_VOLATILE"===u?(s="STAY_FLAT",c="Volatility too high for safe grid trading."):"TRENDING_UP"===u?a>.001?(s="CASH_CARRY",c=`Strong uptrend but funding is expensive (${(100*a).toFixed(3)}%). Arbitrage opportunity.`):(s="TREND_FOLLOW",c="Uptrend established. Buy spot or long perps."):"TRENDING_DOWN"===u?(s="TREND_FOLLOW",c="Downtrend active. Sell spot or short perps."):"CRASH_RISK"===u&&(s="STAY_FLAT",c="Extreme downside volatility detected. Halt trading."),a>5e-4&&"CRASH_RISK"!==u&&"RANGING_QUIET"===u&&(s="CASH_CARRY",c="High funding rate in sideways market. Risk-free yield preferred."),{symbol:t,regime:u,recommendation:s,metrics:{fundingRate:a,volatilityScore:l,spreadBps:await (async()=>{if("internal"===r){let e=await w(t).catch(()=>null);return _(e?.bid??null,e?.ask??null)}try{let e=(0,g.createCcxtPublic)(r),i=t.includes("/")?t:t.replace("USDT","/USDT"),a=await e.fetchTicker(i),n="number"==typeof a?.bid?a.bid:Number(a?.bid),l="number"==typeof a?.ask?a.ask:Number(a?.ask);return _(Number.isFinite(n)?n:null,Number.isFinite(l)?l:null)}catch{return 0}})(),volume24h:await (async()=>{if("internal"===r)return await C(t).catch(()=>0);try{let e=(0,g.createCcxtPublic)(r),i=t.includes("/")?t:t.replace("USDT","/USDT"),a=await e.fetchTicker(i),n="number"==typeof a?.quoteVolume?a.quoteVolume:Number(a?.quoteVolume),l="number"==typeof a?.baseVolume?a.baseVolume:Number(a?.baseVolume),o=Number.isFinite(n)&&n>0?n:Number.isFinite(l)&&l>0?l:0;return Number.isFinite(o)?o:0}catch{return 0}})()},reason:c}}async function y(e){let t=new URL(e.url),r=t.searchParams.get("symbol")??"BTC/USDT",i=t.searchParams.get("exchange")??"binance";try{let e=await x(i,r);return f.NextResponse.json(e)}catch(e){return console.error("[regime] Error:",e),f.NextResponse.json({error:"internal_error"},{status:500})}}e.s(["GET",()=>y,"runtime",0,"nodejs"],16395);var v=e.i(16395);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/intelligence/regime/route",pathname:"/api/intelligence/regime",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/intelligence/regime/route.ts",nextConfigOutput:"",userland:v}),{workAsyncStorage:I,workUnitAsyncStorage:O,serverHooks:F}=D;function L(){return(0,i.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:O})}async function M(e,t,i){D.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/intelligence/regime/route";f=f.replace(/\/index$/,"")||"/";let g=await D.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!g)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:A,params:b,nextConfig:S,parsedUrl:T,isDraftMode:w,prerenderManifest:C,routerServerContext:_,isOnDemandRevalidate:x,revalidateOnlyGenerated:y,resolvedPathname:v,clientReferenceManifest:I,serverActionsManifest:O}=g,F=(0,o.normalizeAppPath)(f),L=!!(C.dynamicRoutes[F]||C.routes[v]),M=async()=>((null==_?void 0:_.render404)?await _.render404(e,t,T,!1):t.end("This page could not be found"),null);if(L&&!w){let e=!!C.routes[v],t=C.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(S.experimental.adapterPath)return await M();throw new E.NoFallbackError}}let H=null;!L||D.isDev||w||(H="/index"===(H=v)?"/":H);let U=!0===D.isDev||!L,k=L&&!U;O&&I&&(0,l.setManifestsSingleton)({page:f,clientReferenceManifest:I,serverActionsManifest:O});let P=e.method||"GET",q=(0,n.getTracer)(),G=q.getActiveScopeSpan(),$={params:b,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!S.experimental.authInterrupts},cacheComponents:!!S.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:S.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i,a)=>D.onRequestError(e,t,i,a,_)},sharedContext:{buildId:A}},W=new u.NodeNextRequest(e),V=new u.NodeNextResponse(t),B=s.NextRequestAdapter.fromNodeNextRequest(W,(0,s.signalFromNodeResponse)(t));try{let l=async e=>D.handle(B,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=q.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${P} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${P} ${f}`)}),o=!!(0,a.getRequestMeta)(e,"minimalMode"),u=async a=>{var n,u;let s=async({previousCacheEntry:r})=>{try{if(!o&&x&&y&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await l(a);e.fetchMetrics=$.renderOpts.fetchMetrics;let u=$.renderOpts.pendingWaitUntil;u&&i.waitUntil&&(i.waitUntil(u),u=void 0);let s=$.renderOpts.collectedTags;if(!L)return await (0,p.sendResponse)(W,V,n,$.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);s&&(t[R.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,i=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:N.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:x})},!1,_),t}},c=await D.handleResponse({req:e,nextConfig:S,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:y,responseGenerator:s,waitUntil:i.waitUntil,isMinimalMode:o});if(!L)return null;if((null==c||null==(n=c.value)?void 0:n.kind)!==N.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(u=c.value)?void 0:u.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",x?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let E=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return o&&L||E.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||E.get("Cache-Control")||E.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)(W,V,new Response(c.value.body,{headers:E,status:c.value.status||200})),null};G?await u(G):await q.withPropagatedContext(e.headers,()=>q.trace(c.BaseServerSpan.handleRequest,{spanName:`${P} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":P,"http.target":e.url}},u))}catch(t){if(t instanceof E.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:x})},!1,_),L)throw t;return await (0,p.sendResponse)(W,V,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>L,"routeModule",()=>D,"serverHooks",()=>F,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>O],434750)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_0cd03ead.js.map