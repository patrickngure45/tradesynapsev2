module.exports=[145969,e=>{"use strict";var t=e.i(747909),a=e.i(174017),r=e.i(996250),i=e.i(759756),n=e.i(561916),o=e.i(174677),l=e.i(869741),d=e.i(316795),s=e.i(487718),u=e.i(995169),c=e.i(47587),_=e.i(666012),p=e.i(570101),m=e.i(626937),h=e.i(10372),y=e.i(193695);e.i(52474);var E=e.i(600220),g=e.i(469719),v=e.i(300959),w=e.i(843793),f=e.i(184883),R=e.i(977775),b=e.i(720290);let C={low:[{weight:860,value:{kind:"badge",code:"cal_spark",rarity:"common",label:"Calendar Spark"}},{weight:115,value:{kind:"badge",code:"cal_glint",rarity:"rare",label:"Calendar Glint"}},{weight:22,value:{kind:"badge",code:"cal_aura",rarity:"epic",label:"Calendar Aura"}},{weight:3,value:{kind:"badge",code:"cal_crown",rarity:"legendary",label:"Calendar Crown"}}],medium:[{weight:780,value:{kind:"badge",code:"cal_spark",rarity:"common",label:"Calendar Spark"}},{weight:160,value:{kind:"badge",code:"cal_glint",rarity:"rare",label:"Calendar Glint"}},{weight:48,value:{kind:"badge",code:"cal_aura",rarity:"epic",label:"Calendar Aura"}},{weight:12,value:{kind:"badge",code:"cal_crown",rarity:"legendary",label:"Calendar Crown"}}],high:[{weight:670,value:{kind:"badge",code:"cal_spark",rarity:"common",label:"Calendar Spark"}},{weight:220,value:{kind:"badge",code:"cal_glint",rarity:"rare",label:"Calendar Glint"}},{weight:85,value:{kind:"badge",code:"cal_aura",rarity:"epic",label:"Calendar Aura"}},{weight:25,value:{kind:"badge",code:"cal_crown",rarity:"legendary",label:"Calendar Crown"}}]};var k=e.i(60828),T=e.i(273278);let A=g.z.object({action_id:g.z.string().uuid(),client_seed:g.z.string().min(8).max(256)});function S(e){return new Date(Date.UTC(e.getUTCFullYear(),e.getUTCMonth(),e.getUTCDate())).toISOString().slice(0,10)}function x(e){let t=Number(e.slice(0,4)),a=Number(e.slice(5,7)),r=Number(e.slice(8,10));return Number.isFinite(t)&&Number.isFinite(a)&&Number.isFinite(r)?Math.floor(Date.UTC(t,a-1,r)/864e5):0}async function N(e){let t,a=(0,R.getActingUserId)(e),r=(0,R.requireActingUserIdInProd)(a);if(r)return(0,v.apiError)(r);if(!a)return(0,v.apiError)("missing_x_user_id");let i=await e.json().catch(()=>({}));try{t=A.parse(i)}catch(e){return(0,v.apiZodError)(e)??(0,v.apiError)("invalid_input")}let n=String(t.action_id).trim(),o=String(t.client_seed).trim(),l=(0,w.getSql)(),d="calendar_daily";try{let e=await (0,f.retryOnceOnTransientDbError)(async()=>await l.begin(async e=>{let t=await e`
          SELECT id::text AS id, user_id::text AS user_id, module, profile, status,
                 client_commit_hash, server_commit_hash, server_seed_b64, requested_at, outcome_json, input_json
          FROM arcade_action
          WHERE id = ${n}::uuid
          LIMIT 1
          FOR UPDATE
        `;if(0===t.length)return{kind:"err",err:(0,v.apiError)("not_found")};let r=t[0];if(r.user_id!==a)return{kind:"err",err:(0,v.apiError)("x_user_id_mismatch")};if(r.module!==d)return{kind:"err",err:(0,v.apiError)("invalid_input")};if("resolved"===r.status)return{kind:"ok",already:!0,outcome:r.outcome_json};if("committed"!==r.status)return{kind:"err",err:(0,v.apiError)("trade_state_conflict",{details:{status:r.status}})};let i=(0,b.sha256Hex)(o);if(!(0,b.isSha256Hex)(i)||i!==String(r.client_commit_hash??"").toLowerCase())return{kind:"err",err:(0,v.apiError)("invalid_input",{details:"client_seed does not match commit"})};if((0,b.sha256Hex)(`${r.server_seed_b64}:${r.client_commit_hash}:${r.module}:${r.profile}:${a}`)!==String(r.server_commit_hash??"").toLowerCase())return{kind:"err",err:(0,v.apiError)("internal_error",{details:"server_commit_mismatch"})};let l=String(r.input_json?.claim_date??"").trim()||S(new Date),[s]=await e`
          SELECT streak_count, best_streak, last_claim_date::text AS last_claim_date, pity_rare
          FROM arcade_calendar_state
          WHERE user_id = ${a}::uuid AND module = ${d}
          LIMIT 1
          FOR UPDATE
        `,u=Number(s?.pity_rare??0),c=function(e){let t=function(e,t){let a=C[e].map(e=>({...e,value:{...e.value}})),r=Math.max(0,Math.min(30,Math.floor(t)));if(0===r)return a;let i=a.find(e=>"common"===e.value.rarity),n=a.find(e=>"rare"===e.value.rarity),o=a.find(e=>"epic"===e.value.rarity);if(!i||!n)return a;let l=Math.min(i.weight-1,r);return i.weight-=l,n.weight+=Math.floor(.85*l),o&&(o.weight+=l-Math.floor(.85*l)),a}(e.profile,e.pityRare),a=(0,b.sha256Hex)(`${e.serverSeedB64}:${e.clientSeed}:${e.actionId}:${e.userId}:${e.module}:${e.profile}:${e.clientCommitHash}:${e.claimDateIso}:pity=${e.pityRare}`),{picked:r,roll:i,total:n}=function(e,t){let a=t.reduce((e,t)=>e+t.weight,0),r=Number(e%BigInt(a)),i=0;for(let e of t)if(r<(i+=e.weight))return{picked:e.value,roll:r,total:a};return{picked:t[t.length-1].value,roll:r,total:a}}((0,b.bytesToU64BigInt)(Buffer.from(a.slice(0,16),"hex")),t);return{outcome:r,audit:{random_hash:a,roll:i,total:n,pity_rare:e.pityRare}}}({actionId:r.id,userId:a,module:d,profile:r.profile,serverSeedB64:r.server_seed_b64,clientSeed:o,clientCommitHash:r.client_commit_hash,claimDateIso:l,pityRare:u}),_={module:d,profile:r.profile,claim_date:l,outcome:c.outcome,audit:{client_commit_hash:r.client_commit_hash,server_commit_hash:r.server_commit_hash,server_seed_b64:r.server_seed_b64,random_hash:c.audit.random_hash,roll:c.audit.roll,total:c.audit.total,pity_rare:c.audit.pity_rare}};await e`
          INSERT INTO arcade_inventory (user_id, kind, code, rarity, quantity, metadata_json, created_at, updated_at)
          VALUES (
            ${a}::uuid,
            ${c.outcome.kind},
            ${c.outcome.code},
            ${c.outcome.rarity},
            1,
            ${e.json({label:c.outcome.label,source:d,claim_date:l})},
            now(),
            now()
          )
          ON CONFLICT (user_id, kind, code, rarity)
          DO UPDATE SET quantity = arcade_inventory.quantity + 1, updated_at = now()
        `;let p=S(new Date(Date.now()-864e5)),m=s?.last_claim_date,h=!1,y=1;if(m===p)y=Number(s?.streak_count??0)+1;else if(m){let t=x(l)-x(m);if(2===t){let t=await e`
              SELECT id::text AS id, quantity
              FROM arcade_inventory
              WHERE user_id = ${a}::uuid
                AND kind = 'perk'
                AND code = 'streak_protector'
                AND rarity = 'rare'
              LIMIT 1
              FOR UPDATE
            `,i=Number(t[0]?.quantity??0);i>0&&(h=!0,y=Number(s?.streak_count??0)+1,1===i?await e`
                  DELETE FROM arcade_inventory
                  WHERE id = ${t[0].id}::uuid
                `:await e`
                  UPDATE arcade_inventory
                  SET quantity = ${i-1}, updated_at = now()
                  WHERE id = ${t[0].id}::uuid
                `,await (0,k.logArcadeConsumption)(e,{user_id:a,kind:"perk",code:"streak_protector",rarity:"rare",quantity:1,context_type:"calendar_daily",context_id:r.id,module:"streak_protector",metadata:{claim_date:l,last_claim_date:m}}))}}h||m===p||(y=1);let E=Math.max(Number(s?.best_streak??0),y),g="rare"===c.outcome.rarity||"epic"===c.outcome.rarity||"legendary"===c.outcome.rarity?0:Math.min(50,u+1);return await e`
          INSERT INTO arcade_calendar_state (user_id, module, streak_count, best_streak, last_claim_date, pity_rare, updated_at)
          VALUES (${a}::uuid, ${d}, ${y}, ${E}, ${l}::date, ${g}, now())
          ON CONFLICT (user_id, module)
          DO UPDATE SET
            streak_count = EXCLUDED.streak_count,
            best_streak = EXCLUDED.best_streak,
            last_claim_date = EXCLUDED.last_claim_date,
            pity_rare = EXCLUDED.pity_rare,
            updated_at = now()
        `,await (0,T.addArcadeXp)(e,{userId:a,deltaXp:1,contextRandomHash:c.audit.random_hash,source:"calendar_daily"}),await e`
          UPDATE arcade_action
          SET status = 'resolved',
              resolved_at = now(),
              reveal_json = ${e.json({client_seed_present:!0})},
              outcome_json = ${e.json(_)}
          WHERE id = ${n}::uuid
        `,{kind:"ok",already:!1,outcome:_}}));if("err"===e.kind)return e.err;return Response.json({ok:!0,action_id:n,already_resolved:e.already,result:e.outcome},{status:200})}catch(t){let e=(0,f.responseForDbError)("arcade_calendar_reveal",t);if(e)return e;return(0,v.apiError)("internal_error")}}e.s(["POST",()=>N,"dynamic",0,"force-dynamic","runtime",0,"nodejs"],385593);var D=e.i(385593);let $=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/arcade/calendar/daily/reveal/route",pathname:"/api/arcade/calendar/daily/reveal",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/arcade/calendar/daily/reveal/route.ts",nextConfigOutput:"",userland:D}),{workAsyncStorage:O,workUnitAsyncStorage:I,serverHooks:U}=$;function P(){return(0,r.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:I})}async function H(e,t,r){$.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let g="/api/arcade/calendar/daily/reveal/route";g=g.replace(/\/index$/,"")||"/";let v=await $.prepare(e,t,{srcPage:g,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:f,nextConfig:R,parsedUrl:b,isDraftMode:C,prerenderManifest:k,routerServerContext:T,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,resolvedPathname:x,clientReferenceManifest:N,serverActionsManifest:D}=v,O=(0,l.normalizeAppPath)(g),I=!!(k.dynamicRoutes[O]||k.routes[x]),U=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,b,!1):t.end("This page could not be found"),null);if(I&&!C){let e=!!k.routes[x],t=k.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await U();throw new y.NoFallbackError}}let P=null;!I||$.isDev||C||(P="/index"===(P=x)?"/":P);let H=!0===$.isDev||!I,M=I&&!H;D&&N&&(0,o.setManifestsSingleton)({page:g,clientReferenceManifest:N,serverActionsManifest:D});let q=e.method||"GET",F=(0,n.getTracer)(),L=F.getActiveScopeSpan(),j={params:f,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:H,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,i)=>$.onRequestError(e,t,r,i,T)},sharedContext:{buildId:w}},B=new d.NodeNextRequest(e),X=new d.NodeNextResponse(t),K=s.NextRequestAdapter.fromNodeNextRequest(B,(0,s.signalFromNodeResponse)(t));try{let o=async e=>$.handle(K,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=F.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=a.get("next.route");if(r){let t=`${q} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${g}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let s=async({previousCacheEntry:a})=>{try{if(!l&&A&&S&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let d=j.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let s=j.renderOpts.collectedTags;if(!I)return await (0,_.sendResponse)(B,X,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,p.toNodeOutgoingHttpHeaders)(n.headers);s&&(t[h.NEXT_CACHE_TAGS_HEADER]=s),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,r=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:r}}}}catch(t){throw(null==a?void 0:a.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:g,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},!1,T),t}},u=await $.handleResponse({req:e,nextConfig:R,cacheKey:P,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:A,revalidateOnlyGenerated:S,responseGenerator:s,waitUntil:r.waitUntil,isMinimalMode:l});if(!I)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(d=u.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",A?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,p.fromNodeOutgoingHttpHeaders)(u.value.headers);return l&&I||y.delete(h.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,_.sendResponse)(B,X,new Response(u.value.body,{headers:y,status:u.value.status||200})),null};L?await d(L):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${q} ${g}`,kind:n.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},d))}catch(t){if(t instanceof y.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:M,isOnDemandRevalidate:A})},!1,T),I)throw t;return await (0,_.sendResponse)(B,X,new Response(null,{status:500})),null}}e.s(["handler",()=>H,"patchFetch",()=>P,"routeModule",()=>$,"serverHooks",()=>U,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>I],145969)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_af72d62c.js.map